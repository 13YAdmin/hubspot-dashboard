<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<title>HubSpot CRM - Dashboard Account Manager</title>

<style>
:root {
  --bg: #0a0e27;
  --bg-card: #151932;
  --bg-card-hover: #1d2342;
  --text: #f1f5f9;
  --text-muted: #94a3b8;
  --accent: #6366f1;
  --accent-light: #818cf8;
  --green: #22c55e;
  --green-light: #4ade80;
  --red: #ef4444;
  --red-light: #f87171;
  --orange: #f59e0b;
  --yellow: #eab308;
  --blue: #3b82f6;
  --purple: #a855f7;
  --border: #1e293b;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: linear-gradient(135deg, var(--bg) 0%, #0f1629 100%);
  color: var(--text);
  padding: 20px;
  min-height: 100vh;
}

.container {
  max-width: 1800px;
  margin: 0 auto;
}

/* Header */
.header {
  background: linear-gradient(135deg, var(--accent) 0%, var(--purple) 100%);
  border-radius: 16px;
  padding: 28px;
  margin-bottom: 20px;
  box-shadow: 0 20px 60px rgba(99, 102, 241, 0.4);
}

.header h1 {
  font-size: 28px;
  font-weight: 800;
  margin-bottom: 6px;
  color: white;
  text-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

.header p {
  color: rgba(255,255,255,0.95);
  font-size: 15px;
}

.upload-section {
  background: var(--bg-card);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  border: 2px dashed var(--border);
  transition: all 0.3s ease;
  text-align: center;
}

.upload-section:hover {
  border-color: var(--accent);
  background: var(--bg-card-hover);
}

.upload-section h3 {
  margin-bottom: 12px;
  color: var(--text);
  font-size: 16px;
}

.upload-section input[type="file"] {
  padding: 10px 20px;
  background: var(--accent);
  border: none;
  border-radius: 8px;
  color: white;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
}

.upload-section input[type="file"]:hover {
  background: var(--accent-light);
  transform: scale(1.05);
}


/* KPI Grid */
.kpi-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 14px;
  margin-bottom: 20px;
}

.kpi-card {
  background: var(--bg-card);
  border-radius: 12px;
  padding: 18px;
  border: 1px solid var(--border);
  position: relative;
  overflow: hidden;
  transition: all 0.3s ease;
  cursor: pointer;
}

.kpi-card:hover {
  transform: translateY(-5px) scale(1.02);
  box-shadow: 0 15px 40px rgba(99, 102, 241, 0.3);
  border-color: var(--accent);
}

.kpi-card:active {
  transform: translateY(-2px) scale(0.98);
}

.kpi-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--accent), var(--purple));
}

.kpi-label {
  font-size: 12px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 6px;
}

.kpi-value {
  font-size: 28px;
  font-weight: 800;
  color: var(--text);
  margin-bottom: 4px;
}

.kpi-change {
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 4px;
}

.kpi-change.positive { color: var(--green); }
.kpi-change.negative { color: var(--red); }

/* Chart Section */
.chart-section {
  background: var(--bg-card);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  border: 1px solid var(--border);
  transition: all 0.3s ease;
}

.chart-section:hover {
  border-color: var(--accent);
  box-shadow: 0 8px 24px rgba(99, 102, 241, 0.15);
}

.chart-section h3 {
  font-size: 17px;
  margin-bottom: 14px;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 8px;
}

.chart-section h3::before {
  content: '';
  width: 4px;
  height: 18px;
  background: var(--accent);
  border-radius: 2px;
}

.charts-row {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
  margin-bottom: 20px;
}

.chart-container {
  width: 100%;
  height: 300px;
  position: relative;
}

svg {
  width: 100%;
  height: 100%;
}

.bar, .line-point {
  transition: all 0.3s ease;
  cursor: pointer;
}

.bar:hover, .line-point:hover {
  opacity: 0.85;
  filter: brightness(1.15);
}

.bar.selected {
  filter: brightness(1.3);
  stroke: #fff;
  stroke-width: 2;
}

/* Table */
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

thead {
  background: var(--bg);
  position: sticky;
  top: 0;
  z-index: 10;
}

th {
  padding: 10px;
  text-align: left;
  font-weight: 600;
  color: var(--accent);
  border-bottom: 2px solid var(--border);
  cursor: pointer;
  user-select: none;
  font-size: 12px;
}

th:hover {
  background: var(--bg-card-hover);
}

td {
  padding: 10px;
  border-bottom: 1px solid var(--border);
  color: var(--text);
}

tbody tr {
  transition: all 0.2s ease;
  cursor: pointer;
}

tbody tr:hover {
  background: var(--bg-card-hover);
  transform: scale(1.01);
  box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
}

tbody tr:active {
  background: rgba(99, 102, 241, 0.15);
  transform: scale(0.99);
}

.badge {
  display: inline-block;
  padding: 3px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
  transition: all 0.2s ease;
  cursor: help;
}

.badge:hover {
  transform: scale(1.15);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

.badge.stratégique { background: rgba(168, 85, 247, 0.2); color: var(--purple); }
.badge.stratégique:hover { background: rgba(168, 85, 247, 0.4); }

.badge.clé { background: rgba(34, 197, 94, 0.2); color: var(--green); }
.badge.clé:hover { background: rgba(34, 197, 94, 0.4); }

.badge.régulier { background: rgba(59, 130, 246, 0.2); color: var(--blue); }
.badge.régulier:hover { background: rgba(59, 130, 246, 0.4); }

.badge.à-risque { background: rgba(245, 158, 11, 0.2); color: var(--orange); }
.badge.à-risque:hover { background: rgba(245, 158, 11, 0.4); }

.badge.dormant { background: rgba(239, 68, 68, 0.2); color: var(--red); }
.badge.dormant:hover { background: rgba(239, 68, 68, 0.4); }

.priority-high { color: var(--red); font-weight: 700; }
.priority-medium { color: var(--orange); font-weight: 600; }
.priority-low { color: var(--text-muted); }

/* Loading */
.loading {
  text-align: center;
  padding: 40px;
  color: var(--text-muted);
}

.spinner {
  border: 3px solid var(--border);
  border-top: 3px solid var(--accent);
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: 0 auto 12px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.legend {
  display: flex;
  gap: 14px;
  flex-wrap: wrap;
  margin-top: 14px;
  font-size: 12px;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 6px;
}

.legend-color {
  width: 14px;
  height: 14px;
  border-radius: 3px;
}

/* Action Cards */
.action-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 14px;
}

.action-card {
  background: var(--bg-card);
  border-radius: 10px;
  padding: 16px;
  border-left: 4px solid var(--accent);
  transition: all 0.3s ease;
  cursor: pointer;
}

.action-card:hover {
  transform: translateX(5px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
  background: var(--bg-card-hover);
}

.action-card.high { border-left-color: var(--red); }
.action-card.medium { border-left-color: var(--orange); }
.action-card.low { border-left-color: var(--blue); }

.action-card.high:hover { box-shadow: -4px 0 0 var(--red), 0 8px 20px rgba(239, 68, 68, 0.3); }
.action-card.medium:hover { box-shadow: -4px 0 0 var(--orange), 0 8px 20px rgba(245, 158, 11, 0.3); }
.action-card.low:hover { box-shadow: -4px 0 0 var(--blue), 0 8px 20px rgba(59, 130, 246, 0.3); }

.action-card h4 {
  font-size: 14px;
  margin-bottom: 6px;
  color: var(--text);
}

.action-card p {
  color: var(--text-muted);
  font-size: 13px;
  line-height: 1.5;
  margin-bottom: 8px;
}

.action-card .action-tag {
  display: inline-block;
  padding: 3px 8px;
  background: rgba(99, 102, 241, 0.2);
  color: var(--accent);
  border-radius: 6px;
  font-size: 11px;
  font-weight: 600;
}

.hidden { display: none !important; }

/* Info Panel */
.info-panel {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.9);
  background: var(--bg-card);
  border: 2px solid var(--accent);
  border-radius: 16px;
  padding: 24px;
  max-width: 500px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  z-index: 1000;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
  opacity: 0;
  pointer-events: none;
  transition: all 0.3s ease;
}

.info-panel.show {
  opacity: 1;
  pointer-events: all;
  transform: translate(-50%, -50%) scale(1);
}

.info-panel-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  z-index: 999;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
  backdrop-filter: blur(4px);
}

.info-panel-overlay.show {
  opacity: 1;
  pointer-events: all;
}

.info-panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 2px solid var(--border);
}

.info-panel-header h3 {
  color: var(--accent);
  font-size: 20px;
  font-weight: 700;
}

.info-panel-close {
  background: var(--red);
  border: none;
  color: white;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 20px;
  font-weight: bold;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.info-panel-close:hover {
  transform: scale(1.1) rotate(90deg);
  background: var(--red-light);
}

.info-panel-content {
  color: var(--text);
}

.info-row {
  display: flex;
  justify-content: space-between;
  padding: 12px 0;
  border-bottom: 1px solid var(--border);
}

.info-row:last-child {
  border-bottom: none;
}

.info-label {
  color: var(--text-muted);
  font-weight: 600;
  font-size: 13px;
}

.info-value {
  color: var(--text);
  font-weight: 700;
  font-size: 14px;
}

.info-highlight {
  background: rgba(99, 102, 241, 0.1);
  padding: 16px;
  border-radius: 10px;
  margin: 16px 0;
  border-left: 4px solid var(--accent);
}

details {
  transition: all 0.3s ease;
}

details:hover {
  background: rgba(255, 255, 255, 0.05) !important;
}

summary {
  transition: all 0.2s ease;
}

summary:hover {
  color: var(--accent) !important;
}

summary::marker {
  color: var(--accent);
}

details[open] summary {
  color: var(--accent) !important;
  margin-bottom: 12px;
}

/* Filters */
.filters-container {
  background: var(--bg);
  padding: 16px;
  border-radius: 10px;
  margin-bottom: 16px;
  border: 1px solid var(--border);
}

.filter-group {
  margin-bottom: 14px;
}

.filter-group:last-child {
  margin-bottom: 0;
}

.filter-group label {
  display: block;
  font-size: 12px;
  font-weight: 600;
  color: var(--text-muted);
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.filters {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.filter-btn {
  padding: 8px 16px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text);
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 13px;
  font-weight: 500;
  position: relative;
  overflow: hidden;
}

.filter-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.3), transparent);
  transition: left 0.5s ease;
}

.filter-btn:hover::before {
  left: 100%;
}

.filter-btn:hover {
  background: var(--bg-card-hover);
  border-color: var(--accent);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
}

.filter-btn.active {
  background: linear-gradient(135deg, var(--accent) 0%, var(--purple) 100%);
  border-color: var(--accent);
  color: white;
  font-weight: 600;
  box-shadow: 0 4px 16px rgba(99, 102, 241, 0.4);
}

.filter-btn.active:hover {
  transform: translateY(-2px) scale(1.05);
}

/* Animations */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.kpi-card, .chart-section, .action-card {
  animation: fadeInUp 0.5s ease-out;
}

.kpi-card:nth-child(1) { animation-delay: 0.1s; }
.kpi-card:nth-child(2) { animation-delay: 0.15s; }
.kpi-card:nth-child(3) { animation-delay: 0.2s; }
.kpi-card:nth-child(4) { animation-delay: 0.25s; }
.kpi-card:nth-child(5) { animation-delay: 0.3s; }
.kpi-card:nth-child(6) { animation-delay: 0.35s; }

/* Responsive */
@media (max-width: 1200px) {
  .charts-row {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 640px) {
  .kpi-grid {
    grid-template-columns: 1fr;
  }
}
</style>
</head>

<body>
<div class="container">

  <!-- Header -->
  <div class="header">
    <h1>Dashboard Account Manager - HubSpot CRM</h1>
    <p>Analyses stratégiques et recommandations pour la gestion de portefeuille clients</p>
  </div>

  <!-- Load from HubSpot -->
  <div class="upload-section">
    <h3>🔄 Dashboard Account Manager</h3>
    <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 8px;">
      📊 Données mises à jour automatiquement toutes les 6 heures depuis HubSpot
    </p>
    <p style="color: var(--green); font-size: 12px; margin-bottom: 16px;">
      ✅ Enrichies avec notes, relations clients, et scoring Account Management
    </p>
    <button id="loadHubSpotBtn" style="padding: 12px 32px; background: linear-gradient(135deg, var(--accent) 0%, var(--purple) 100%); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 4px 16px rgba(99, 102, 241, 0.4);">
      🚀 Charger le Dashboard
    </button>
    <div id="loadStatus" style="margin-top: 12px; font-size: 13px; color: var(--text-muted);"></div>
  </div>


  <!-- Loading -->
  <div id="loadingState" class="loading hidden">
    <div class="spinner"></div>
    <p>Analyse stratégique en cours...</p>
  </div>

  <!-- Dashboard -->
  <div id="dashboardContent" class="hidden">

    <!-- KPIs -->
    <div class="kpi-grid" id="kpiGrid"></div>

    <!-- Charts Row 1 -->
    <div class="chart-section">
      <h3>Évolution du CA Global par Année</h3>
      <div class="chart-container">
        <svg id="chartRevenueGlobal"></svg>
      </div>
    </div>

    <!-- Evolution CA par Client -->
    <div class="chart-section">
      <h3>Évolution du CA - Top 10 Clients</h3>
      <div class="chart-container" style="height: 400px;">
        <svg id="chartClientEvolution"></svg>
      </div>
      <div class="legend" id="legendClientEvolution"></div>
    </div>

    <!-- Segmentation Clients -->
    <div class="chart-section">
      <h3>Segmentation & Scoring Clients</h3>

      <!-- Filtres -->
      <div class="filters-container">
        <div class="filter-group">
          <label>Filtrer par Année:</label>
          <div class="filters">
            <button class="filter-btn active" data-filter-type="year" data-filter="all">Toutes</button>
            <button class="filter-btn" data-filter-type="year" data-filter="2022">2022</button>
            <button class="filter-btn" data-filter-type="year" data-filter="2023">2023</button>
            <button class="filter-btn" data-filter-type="year" data-filter="2024">2024</button>
            <button class="filter-btn" data-filter-type="year" data-filter="2025">2025</button>
          </div>
        </div>
      </div>

      <div style="overflow-x: auto; margin-top: 20px;">
        <table id="segmentationTable">
          <thead>
            <tr>
              <th data-sort="rank">Rang</th>
              <th data-sort="name">Client</th>
              <th data-sort="segment">Segment</th>
              <th data-sort="total">CA Total</th>
              <th data-sort="2022">2022</th>
              <th data-sort="2023">2023</th>
              <th data-sort="2024">2024</th>
              <th data-sort="2025">2025</th>
              <th data-sort="trend">Tendance</th>
              <th data-sort="score">Score</th>
              <th>Action Recommandée</th>
            </tr>
          </thead>
          <tbody id="segmentationBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Strategic Recommendations -->
    <div class="chart-section">
      <h3>Recommandations Stratégiques Account Manager</h3>
      <div class="action-grid" id="recommendationsGrid"></div>
    </div>

    <!-- Detailed Analysis -->
    <div class="chart-section">
      <h3>Analyses Complémentaires</h3>
      <div class="action-grid" id="analysisGrid"></div>
    </div>

    <!-- Methodology Section -->
    <div class="chart-section">
      <h3>📚 Méthodologie & Légendes</h3>
      <p style="color: var(--text-muted); margin-bottom: 20px; font-size: 14px;">
        Cliquez sur chaque section pour comprendre comment sont calculées les métriques et ce que signifient les différents segments.
      </p>

      <div class="action-grid">
        <!-- Score Client -->
        <div class="action-card low" onclick="showMethodologyDetails('score')">
          <h4>🎯 Score Client (0-100)</h4>
          <p>Comment le score de chaque client est calculé</p>
          <span class="action-tag">Cliquez pour détails</span>
        </div>

        <!-- Tendance -->
        <div class="action-card low" onclick="showMethodologyDetails('tendance')">
          <h4>📈 Tendance (%)</h4>
          <p>Calcul de l'évolution de l'activité client</p>
          <span class="action-tag">Cliquez pour détails</span>
        </div>

        <!-- Segments -->
        <div class="action-card low" onclick="showMethodologyDetails('segments')">
          <h4>🏷️ Segments Clients</h4>
          <p>Signification des 5 segments (Stratégique, Clé, etc.)</p>
          <span class="action-tag">Cliquez pour détails</span>
        </div>

        <!-- Priorités -->
        <div class="action-card low" onclick="showMethodologyDetails('priorites')">
          <h4>⚡ Niveaux de Priorité</h4>
          <p>Haute, Moyenne, Basse - comment c'est défini</p>
          <span class="action-tag">Cliquez pour détails</span>
        </div>

        <!-- Recommandations -->
        <div class="action-card low" onclick="showMethodologyDetails('recommandations')">
          <h4>💡 Recommandations</h4>
          <p>Actions suggérées selon le profil client</p>
          <span class="action-tag">Cliquez pour détails</span>
        </div>

        <!-- KPIs -->
        <div class="action-card low" onclick="showMethodologyDetails('kpis')">
          <h4>📊 KPIs Principaux</h4>
          <p>Définition des indicateurs clés de performance</p>
          <span class="action-tag">Cliquez pour détails</span>
        </div>
      </div>
    </div>

  </div>

  <!-- Info Panel -->
  <div class="info-panel-overlay" id="infoPanelOverlay" onclick="closeInfoPanel()"></div>
  <div class="info-panel" id="infoPanel">
    <div class="info-panel-header">
      <h3 id="infoPanelTitle">Détails</h3>
      <button class="info-panel-close" onclick="closeInfoPanel()">×</button>
    </div>
    <div class="info-panel-content" id="infoPanelContent">
    </div>
  </div>
</div>

<script>
// ============================================================================
// Global State
// ============================================================================
let dealsData = [];
let processedData = [];
let currentFilters = {
  year: 'all'
};
let sortColumn = 'rank';
let sortDirection = 'asc';

// ============================================================================
// Load data from data.json (auto-updated by GitHub Actions)
// ============================================================================
async function loadHubSpotData() {
  const btn = document.getElementById('loadHubSpotBtn');
  const statusEl = document.getElementById('loadStatus');

  // Disable button and show loading
  btn.disabled = true;
  btn.textContent = '⏳ Chargement...';
  statusEl.textContent = '🔄 Chargement des données HubSpot...';
  statusEl.style.color = '#00D4FF';

  try {
    // Charger data.json (généré par GitHub Actions)
    const response = await fetch('data.json?t=' + Date.now()); // Cache busting

    if (!response.ok) {
      throw new Error(`Impossible de charger les données (${response.status})`);
    }

    const result = await response.json();

    if (result.success && result.data) {
      // Clear cache to avoid data mixing
      dealsData = result.data;
      processedData = [];
      currentFilters = {
        year: 'all'
      };
      sortColumn = 'rank';
      sortDirection = 'asc';

      document.getElementById('loadingState').classList.remove('hidden');
      document.getElementById('dashboardContent').classList.add('hidden');

      // Afficher IMMÉDIATEMENT sans timeout
      console.log('📊 Données chargées:', result.data.length, 'deals');

      try {
        processData();
        console.log('✅ Données traitées:', processedData.length, 'clients');

        renderDashboard();
        console.log('✅ Dashboard rendu');

        document.getElementById('loadingState').classList.add('hidden');
        document.getElementById('dashboardContent').classList.remove('hidden');

        // Afficher les infos de mise à jour
        const updateTime = new Date(result.timestamp).toLocaleString('fr-FR');
        const avgScore = result.metadata?.avg_relationship_score || 0;
        const notesCount = result.metadata?.notes_total || 0;

        statusEl.innerHTML = `✅ ${result.count} deals chargés !<br>
          <small style="color: var(--text-muted);">
            📊 Score relation moyen: ${avgScore}/100 |
            📝 ${notesCount} notes |
            🕐 Mis à jour: ${updateTime}
          </small>`;
        statusEl.style.color = '#4CAF50';
      } catch (error) {
        console.error('❌ ERREUR lors du traitement:', error);
        statusEl.innerHTML = `❌ Erreur lors du traitement des données:<br>${error.message}`;
        statusEl.style.color = '#f44336';
      }
    } else {
      throw new Error('Format de données invalide');
    }
  } catch (error) {
    console.error('Erreur:', error);
    statusEl.innerHTML = `❌ Erreur: ${error.message}<br>
      <small style="color: var(--text-muted);">
        Les données n'ont pas encore été générées. Attends quelques minutes que GitHub Actions s'exécute.
      </small>`;
    statusEl.style.color = '#f44336';
  } finally {
    btn.disabled = false;
    btn.textContent = '🚀 Charger le Dashboard';
  }
}

// Event listener sur le bouton
document.getElementById('loadHubSpotBtn').addEventListener('click', loadHubSpotData);

// Chargement automatique au démarrage de la page
window.addEventListener('DOMContentLoaded', () => {
  // Attendre 1 seconde puis charger automatiquement
  setTimeout(() => {
    console.log('🔄 Chargement automatique des données...');
    loadHubSpotData();
  }, 1000);
});

// ============================================================================
// Data Processing
// ============================================================================
function processData() {
  const clientStats = {};

  // Process ALL deals (Account Management Dashboard)
  dealsData.forEach(deal => {
    const phase = deal['Phase de la transaction'];
    const companyName = deal['Associated Company (Primary)'] || 'Inconnu';
    const montant = parseFloat(deal['Montant']) || 0;
    const pipeline = deal['Pipeline'] || 'Non défini';
    const closeDate = deal['Date de fermeture'];
    const createDate = deal['Date de création'];

    // Extraire l'année depuis la date de fermeture ou de création
    let year = 'Autre';
    if (closeDate) {
      const closeDateObj = new Date(closeDate);
      year = closeDateObj.getFullYear().toString();
    } else if (createDate) {
      const createDateObj = new Date(createDate);
      year = createDateObj.getFullYear().toString();
    } else {
      // Fallback: essayer d'extraire du pipeline si c'est un nombre à 4 chiffres
      const yearMatch = pipeline.match(/(\d{4})/);
      year = yearMatch ? yearMatch[1] : 'Autre';
    }

    if (!clientStats[companyName]) {
      clientStats[companyName] = {
        name: companyName,
        totalRevenue: 0,
        years: { '2022': 0, '2023': 0, '2024': 0, '2025': 0 },
        deals: [],
        dealCount: 0,
        lastDealDate: null
      };
    }

    clientStats[companyName].totalRevenue += montant;
    if (clientStats[companyName].years[year] !== undefined) {
      clientStats[companyName].years[year] += montant;
    }
    clientStats[companyName].deals.push({ year, montant, closeDate });
    clientStats[companyName].dealCount++;

    if (closeDate) {
      const date = new Date(closeDate);
      if (!clientStats[companyName].lastDealDate || date > clientStats[companyName].lastDealDate) {
        clientStats[companyName].lastDealDate = date;
      }
    }
  });

  // Calculate trends and scores
  Object.values(clientStats).forEach(client => {
    client.trend = calculateTrend(client);
    client.yearlyTrends = calculateYearlyTrends(client); // Tendances année par année
    client.score = calculateScore(client);
    client.segment = getSegment(client);
    client.recommendation = getRecommendation(client);
    client.priority = getPriority(client);
  });

  processedData = Object.values(clientStats).sort((a, b) => b.score - a.score);
  console.log('Données traitées:', processedData);
}

function calculateTrend(client) {
  // Nouvelle méthode : tendance globale sur plusieurs années
  // On regarde l'évolution moyenne pondérée sur 2022-2025

  const years = ['2022', '2023', '2024', '2025'];
  const revenues = years.map(y => client.years[y]);

  // Si aucune activité, tendance = 0
  if (revenues.every(r => r === 0)) return 0;

  // Calculer la croissance moyenne annuelle composée (CAGR-like)
  // On regarde combien d'années ont de l'activité
  const activeYears = revenues.filter(r => r > 0);

  if (activeYears.length === 1) {
    // Un seul année active, on regarde si c'est récent
    if (revenues[3] > 0) return 100; // Nouveau client 2025
    if (revenues[2] > 0) return 50;  // Nouveau client 2024
    return -50; // Ancien client qui a arrêté
  }

  // Calculer la tendance en comparant les 2 dernières années actives
  let lastYearRevenue = 0;
  let previousYearRevenue = 0;
  let lastYearIndex = -1;
  let previousYearIndex = -1;

  // Trouver les 2 dernières années avec activité
  for (let i = revenues.length - 1; i >= 0; i--) {
    if (revenues[i] > 0) {
      if (lastYearIndex === -1) {
        lastYearIndex = i;
        lastYearRevenue = revenues[i];
      } else if (previousYearIndex === -1) {
        previousYearIndex = i;
        previousYearRevenue = revenues[i];
        break;
      }
    }
  }

  // Si on n'a qu'une seule année active
  if (previousYearIndex === -1) {
    return lastYearIndex >= 2 ? 50 : -50;
  }

  // Calculer le taux de croissance annuel
  const yearsDiff = lastYearIndex - previousYearIndex;
  const growth = ((lastYearRevenue - previousYearRevenue) / previousYearRevenue) * 100;

  // Ajuster selon le nombre d'années
  const adjustedGrowth = growth / yearsDiff;

  // Bonus si activité récente (2024-2025)
  const recencyBonus = lastYearIndex >= 2 ? 1.2 : 0.8;

  return Math.round(adjustedGrowth * recencyBonus);
}

function calculateYearlyTrends(client) {
  // Calcule les tendances année par année de manière intelligente
  const years = ['2022', '2023', '2024', '2025'];
  const trends = {};

  years.forEach((year, index) => {
    if (index === 0) {
      // Première année : pas de tendance (pas d'année précédente)
      trends[year] = {
        value: null,
        label: 'N/A',
        description: 'Première année de référence',
        currentRevenue: client.years[year],
        previousRevenue: 0
      };
    } else {
      const currentYear = client.years[year];
      const previousYear = client.years[years[index - 1]];

      if (currentYear === 0 && previousYear === 0) {
        trends[year] = {
          value: 0,
          label: '—',
          description: 'Aucune activité',
          currentRevenue: 0,
          previousRevenue: 0
        };
      } else if (previousYear === 0 && currentYear > 0) {
        trends[year] = {
          value: 100,
          label: '🚀 Nouveau',
          description: 'Première activité',
          currentRevenue: currentYear,
          previousRevenue: 0
        };
      } else if (previousYear > 0 && currentYear === 0) {
        trends[year] = {
          value: -100,
          label: '⚠️ Arrêt',
          description: `Aucune activité (vs année précédente)`,
          currentRevenue: 0,
          previousRevenue: previousYear,
          previousYearLabel: years[index - 1]
        };
      } else {
        const growth = ((currentYear - previousYear) / previousYear) * 100;
        const rounded = Math.round(growth);

        let icon = '→';
        let label = 'Stable';
        if (rounded > 20) {
          icon = '↗';
          label = 'Forte croissance';
        } else if (rounded > 0) {
          icon = '↗';
          label = 'Croissance';
        } else if (rounded < -20) {
          icon = '↘';
          label = 'Forte baisse';
        } else if (rounded < 0) {
          icon = '↘';
          label = 'Baisse';
        }

        trends[year] = {
          value: rounded,
          label: `${icon} ${rounded > 0 ? '+' : ''}${rounded}%`,
          description: label,
          currentRevenue: currentYear,
          previousRevenue: previousYear
        };
      }
    }
  });

  return trends;
}

function calculateScore(client) {
  let score = 0;

  // CA total (40 points max)
  score += Math.min((client.totalRevenue / 100000) * 40, 40);

  // Trend (30 points max)
  if (client.trend > 50) score += 30;
  else if (client.trend > 20) score += 20;
  else if (client.trend > 0) score += 10;
  else if (client.trend < -20) score -= 10;

  // Récence (20 points max)
  if (client.lastDealDate) {
    const daysSince = (new Date() - client.lastDealDate) / (1000 * 60 * 60 * 24);
    if (daysSince < 180) score += 20;
    else if (daysSince < 365) score += 10;
  }

  // Nombre de deals (10 points max)
  score += Math.min(client.dealCount * 2, 10);

  return Math.round(score);
}

function getSegment(client) {
  const avgYearly = client.totalRevenue / 4;

  if (avgYearly > 100000 && client.trend > 0) return 'Stratégique';
  if (avgYearly > 50000 && client.trend >= -10) return 'Clé';
  if (avgYearly > 10000) return 'Régulier';
  if (client.trend < -20) return 'À Risque';
  if (client.years['2024'] === 0 && client.years['2023'] === 0) return 'Dormant';

  return 'Régulier';
}

function getRecommendation(client) {
  if (client.segment === 'Stratégique') {
    return 'Revue trimestrielle + Montée en gamme';
  }
  if (client.segment === 'Clé') {
    return 'Suivi régulier + Vente croisée';
  }
  if (client.segment === 'À Risque') {
    return 'URGENT: Plan de rétention';
  }
  if (client.segment === 'Dormant') {
    return 'Campagne de réactivation';
  }
  return 'Maintenir la relation';
}

function getPriority(client) {
  if (client.score > 70) return 'high';
  if (client.score > 40) return 'medium';
  return 'low';
}

// ============================================================================
// Dashboard Rendering
// ============================================================================
function renderDashboard() {
  renderKPIs();
  renderRevenueGlobalChart();
  renderClientEvolutionChart();
  renderSegmentationTable();
  renderRecommendations();
  renderAnalysis();
  initFilters();
}

// ============================================================================
// KPIs
// ============================================================================
function renderKPIs() {
  const totalRevenue = processedData.reduce((sum, c) => sum + c.totalRevenue, 0);
  const revenue2024 = processedData.reduce((sum, c) => sum + c.years['2024'], 0);
  const revenue2023 = processedData.reduce((sum, c) => sum + c.years['2023'], 0);
  const growth = revenue2023 > 0 ? ((revenue2024 - revenue2023) / revenue2023 * 100) : 0;

  const avgDeal = totalRevenue / processedData.reduce((sum, c) => sum + c.dealCount, 0);

  const strategicClients = processedData.filter(c => c.segment === 'Stratégique').length;
  const atRiskClients = processedData.filter(c => c.segment === 'À Risque').length;

  const kpis = [
    {
      label: 'CA Total',
      value: formatCurrency(totalRevenue),
      change: null
    },
    {
      label: 'CA 2024',
      value: formatCurrency(revenue2024),
      change: { value: growth.toFixed(1) + '%', positive: growth >= 0 }
    },
    {
      label: 'Nombre de Clients',
      value: processedData.length,
      change: null
    },
    {
      label: 'Ticket Moyen',
      value: formatCurrency(avgDeal),
      change: null
    },
    {
      label: 'Clients Stratégiques',
      value: strategicClients,
      change: { value: 'Forte valeur', positive: true }
    },
    {
      label: 'Clients à Risque',
      value: atRiskClients,
      change: { value: 'Attention', positive: false }
    }
  ];

  const kpiData = {
    'CA Total': { value: totalRevenue, context: 'total' },
    'CA 2024': { value: revenue2024, context: '2024', growth },
    'Nombre de Clients': { value: processedData.length, context: 'clients' },
    'Ticket Moyen': { value: avgDeal, context: 'ticket' },
    'Clients Stratégiques': { value: strategicClients, context: 'strategic' },
    'Clients à Risque': { value: atRiskClients, context: 'risk' }
  };

  const grid = document.getElementById('kpiGrid');
  grid.innerHTML = kpis.map((kpi, idx) => `
    <div class="kpi-card" onclick="showKPIDetails('${kpi.label}', ${JSON.stringify(kpiData[kpi.label]).replace(/'/g, "&#39;")})">
      <div class="kpi-label">${kpi.label}</div>
      <div class="kpi-value">${kpi.value}</div>
      ${kpi.change ? `
        <div class="kpi-change ${kpi.change.positive ? 'positive' : 'negative'}">
          ${kpi.change.positive ? '↗' : '↘'} ${kpi.change.value}
        </div>
      ` : ''}
    </div>
  `).join('');
}

// ============================================================================
// Show KPI Details
// ============================================================================
function showKPIDetails(label, data) {
  let content = '';

  switch(data.context) {
    case 'total':
      const years = ['2022', '2023', '2024', '2025'];
      const yearlyRevenues = years.map(y => ({
        year: y,
        revenue: processedData.reduce((sum, c) => sum + c.years[y], 0)
      }));

      content = `
        <div class="info-highlight">
          <div style="font-size: 24px; font-weight: 800; color: var(--accent);">
            ${formatCurrency(data.value)}
          </div>
          <div style="color: var(--text-muted); font-size: 13px;">Chiffre d'affaires total sur 4 ans</div>
        </div>

        <div style="margin-top: 20px;">
          <div style="color: var(--accent); font-weight: 700; margin-bottom: 12px;">Répartition par année</div>
          ${yearlyRevenues.map(yr => `
            <div class="info-row">
              <span class="info-label">${yr.year}</span>
              <span class="info-value" style="color: var(--green);">${formatCurrency(yr.revenue)}</span>
            </div>
          `).join('')}
        </div>
      `;
      break;

    case '2024':
      const top5_2024 = processedData
        .filter(c => c.years['2024'] > 0)
        .sort((a, b) => b.years['2024'] - a.years['2024'])
        .slice(0, 5);

      content = `
        <div class="info-highlight">
          <div style="font-size: 24px; font-weight: 800; color: var(--accent);">
            ${formatCurrency(data.value)}
          </div>
          <div style="color: var(--text-muted); font-size: 13px;">Chiffre d'affaires 2024</div>
        </div>

        <div class="info-row">
          <span class="info-label">Croissance vs 2023</span>
          <span class="info-value" style="color: ${data.growth >= 0 ? 'var(--green)' : 'var(--red)'}">
            ${data.growth >= 0 ? '+' : ''}${data.growth.toFixed(1)}%
          </span>
        </div>

        <div style="margin-top: 20px; padding-top: 16px; border-top: 2px solid var(--border);">
          <div style="color: var(--accent); font-weight: 700; margin-bottom: 12px;">Top 5 Clients 2024</div>
          ${top5_2024.map((c, i) => `
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
              <span>${i + 1}. ${c.name}</span>
              <span style="color: var(--green); font-weight: 700;">${formatCurrency(c.years['2024'])}</span>
            </div>
          `).join('')}
        </div>
      `;
      break;

    case 'clients':
      const segments = {
        'Stratégique': processedData.filter(c => c.segment === 'Stratégique').length,
        'Clé': processedData.filter(c => c.segment === 'Clé').length,
        'Régulier': processedData.filter(c => c.segment === 'Régulier').length,
        'À Risque': processedData.filter(c => c.segment === 'À Risque').length,
        'Dormant': processedData.filter(c => c.segment === 'Dormant').length
      };

      content = `
        <div class="info-highlight">
          <div style="font-size: 24px; font-weight: 800; color: var(--accent);">
            ${data.value} clients
          </div>
          <div style="color: var(--text-muted); font-size: 13px;">Dans le portefeuille</div>
        </div>

        <div style="margin-top: 20px;">
          <div style="color: var(--accent); font-weight: 700; margin-bottom: 12px;">Répartition par segment</div>
          ${Object.entries(segments).map(([seg, count]) => `
            <div class="info-row">
              <span class="info-label">
                <span class="badge ${seg.toLowerCase().replace(' ', '-')}">${seg}</span>
              </span>
              <span class="info-value">${count}</span>
            </div>
          `).join('')}
        </div>
      `;
      break;

    case 'strategic':
      const strategicClients = processedData.filter(c => c.segment === 'Stratégique');
      const strategicRevenue = strategicClients.reduce((sum, c) => sum + c.totalRevenue, 0);

      content = `
        <div class="info-highlight">
          <div style="font-size: 24px; font-weight: 800; color: var(--purple);">
            ${data.value} clients
          </div>
          <div style="color: var(--text-muted); font-size: 13px;">Clients stratégiques</div>
        </div>

        <div class="info-row">
          <span class="info-label">CA Total généré</span>
          <span class="info-value" style="color: var(--green);">${formatCurrency(strategicRevenue)}</span>
        </div>

        <div class="info-row">
          <span class="info-label">% du CA total</span>
          <span class="info-value">${((strategicRevenue / processedData.reduce((sum, c) => sum + c.totalRevenue, 0)) * 100).toFixed(1)}%</span>
        </div>

        ${strategicClients.length > 0 ? `
        <div style="margin-top: 20px; padding-top: 16px; border-top: 2px solid var(--border);">
          <div style="color: var(--purple); font-weight: 700; margin-bottom: 12px;">Liste des clients</div>
          ${strategicClients.slice(0, 10).map(c => `
            <div style="padding: 6px 0; color: var(--text);">• ${c.name}</div>
          `).join('')}
        </div>
        ` : ''}
      `;
      break;

    case 'risk':
      const riskClients = processedData.filter(c => c.segment === 'À Risque');
      const riskRevenue = riskClients.reduce((sum, c) => sum + c.totalRevenue, 0);

      content = `
        <div class="info-highlight" style="border-left-color: var(--orange);">
          <div style="font-size: 24px; font-weight: 800; color: var(--orange);">
            ${data.value} clients
          </div>
          <div style="color: var(--text-muted); font-size: 13px;">Clients à risque - Action requise</div>
        </div>

        ${riskClients.length > 0 ? `
        <div class="info-row">
          <span class="info-label">CA en risque</span>
          <span class="info-value" style="color: var(--orange);">${formatCurrency(riskRevenue)}</span>
        </div>

        <div style="margin-top: 20px; padding: 12px; background: rgba(245, 158, 11, 0.1); border-radius: 8px; border-left: 4px solid var(--orange);">
          <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px; font-weight: 600;">
            ⚠️ Action urgente
          </div>
          <div style="font-size: 13px; color: var(--text);">
            Ces clients montrent une baisse significative. Planifier des revues immédiates.
          </div>
        </div>

        <div style="margin-top: 16px; padding-top: 16px; border-top: 2px solid var(--border);">
          <div style="color: var(--orange); font-weight: 700; margin-bottom: 12px;">Clients à contacter</div>
          ${riskClients.map(c => `
            <div style="padding: 8px 0; border-bottom: 1px solid var(--border);">
              <div style="color: var(--text); font-weight: 600;">${c.name}</div>
              <div style="font-size: 12px; color: var(--text-muted);">
                Baisse: ${c.trend.toFixed(1)}% • ${c.recommendation}
              </div>
            </div>
          `).join('')}
        </div>
        ` : `
        <div style="text-align: center; padding: 20px; color: var(--green);">
          ✓ Aucun client en situation critique
        </div>
        `}
      `;
      break;

    case 'ticket':
      const dealsPerYear = ['2022', '2023', '2024', '2025'].map(year => {
        const yearDeals = processedData.reduce((sum, c) => {
          return sum + c.deals.filter(d => d.year === year).length;
        }, 0);
        const yearRevenue = processedData.reduce((sum, c) => sum + c.years[year], 0);
        return {
          year,
          avgTicket: yearDeals > 0 ? yearRevenue / yearDeals : 0,
          deals: yearDeals
        };
      }).filter(y => y.deals > 0);

      content = `
        <div class="info-highlight">
          <div style="font-size: 24px; font-weight: 800; color: var(--accent);">
            ${formatCurrency(data.value)}
          </div>
          <div style="color: var(--text-muted); font-size: 13px;">Ticket moyen sur tous les deals</div>
        </div>

        <div style="margin-top: 20px;">
          <div style="color: var(--accent); font-weight: 700; margin-bottom: 12px;">Évolution du ticket moyen</div>
          ${dealsPerYear.map(y => `
            <div class="info-row">
              <span class="info-label">${y.year} (${y.deals} deals)</span>
              <span class="info-value">${formatCurrency(y.avgTicket)}</span>
            </div>
          `).join('')}
        </div>
      `;
      break;
  }

  openInfoPanel(label, content);
}

// ============================================================================
// Revenue Global Chart
// ============================================================================
function renderRevenueGlobalChart() {
  const years = ['2022', '2023', '2024', '2025'];
  const revenues = years.map(year =>
    processedData.reduce((sum, c) => sum + c.years[year], 0)
  );

  const svg = document.getElementById('chartRevenueGlobal');
  svg.innerHTML = '';

  const width = 800;
  const height = 300;
  const padding = 60;
  const barWidth = (width - 2 * padding) / years.length * 0.7;

  svg.setAttribute('viewBox', `0 0 ${width} ${height}`);

  const maxRevenue = Math.max(...revenues, 1);

  const colors = ['#3b82f6', '#22c55e', '#a855f7', '#f59e0b'];

  // Create tooltip
  const tooltip = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  tooltip.setAttribute('id', 'globalChartTooltip');
  tooltip.style.opacity = '0';
  tooltip.style.pointerEvents = 'none';
  tooltip.style.transition = 'opacity 0.2s';
  svg.appendChild(tooltip);

  const tooltipRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
  tooltipRect.setAttribute('rx', 8);
  tooltipRect.setAttribute('fill', '#1d2342');
  tooltipRect.setAttribute('stroke', '#6366f1');
  tooltipRect.setAttribute('stroke-width', 2);
  tooltip.appendChild(tooltipRect);

  const tooltipText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  tooltipText.setAttribute('fill', '#f1f5f9');
  tooltipText.setAttribute('font-size', '13');
  tooltipText.setAttribute('font-weight', '600');
  tooltip.appendChild(tooltipText);

  years.forEach((year, i) => {
    const revenue = revenues[i];
    const barHeight = (revenue / maxRevenue) * (height - 2 * padding);
    const x = padding + i * ((width - 2 * padding) / years.length) + ((width - 2 * padding) / years.length - barWidth) / 2;
    const y = padding + (height - 2 * padding) - barHeight;

    const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
    rect.setAttribute('x', x);
    rect.setAttribute('y', y);
    rect.setAttribute('width', barWidth);
    rect.setAttribute('height', barHeight);
    rect.setAttribute('rx', 6);
    rect.setAttribute('fill', colors[i]);
    rect.classList.add('bar');
    rect.style.cursor = 'pointer';

    // Tooltip interaction
    rect.addEventListener('mouseenter', function() {
      tooltip.style.opacity = '1';
      const prevRevenue = i > 0 ? revenues[i - 1] : 0;
      const growth = prevRevenue > 0 ? (((revenue - prevRevenue) / prevRevenue) * 100).toFixed(1) : 0;
      const growthText = i > 0 ? ` (${growth > 0 ? '+' : ''}${growth}%)` : '';
      tooltipText.textContent = `${year}: ${formatCurrency(revenue)}${growthText}`;

      const textBBox = tooltipText.getBBox();
      const tooltipWidth = textBBox.width + 20;
      const tooltipHeight = textBBox.height + 16;

      tooltipRect.setAttribute('width', tooltipWidth);
      tooltipRect.setAttribute('height', tooltipHeight);

      const tooltipX = x + barWidth / 2 - tooltipWidth / 2;
      const tooltipY = y - tooltipHeight - 10;

      tooltipRect.setAttribute('x', tooltipX);
      tooltipRect.setAttribute('y', tooltipY);
      tooltipText.setAttribute('x', tooltipX + 10);
      tooltipText.setAttribute('y', tooltipY + tooltipHeight / 2 + 5);

      rect.style.opacity = '0.7';
      rect.style.filter = 'brightness(1.3)';
    });

    rect.addEventListener('mouseleave', function() {
      tooltip.style.opacity = '0';
      rect.style.opacity = '1';
      rect.style.filter = 'none';
    });

    // Click handler for details
    rect.addEventListener('click', function() {
      // Get clients active this year
      const activeClients = processedData.filter(c => c.years[year] > 0);
      const avgDealSize = revenue / activeClients.reduce((sum, c) => {
        return sum + c.deals.filter(d => d.year === year).length;
      }, 0);

      const topClientsYear = activeClients
        .sort((a, b) => b.years[year] - a.years[year])
        .slice(0, 5);

      const infoContent = `
        <div class="info-highlight">
          <div style="font-size: 24px; font-weight: 800; color: var(--accent); margin-bottom: 8px;">
            ${formatCurrency(revenue)}
          </div>
          <div style="color: var(--text-muted); font-size: 13px;">Chiffre d'affaires ${year}</div>
        </div>

        <div class="info-row">
          <span class="info-label">Nombre de clients actifs</span>
          <span class="info-value">${activeClients.length}</span>
        </div>

        <div class="info-row">
          <span class="info-label">Taille moyenne deal</span>
          <span class="info-value">${formatCurrency(avgDealSize)}</span>
        </div>

        <div class="info-row">
          <span class="info-label">Croissance vs ${parseInt(year) - 1}</span>
          <span class="info-value" style="color: ${growth > 0 ? 'var(--green)' : 'var(--red)'}">
            ${growth > 0 ? '+' : ''}${growth}%
          </span>
        </div>

        <div style="margin-top: 20px; padding-top: 16px; border-top: 2px solid var(--border);">
          <div style="color: var(--accent); font-weight: 700; margin-bottom: 12px; font-size: 14px;">
            Top 5 Clients ${year}
          </div>
          ${topClientsYear.map((client, idx) => `
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
              <span style="color: var(--text);">${idx + 1}. ${client.name}</span>
              <span style="color: var(--green); font-weight: 700;">${formatCurrency(client.years[year])}</span>
            </div>
          `).join('')}
        </div>
      `;

      openInfoPanel(`Détails ${year}`, infoContent);
    });

    svg.appendChild(rect);

    const yearText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    yearText.setAttribute('x', x + barWidth / 2);
    yearText.setAttribute('y', height - padding + 20);
    yearText.setAttribute('text-anchor', 'middle');
    yearText.setAttribute('fill', '#94a3b8');
    yearText.setAttribute('font-size', '13');
    yearText.setAttribute('font-weight', '600');
    yearText.textContent = year;
    svg.appendChild(yearText);

    const valueText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    valueText.setAttribute('x', x + barWidth / 2);
    valueText.setAttribute('y', y - 8);
    valueText.setAttribute('text-anchor', 'middle');
    valueText.setAttribute('fill', colors[i]);
    valueText.setAttribute('font-size', '12');
    valueText.setAttribute('font-weight', '700');
    valueText.textContent = formatCurrency(revenue, true);
    svg.appendChild(valueText);
  });
}

// ============================================================================
// Client Evolution Chart (Grouped Bars with Tooltips)
// ============================================================================
function renderClientEvolutionChart() {
  const topClients = processedData.slice(0, 10);
  const years = ['2022', '2023', '2024', '2025'];

  const svg = document.getElementById('chartClientEvolution');
  svg.innerHTML = '';

  const width = 1400;
  const height = 400;
  const padding = 80;
  const chartWidth = width - 2 * padding;
  const chartHeight = height - 2 * padding;

  svg.setAttribute('viewBox', `0 0 ${width} ${height}`);

  // Find max revenue
  const maxRevenue = Math.max(...topClients.flatMap(c =>
    years.map(y => c.years[y])
  ), 1);

  const colors = ['#6366f1', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#ec4899', '#f97316', '#84cc16', '#a855f7'];

  // Create tooltip
  const tooltip = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  tooltip.setAttribute('id', 'chartTooltip');
  tooltip.style.opacity = '0';
  tooltip.style.pointerEvents = 'none';
  tooltip.style.transition = 'opacity 0.2s';
  svg.appendChild(tooltip);

  const tooltipRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
  tooltipRect.setAttribute('rx', 8);
  tooltipRect.setAttribute('fill', '#1d2342');
  tooltipRect.setAttribute('stroke', '#6366f1');
  tooltipRect.setAttribute('stroke-width', 2);
  tooltip.appendChild(tooltipRect);

  const tooltipText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  tooltipText.setAttribute('fill', '#f1f5f9');
  tooltipText.setAttribute('font-size', '13');
  tooltipText.setAttribute('font-weight', '600');
  tooltip.appendChild(tooltipText);

  // Draw grid lines
  for (let i = 0; i <= 5; i++) {
    const y = padding + (chartHeight / 5) * i;
    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    line.setAttribute('x1', padding);
    line.setAttribute('y1', y);
    line.setAttribute('x2', width - padding);
    line.setAttribute('y2', y);
    line.setAttribute('stroke', '#1e293b');
    line.setAttribute('stroke-width', 1);
    svg.appendChild(line);
  }

  const barGroupWidth = chartWidth / years.length;
  const barWidth = (barGroupWidth * 0.8) / topClients.length;
  const barGap = 2;

  // Draw bars for each year
  years.forEach((year, yearIdx) => {
    topClients.forEach((client, clientIdx) => {
      const revenue = client.years[year];
      if (revenue === 0) return;

      const barHeight = (revenue / maxRevenue) * chartHeight;
      const x = padding + yearIdx * barGroupWidth + clientIdx * (barWidth + barGap) + (barGroupWidth * 0.1);
      const y = padding + chartHeight - barHeight;

      const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      rect.setAttribute('x', x);
      rect.setAttribute('y', y);
      rect.setAttribute('width', barWidth);
      rect.setAttribute('height', barHeight);
      rect.setAttribute('rx', 3);
      rect.setAttribute('fill', colors[clientIdx]);
      rect.classList.add('bar');
      rect.style.cursor = 'pointer';

      // Tooltip interaction
      rect.addEventListener('mouseenter', function(e) {
        tooltip.style.opacity = '1';
        tooltipText.textContent = `${client.name}: ${formatCurrency(revenue)} (${year})`;

        const textBBox = tooltipText.getBBox();
        const tooltipWidth = textBBox.width + 20;
        const tooltipHeight = textBBox.height + 16;

        tooltipRect.setAttribute('width', tooltipWidth);
        tooltipRect.setAttribute('height', tooltipHeight);

        let tooltipX = x + barWidth / 2 - tooltipWidth / 2;
        let tooltipY = y - tooltipHeight - 10;

        if (tooltipX < padding) tooltipX = padding;
        if (tooltipX + tooltipWidth > width - padding) tooltipX = width - padding - tooltipWidth;
        if (tooltipY < padding) tooltipY = y + barHeight + 10;

        tooltipRect.setAttribute('x', tooltipX);
        tooltipRect.setAttribute('y', tooltipY);
        tooltipText.setAttribute('x', tooltipX + 10);
        tooltipText.setAttribute('y', tooltipY + tooltipHeight / 2 + 5);

        rect.style.opacity = '0.7';
        rect.style.filter = 'brightness(1.3)';
      });

      rect.addEventListener('mouseleave', function() {
        tooltip.style.opacity = '0';
        rect.style.opacity = '1';
        rect.style.filter = 'none';
      });

      // Click handler for client details
      rect.addEventListener('click', function() {
        const clientDeals = client.deals.filter(d => d.year === year);
        const prevYearRevenue = year === '2022' ? 0 : client.years[(parseInt(year) - 1).toString()];
        const yearGrowth = prevYearRevenue > 0 ? (((revenue - prevYearRevenue) / prevYearRevenue) * 100).toFixed(1) : 0;

        const infoContent = `
          <div class="info-highlight">
            <div style="font-size: 20px; font-weight: 800; color: var(--accent); margin-bottom: 8px;">
              ${client.name}
            </div>
            <div style="color: var(--text-muted); font-size: 13px;">Année ${year}</div>
          </div>

          <div class="info-row">
            <span class="info-label">CA ${year}</span>
            <span class="info-value" style="color: var(--green);">${formatCurrency(revenue)}</span>
          </div>

          <div class="info-row">
            <span class="info-label">Nombre de deals</span>
            <span class="info-value">${clientDeals.length}</span>
          </div>

          <div class="info-row">
            <span class="info-label">Ticket moyen</span>
            <span class="info-value">${formatCurrency(revenue / clientDeals.length)}</span>
          </div>

          ${prevYearRevenue > 0 ? `
          <div class="info-row">
            <span class="info-label">Croissance vs ${parseInt(year) - 1}</span>
            <span class="info-value" style="color: ${yearGrowth > 0 ? 'var(--green)' : 'var(--red)'}">
              ${yearGrowth > 0 ? '+' : ''}${yearGrowth}%
            </span>
          </div>
          ` : ''}

          <div style="margin-top: 20px; padding-top: 16px; border-top: 2px solid var(--border);">
            <div style="color: var(--accent); font-weight: 700; margin-bottom: 12px; font-size: 14px;">
              Vue d'ensemble du client
            </div>

            <div class="info-row">
              <span class="info-label">Segment</span>
              <span class="info-value">
                <span class="badge ${client.segment.toLowerCase().replace(' ', '-')}">${client.segment}</span>
              </span>
            </div>

            <div class="info-row">
              <span class="info-label">Score global</span>
              <span class="info-value priority-${client.priority}">${client.score}/100</span>
            </div>

            <div class="info-row">
              <span class="info-label">CA Total (2022-2025)</span>
              <span class="info-value" style="color: var(--green);">${formatCurrency(client.totalRevenue)}</span>
            </div>

            <div class="info-row">
              <span class="info-label">Tendance globale</span>
              <span class="info-value" style="color: ${client.trend > 0 ? 'var(--green)' : 'var(--red)'}">
                ${client.trend > 10 ? '↗' : client.trend < -10 ? '↘' : '→'} ${client.trend.toFixed(1)}%
              </span>
            </div>

            <div style="margin-top: 12px; padding: 12px; background: rgba(99, 102, 241, 0.1); border-radius: 8px;">
              <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Recommandation:</div>
              <div style="font-size: 13px; font-weight: 600; color: var(--text);">${client.recommendation}</div>
            </div>
          </div>
        `;

        openInfoPanel(`${client.name} - ${year}`, infoContent);
      });

      svg.appendChild(rect);
    });

    // X-axis labels
    const labelX = padding + yearIdx * barGroupWidth + barGroupWidth / 2;
    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    text.setAttribute('x', labelX);
    text.setAttribute('y', height - padding + 25);
    text.setAttribute('text-anchor', 'middle');
    text.setAttribute('fill', '#94a3b8');
    text.setAttribute('font-size', '14');
    text.setAttribute('font-weight', '700');
    text.textContent = year;
    svg.appendChild(text);
  });

  // Legend
  const legend = document.getElementById('legendClientEvolution');
  legend.innerHTML = topClients.map((client, i) => `
    <div class="legend-item" style="cursor: pointer; transition: all 0.2s;"
         onmouseover="this.style.transform='scale(1.1)'"
         onmouseout="this.style.transform='scale(1)'">
      <div class="legend-color" style="background: ${colors[i]}"></div>
      <span>${client.name}</span>
    </div>
  `).join('');
}

// ============================================================================
// Segmentation Table
// ============================================================================
function renderSegmentationTable() {
  const tbody = document.getElementById('segmentationBody');

  // Apply filters
  let filteredData = processedData.filter(client => {
    // Year filter
    if (currentFilters.year !== 'all') {
      const yearRevenue = client.years[currentFilters.year];
      if (!yearRevenue || yearRevenue === 0) return false;
    }
    return true;
  });

  // Apply sorting
  filteredData.sort((a, b) => {
    let aVal, bVal;

    switch(sortColumn) {
      case 'rank':
        return sortDirection === 'asc' ?
          processedData.indexOf(a) - processedData.indexOf(b) :
          processedData.indexOf(b) - processedData.indexOf(a);
      case 'name':
        aVal = a.name.toLowerCase();
        bVal = b.name.toLowerCase();
        break;
      case 'segment':
        aVal = a.segment;
        bVal = b.segment;
        break;
      case 'total':
      case '2022':
      case '2023':
      case '2024':
      case '2025':
        aVal = sortColumn === 'total' ? a.totalRevenue : a.years[sortColumn];
        bVal = sortColumn === 'total' ? b.totalRevenue : b.years[sortColumn];
        break;
      case 'trend':
        aVal = a.trend;
        bVal = b.trend;
        break;
      case 'score':
        aVal = a.score;
        bVal = b.score;
        break;
      default:
        return 0;
    }

    if (typeof aVal === 'string') {
      return sortDirection === 'asc' ?
        aVal.localeCompare(bVal) :
        bVal.localeCompare(aVal);
    }

    return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
  });

  tbody.innerHTML = filteredData.map((client, idx) => {
    const trendIcon = client.trend > 10 ? '↗' : client.trend < -10 ? '↘' : '→';
    const trendColor = client.trend > 10 ? 'color: var(--green)' : client.trend < -10 ? 'color: var(--red)' : 'color: var(--text-muted)';

    // Fonctions helpers pour les cellules d'années
    const renderYearCell = (year) => {
      const revenue = client.years[year];
      const trend = client.yearlyTrends[year];

      if (revenue === 0) {
        return `<span style="color: var(--text-muted);">-</span>`;
      }

      let trendColor = 'var(--text-muted)';
      if (trend.value !== null && trend.value !== 0) {
        if (trend.value > 20) trendColor = 'var(--green)';
        else if (trend.value > 0) trendColor = 'var(--green-light)';
        else if (trend.value < -20) trendColor = 'var(--red)';
        else if (trend.value < 0) trendColor = 'var(--orange)';
      }

      // Tooltip avec description complète
      let tooltipText = trend.description;
      if (trend.currentRevenue && trend.previousRevenue) {
        tooltipText = `${trend.description}: ${formatCurrency(trend.previousRevenue)} → ${formatCurrency(trend.currentRevenue)}`;
      } else if (trend.currentRevenue && !trend.previousRevenue) {
        tooltipText = `${trend.description}: ${formatCurrency(trend.currentRevenue)}`;
      }

      return `
        <div title="${tooltipText}">
          <div style="font-weight: 600;">${formatCurrency(revenue)}</div>
          <div style="font-size: 11px; color: ${trendColor}; margin-top: 2px;">
            ${trend.label}
          </div>
        </div>
      `;
    };

    return `
      <tr onclick='showClientDetails(${JSON.stringify(client).replace(/'/g, "&#39;")})'>
        <td><strong>${idx + 1}</strong></td>
        <td><strong>${client.name}</strong></td>
        <td><span class="badge ${client.segment.toLowerCase().replace(' ', '-')}">${client.segment}</span></td>
        <td style="color: var(--green); font-weight: 700;">${formatCurrency(client.totalRevenue)}</td>
        <td>${renderYearCell('2022')}</td>
        <td>${renderYearCell('2023')}</td>
        <td>${renderYearCell('2024')}</td>
        <td>${renderYearCell('2025')}</td>
        <td style="${trendColor}"><strong>${trendIcon} ${client.trend.toFixed(1)}%</strong></td>
        <td><strong class="priority-${client.priority}">${client.score}/100</strong></td>
        <td style="font-size: 12px;">${client.recommendation}</td>
      </tr>
    `;
  }).join('');
}

// ============================================================================
// Show Client Details
// ============================================================================
function showClientDetails(client) {
  const years = ['2022', '2023', '2024', '2025'];
  const activeYears = years.filter(y => client.years[y] > 0);

  // Calcul du score (pour afficher les détails)
  const scoreCA = Math.min((client.totalRevenue / 100000) * 40, 40);
  let scoreTrend = 0;
  if (client.trend > 50) scoreTrend = 30;
  else if (client.trend > 20) scoreTrend = 20;
  else if (client.trend > 0) scoreTrend = 10;
  else if (client.trend < -20) scoreTrend = -10;

  let scoreRecence = 0;
  if (client.lastDealDate) {
    const daysSince = (new Date() - client.lastDealDate) / (1000 * 60 * 60 * 24);
    if (daysSince < 180) scoreRecence = 20;
    else if (daysSince < 365) scoreRecence = 10;
  }

  const scoreDeals = Math.min(client.dealCount * 2, 10);

  const infoContent = `
    <div class="info-highlight">
      <div style="font-size: 20px; font-weight: 800; color: var(--accent); margin-bottom: 8px;">
        ${client.name}
      </div>
      <div style="display: flex; gap: 8px; margin-top: 8px;">
        <span class="badge ${client.segment.toLowerCase().replace(' ', '-')}">${client.segment}</span>
        <span class="badge" style="background: rgba(99, 102, 241, 0.2); color: var(--accent);">
          Score: ${client.score}/100
        </span>
      </div>
    </div>

    <div class="info-row">
      <span class="info-label">CA Total (2022-2025)</span>
      <span class="info-value" style="color: var(--green); font-size: 18px;">${formatCurrency(client.totalRevenue)}</span>
    </div>

    <div class="info-row">
      <span class="info-label">Nombre total de deals</span>
      <span class="info-value">${client.dealCount}</span>
    </div>

    <div class="info-row">
      <span class="info-label">Ticket moyen</span>
      <span class="info-value">${formatCurrency(client.totalRevenue / client.dealCount)}</span>
    </div>

    <div class="info-row">
      <span class="info-label">Tendance globale</span>
      <span class="info-value" style="color: ${client.trend > 0 ? 'var(--green)' : 'var(--red)'}">
        ${client.trend > 10 ? '↗' : client.trend < -10 ? '↘' : '→'} ${client.trend.toFixed(1)}%
      </span>
    </div>

    ${client.lastDealDate ? `
    <div class="info-row">
      <span class="info-label">Dernier deal</span>
      <span class="info-value">${new Date(client.lastDealDate).toLocaleDateString('fr-FR')}</span>
    </div>
    ` : ''}

    <div style="margin-top: 20px; padding-top: 16px; border-top: 2px solid var(--border);">
      <div style="color: var(--accent); font-weight: 700; margin-bottom: 12px; font-size: 14px;">
        Évolution année par année
      </div>
      ${years.map(year => {
        const revenue = client.years[year];
        const trend = client.yearlyTrends[year];
        if (revenue === 0 && year !== '2022') return '';

        let trendColor = 'var(--text-muted)';
        if (trend.value !== null && trend.value !== 0) {
          if (trend.value > 20) trendColor = 'var(--green)';
          else if (trend.value > 0) trendColor = 'var(--green-light)';
          else if (trend.value < -20) trendColor = 'var(--red)';
          else if (trend.value < 0) trendColor = 'var(--orange)';
        }

        // Format description with proper currency formatting
        let fullDescription = trend.description;
        if (trend.currentRevenue && trend.previousRevenue) {
          fullDescription = `${trend.description}: ${formatCurrency(trend.previousRevenue)} → ${formatCurrency(trend.currentRevenue)}`;
        } else if (trend.currentRevenue && !trend.previousRevenue) {
          fullDescription = `${trend.description}: ${formatCurrency(trend.currentRevenue)}`;
        } else if (trend.previousRevenue && trend.previousYearLabel) {
          fullDescription = `${trend.description} (vs ${formatCurrency(trend.previousRevenue)} en ${trend.previousYearLabel})`;
        }

        return `
        <div style="padding: 10px 0; border-bottom: 1px solid var(--border);">
          <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
            <span style="color: var(--text); font-weight: 600;">${year}</span>
            <span style="color: var(--green); font-weight: 700;">${revenue > 0 ? formatCurrency(revenue) : '-'}</span>
          </div>
          ${revenue > 0 ? `
          <div style="font-size: 11px; color: ${trendColor}; margin-left: 8px;">
            ${trend.label} <span style="color: var(--text-muted);">• ${fullDescription}</span>
          </div>
          ` : ''}
        </div>
        `;
      }).join('')}
    </div>

    <!-- Section Calculs (Discrète) -->
    <details style="margin-top: 20px; padding: 12px; background: rgba(255, 255, 255, 0.02); border-radius: 8px; border: 1px solid var(--border);">
      <summary style="cursor: pointer; font-size: 12px; color: var(--text-muted); font-weight: 600; user-select: none;">
        🔍 Voir les détails des calculs
      </summary>

      <div style="margin-top: 16px; padding-top: 12px; border-top: 1px solid var(--border);">
        <div style="font-size: 13px; color: var(--accent); font-weight: 700; margin-bottom: 12px;">
          Calcul du Score (${client.score}/100)
        </div>

        <div style="font-size: 12px; color: var(--text); line-height: 1.8;">
          <div style="margin-bottom: 8px;">
            <span style="color: var(--text-muted);">CA Total:</span>
            <span style="float: right; color: var(--accent); font-weight: 600;">+${scoreCA.toFixed(1)} pts</span><br>
            <span style="font-size: 11px; color: var(--text-muted); margin-left: 8px;">
              ${formatCurrency(client.totalRevenue)} = ${(client.totalRevenue / 2500).toFixed(1)} × 1pt (max 40)
            </span>
          </div>

          <div style="margin-bottom: 8px;">
            <span style="color: var(--text-muted);">Tendance:</span>
            <span style="float: right; color: ${scoreTrend >= 0 ? 'var(--green)' : 'var(--red)'}; font-weight: 600;">
              ${scoreTrend >= 0 ? '+' : ''}${scoreTrend} pts
            </span><br>
            <span style="font-size: 11px; color: var(--text-muted); margin-left: 8px;">
              ${client.trend.toFixed(1)}% ${scoreTrend === 30 ? '(>50% = 30pts)' : scoreTrend === 20 ? '(20-50% = 20pts)' : scoreTrend === 10 ? '(0-20% = 10pts)' : scoreTrend === -10 ? '(<-20% = -10pts)' : '(stable = 0pt)'}
            </span>
          </div>

          <div style="margin-bottom: 8px;">
            <span style="color: var(--text-muted);">Récence:</span>
            <span style="float: right; color: var(--blue); font-weight: 600;">+${scoreRecence} pts</span><br>
            <span style="font-size: 11px; color: var(--text-muted); margin-left: 8px;">
              ${client.lastDealDate ?
                `Dernier deal: ${Math.round((new Date() - client.lastDealDate) / (1000 * 60 * 60 * 24))} jours` +
                (scoreRecence === 20 ? ' (<6 mois = 20pts)' : scoreRecence === 10 ? ' (6-12 mois = 10pts)' : ' (>12 mois = 0pt)')
                : 'Aucune date (0pt)'}
            </span>
          </div>

          <div style="margin-bottom: 8px;">
            <span style="color: var(--text-muted);">Deals:</span>
            <span style="float: right; color: var(--purple); font-weight: 600;">+${scoreDeals} pts</span><br>
            <span style="font-size: 11px; color: var(--text-muted); margin-left: 8px;">
              ${client.dealCount} deals × 2pts (max 10)
            </span>
          </div>

          <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); text-align: right;">
            <span style="font-size: 14px; font-weight: 700; color: var(--accent);">
              Total: ${scoreCA.toFixed(1)} + ${scoreTrend} + ${scoreRecence} + ${scoreDeals} = ${client.score}/100
            </span>
          </div>
        </div>

        <div style="margin-top: 20px; padding-top: 12px; border-top: 1px solid var(--border);">
          <div style="font-size: 13px; color: var(--accent); font-weight: 700; margin-bottom: 8px;">
            Calcul de la Tendance Globale (${client.trend.toFixed(1)}%)
          </div>
          <div style="font-size: 11px; color: var(--text-muted); line-height: 1.6;">
            Méthode: Comparaison des 2 dernières années actives, ajustée par l'écart temporel et bonus de récence (×1.2 si 2024-2025, ×0.8 si 2022-2023).
          </div>
        </div>
      </div>
    </details>

    <div style="margin-top: 20px; padding: 16px; background: rgba(99, 102, 241, 0.1); border-radius: 10px; border-left: 4px solid var(--accent);">
      <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 6px; font-weight: 600;">
        Action recommandée:
      </div>
      <div style="font-size: 14px; font-weight: 600; color: var(--text);">
        ${client.recommendation}
      </div>
    </div>
  `;

  openInfoPanel(`Détails Client - ${client.name}`, infoContent);
}

// ============================================================================
// Recommendations
// ============================================================================
function renderRecommendations() {
  const highPriority = processedData.filter(c => c.priority === 'high');
  const atRisk = processedData.filter(c => c.segment === 'À Risque');
  const dormant = processedData.filter(c => c.segment === 'Dormant');
  const strategic = processedData.filter(c => c.segment === 'Stratégique');

  const recommendations = [
    {
      title: `${highPriority.length} Clients Haute Priorité`,
      text: `Focaliser 60% du temps sur: ${highPriority.slice(0, 3).map(c => c.name).join(', ')}. Ces clients représentent ${formatCurrency(highPriority.reduce((s, c) => s + c.totalRevenue, 0))} de CA.`,
      action: 'Revues trimestrielles',
      priority: 'high'
    },
    {
      title: `${atRisk.length} Clients à Risque`,
      text: atRisk.length > 0 ? `ALERTE: ${atRisk.map(c => c.name).join(', ')} montrent une baisse de CA. Action immédiate requise.` : 'Aucun client en situation critique.',
      action: 'Plan de rétention urgent',
      priority: atRisk.length > 0 ? 'high' : 'low'
    },
    {
      title: `${dormant.length} Clients Dormants`,
      text: dormant.length > 0 ? `Opportunité de réactivation: ${dormant.slice(0, 3).map(c => c.name).join(', ')}. Potentiel de ${formatCurrency(dormant.reduce((s, c) => s + c.totalRevenue, 0))}.` : 'Tous les clients sont actifs.',
      action: 'Campagne de réactivation',
      priority: dormant.length > 0 ? 'medium' : 'low'
    },
    {
      title: `${strategic.length} Clients Stratégiques`,
      text: `Développer les relations avec: ${strategic.slice(0, 3).map(c => c.name).join(', ')}. Opportunités de montée en gamme et vente croisée.`,
      action: 'Programme VIP',
      priority: 'medium'
    }
  ];

  const grid = document.getElementById('recommendationsGrid');
  grid.innerHTML = recommendations.map(rec => `
    <div class="action-card ${rec.priority}">
      <h4>${rec.title}</h4>
      <p>${rec.text}</p>
      <span class="action-tag">${rec.action}</span>
    </div>
  `).join('');
}

// ============================================================================
// Additional Analysis
// ============================================================================
function renderAnalysis() {
  const totalRevenue = processedData.reduce((sum, c) => sum + c.totalRevenue, 0);
  const top3Revenue = processedData.slice(0, 3).reduce((sum, c) => sum + c.totalRevenue, 0);
  const concentration = (top3Revenue / totalRevenue * 100).toFixed(1);

  const avgGrowth = processedData.reduce((sum, c) => sum + c.trend, 0) / processedData.length;

  const highGrowth = processedData.filter(c => c.trend > 50);

  const avgTicket = totalRevenue / processedData.reduce((sum, c) => sum + c.dealCount, 0);
  const bigDeals = processedData.filter(c => (c.totalRevenue / c.dealCount) > avgTicket * 2);

  const analyses = [
    {
      title: 'Concentration du CA',
      text: `Les 3 premiers clients représentent ${concentration}% du CA total. ${concentration > 50 ? 'RISQUE ÉLEVÉ de dépendance.' : 'Diversification satisfaisante.'}`,
      action: concentration > 50 ? 'Diversifier le portefeuille' : 'Maintenir l\'équilibre',
      priority: concentration > 50 ? 'high' : 'low'
    },
    {
      title: 'Tendance Globale',
      text: `Croissance moyenne du portefeuille: ${avgGrowth.toFixed(1)}%. ${avgGrowth > 20 ? 'Excellente dynamique.' : avgGrowth > 0 ? 'Croissance modérée.' : 'Portefeuille en déclin.'}`,
      action: avgGrowth > 0 ? 'Capitaliser sur la croissance' : 'Plan de redressement',
      priority: avgGrowth < 0 ? 'high' : 'medium'
    },
    {
      title: 'Clients Haute Croissance',
      text: `${highGrowth.length} clients en forte croissance (>50%). ${highGrowth.length > 0 ? 'Opportunités: ' + highGrowth.slice(0, 3).map(c => c.name).join(', ') + '.' : 'Focus sur la stabilisation.'}`,
      action: 'Programme d\'accélération',
      priority: 'medium'
    },
    {
      title: 'Gros Contrats',
      text: `${bigDeals.length} clients avec ticket moyen supérieur au double de la moyenne (${formatCurrency(avgTicket)}). ${bigDeals.length > 0 ? 'Focus: ' + bigDeals.slice(0, 3).map(c => c.name).join(', ') : 'Opportunité d\'augmenter la taille des deals'}.`,
      action: 'Stratégie grands comptes',
      priority: 'medium'
    }
  ];

  const grid = document.getElementById('analysisGrid');
  grid.innerHTML = analyses.map(analysis => `
    <div class="action-card ${analysis.priority}">
      <h4>${analysis.title}</h4>
      <p>${analysis.text}</p>
      <span class="action-tag">${analysis.action}</span>
    </div>
  `).join('');
}

// ============================================================================
// Filter Initialization
// ============================================================================
function initFilters() {
  const filterButtons = document.querySelectorAll('.filter-btn');

  filterButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      const filterType = this.dataset.filterType;
      const filterValue = this.dataset.filter;

      // Update active states for this filter type
      document.querySelectorAll(`[data-filter-type="${filterType}"]`).forEach(b => {
        b.classList.remove('active');
      });
      this.classList.add('active');

      // Update filter state
      currentFilters[filterType] = filterValue;

      // Re-render table with new filters
      renderSegmentationTable();
    });
  });

  // Table sorting
  const tableHeaders = document.querySelectorAll('#segmentationTable th[data-sort]');
  tableHeaders.forEach(th => {
    th.addEventListener('click', function() {
      const column = this.dataset.sort;

      if (sortColumn === column) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        sortColumn = column;
        sortDirection = 'desc';
      }

      // Update header indicators
      tableHeaders.forEach(h => {
        h.innerHTML = h.textContent.replace(' ↑', '').replace(' ↓', '');
      });
      this.innerHTML = this.textContent.replace(' ↑', '').replace(' ↓', '') + (sortDirection === 'asc' ? ' ↑' : ' ↓');

      renderSegmentationTable();
    });

    // Add hover effect
    th.style.cursor = 'pointer';
  });
}

// ============================================================================
// Info Panel Functions
// ============================================================================
function openInfoPanel(title, content) {
  document.getElementById('infoPanelTitle').textContent = title;
  document.getElementById('infoPanelContent').innerHTML = content;
  document.getElementById('infoPanel').classList.add('show');
  document.getElementById('infoPanelOverlay').classList.add('show');
}

function closeInfoPanel() {
  document.getElementById('infoPanel').classList.remove('show');
  document.getElementById('infoPanelOverlay').classList.remove('show');
}

// ============================================================================
// Methodology Details
// ============================================================================
function showMethodologyDetails(type) {
  let title = '';
  let content = '';

  switch(type) {
    case 'score':
      title = '🎯 Calcul du Score Client (0-100)';
      content = `
        <div style="color: var(--text); line-height: 1.8;">
          <p style="margin-bottom: 16px;">
            Le <strong>Score Client</strong> est une note sur 100 qui évalue la valeur et le potentiel d'un client.
            Il se calcule selon 4 critères pondérés :
          </p>

          <div style="background: rgba(99, 102, 241, 0.1); padding: 16px; border-radius: 10px; margin: 20px 0; border-left: 4px solid var(--accent);">
            <div style="font-weight: 700; color: var(--accent); margin-bottom: 12px; font-size: 16px;">
              Répartition des Points
            </div>

            <div style="margin-bottom: 12px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <span style="font-weight: 600;">1. Chiffre d'Affaires Total</span>
                <span style="color: var(--accent); font-weight: 700;">40 points max</span>
              </div>
              <div style="font-size: 13px; color: var(--text-muted); margin-left: 12px;">
                • 1 point par tranche de 2 500€ de CA<br>
                • Plafonné à 40 points (atteint à 100 000€)
              </div>
            </div>

            <div style="margin-bottom: 12px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <span style="font-weight: 600;">2. Tendance d'Évolution</span>
                <span style="color: var(--green); font-weight: 700;">30 points max</span>
              </div>
              <div style="font-size: 13px; color: var(--text-muted); margin-left: 12px;">
                • +30 pts : Croissance > +50%<br>
                • +20 pts : Croissance entre +20% et +50%<br>
                • +10 pts : Croissance entre 0% et +20%<br>
                • -10 pts : Décroissance > -20%
              </div>
            </div>

            <div style="margin-bottom: 12px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <span style="font-weight: 600;">3. Récence d'Activité</span>
                <span style="color: var(--blue); font-weight: 700;">20 points max</span>
              </div>
              <div style="font-size: 13px; color: var(--text-muted); margin-left: 12px;">
                • +20 pts : Dernier deal < 6 mois<br>
                • +10 pts : Dernier deal entre 6 et 12 mois<br>
                • 0 pt : Dernier deal > 12 mois
              </div>
            </div>

            <div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <span style="font-weight: 600;">4. Nombre de Deals</span>
                <span style="color: var(--purple); font-weight: 700;">10 points max</span>
              </div>
              <div style="font-size: 13px; color: var(--text-muted); margin-left: 12px;">
                • 2 points par deal<br>
                • Plafonné à 10 points (5+ deals)
              </div>
            </div>
          </div>

          <div style="background: rgba(34, 197, 94, 0.1); padding: 12px; border-radius: 8px; margin-top: 16px;">
            <div style="font-size: 13px; color: var(--text);">
              <strong>Exemple :</strong> Un client avec 80 000€ de CA (+32 pts), en croissance de +35% (+20 pts),
              deal récent il y a 4 mois (+20 pts), et 3 deals (+6 pts) = <strong>78/100</strong>
            </div>
          </div>
        </div>
      `;
      break;

    case 'tendance':
      title = '📈 Calcul de la Tendance d\'Activité';
      content = `
        <div style="color: var(--text); line-height: 1.8;">
          <p style="margin-bottom: 16px;">
            La <strong>Tendance</strong> mesure l'évolution de l'activité d'un client sur la période 2022-2025.
            Elle est exprimée en <strong>pourcentage (%)</strong>.
          </p>

          <div style="background: rgba(99, 102, 241, 0.1); padding: 16px; border-radius: 10px; margin: 20px 0; border-left: 4px solid var(--accent);">
            <div style="font-weight: 700; color: var(--accent); margin-bottom: 12px; font-size: 16px;">
              Méthode de Calcul
            </div>

            <div style="margin-bottom: 16px;">
              <div style="font-weight: 600; margin-bottom: 8px;">1️⃣ Identification des années actives</div>
              <div style="font-size: 13px; color: var(--text-muted); margin-left: 12px;">
                On identifie les années où le client a généré du CA (> 0€).
              </div>
            </div>

            <div style="margin-bottom: 16px;">
              <div style="font-weight: 600; margin-bottom: 8px;">2️⃣ Comparaison des 2 dernières années actives</div>
              <div style="font-size: 13px; color: var(--text-muted); margin-left: 12px;">
                On calcule la croissance entre les 2 dernières années où le client était actif.<br>
                <code style="background: var(--bg); padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                  Croissance = ((Dernière année - Année précédente) / Année précédente) × 100
                </code>
              </div>
            </div>

            <div style="margin-bottom: 16px;">
              <div style="font-weight: 600; margin-bottom: 8px;">3️⃣ Ajustement temporel</div>
              <div style="font-size: 13px; color: var(--text-muted); margin-left: 12px;">
                Si les années ne sont pas consécutives, la croissance est divisée par le nombre d'années d'écart.<br>
                <em>Exemple : +100% sur 2 ans = +50% de tendance annuelle</em>
              </div>
            </div>

            <div>
              <div style="font-weight: 600; margin-bottom: 8px;">4️⃣ Bonus de récence</div>
              <div style="font-size: 13px; color: var(--text-muted); margin-left: 12px;">
                • <strong>×1.2</strong> si dernière activité en 2024-2025 (client actif récemment)<br>
                • <strong>×0.8</strong> si dernière activité en 2022-2023 (client moins actif)
              </div>
            </div>
          </div>

          <div style="margin-top: 20px;">
            <div style="font-weight: 700; color: var(--accent); margin-bottom: 12px;">Interprétation</div>

            <div style="display: flex; align-items: center; margin-bottom: 8px;">
              <span style="color: var(--green); font-size: 20px; margin-right: 8px;">↗</span>
              <div>
                <strong style="color: var(--green);">Tendance Positive (> +10%)</strong><br>
                <span style="font-size: 13px; color: var(--text-muted);">Client en croissance, opportunités de développement</span>
              </div>
            </div>

            <div style="display: flex; align-items: center; margin-bottom: 8px;">
              <span style="color: var(--text-muted); font-size: 20px; margin-right: 8px;">→</span>
              <div>
                <strong>Tendance Stable (-10% à +10%)</strong><br>
                <span style="font-size: 13px; color: var(--text-muted);">Activité constante, relation à maintenir</span>
              </div>
            </div>

            <div style="display: flex; align-items: center;">
              <span style="color: var(--red); font-size: 20px; margin-right: 8px;">↘</span>
              <div>
                <strong style="color: var(--red);">Tendance Négative (< -10%)</strong><br>
                <span style="font-size: 13px; color: var(--text-muted);">Client en déclin, action corrective nécessaire</span>
              </div>
            </div>
          </div>

          <div style="background: rgba(34, 197, 94, 0.1); padding: 12px; border-radius: 8px; margin-top: 16px;">
            <div style="font-size: 13px; color: var(--text);">
              <strong>Exemple :</strong> Client avec 50 000€ en 2022, 0€ en 2023, 80 000€ en 2024<br>
              → Croissance brute = +60% sur 2 ans = +30%/an × 1.2 (récent) = <strong>+36%</strong>
            </div>
          </div>
        </div>
      `;
      break;

    case 'segments':
      title = '🏷️ Segments Clients - Définitions';
      content = `
        <div style="color: var(--text); line-height: 1.8;">
          <p style="margin-bottom: 20px;">
            Les clients sont automatiquement classés en <strong>5 segments</strong> selon leur CA moyen annuel et leur tendance d'évolution.
          </p>

          <div style="margin-bottom: 20px; padding: 16px; background: rgba(168, 85, 247, 0.1); border-radius: 10px; border-left: 4px solid var(--purple);">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
              <span class="badge stratégique" style="font-size: 14px;">Stratégique</span>
              <span style="color: var(--purple); font-weight: 700;">Priorité Maximum</span>
            </div>
            <div style="font-size: 14px; margin-bottom: 8px;"><strong>Critères :</strong></div>
            <div style="font-size: 13px; color: var(--text-muted); margin-left: 12px;">
              • CA moyen annuel > 100 000€<br>
              • Tendance positive (croissance > 0%)<br>
            </div>
            <div style="font-size: 14px; margin-top: 12px;"><strong>Actions recommandées :</strong></div>
            <div style="font-size: 13px; color: var(--text); margin-left: 12px;">
              • Revue trimestrielle obligatoire<br>
              • Opportunités de montée en gamme<br>
              • Programme VIP / Relation privilégiée
            </div>
          </div>

          <div style="margin-bottom: 20px; padding: 16px; background: rgba(34, 197, 94, 0.1); border-radius: 10px; border-left: 4px solid var(--green);">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
              <span class="badge clé" style="font-size: 14px;">Clé</span>
              <span style="color: var(--green); font-weight: 700;">Forte Valeur</span>
            </div>
            <div style="font-size: 14px; margin-bottom: 8px;"><strong>Critères :</strong></div>
            <div style="font-size: 13px; color: var(--text-muted); margin-left: 12px;">
              • CA moyen annuel > 50 000€<br>
              • Tendance stable ou légèrement négative (≥ -10%)<br>
            </div>
            <div style="font-size: 14px; margin-top: 12px;"><strong>Actions recommandées :</strong></div>
            <div style="font-size: 13px; color: var(--text); margin-left: 12px;">
              • Suivi régulier (mensuel/bimensuel)<br>
              • Opportunités de vente croisée<br>
              • Fidélisation et développement
            </div>
          </div>

          <div style="margin-bottom: 20px; padding: 16px; background: rgba(59, 130, 246, 0.1); border-radius: 10px; border-left: 4px solid var(--blue);">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
              <span class="badge régulier" style="font-size: 14px;">Régulier</span>
              <span style="color: var(--blue); font-weight: 700;">Socle Stable</span>
            </div>
            <div style="font-size: 14px; margin-bottom: 8px;"><strong>Critères :</strong></div>
            <div style="font-size: 13px; color: var(--text-muted); margin-left: 12px;">
              • CA moyen annuel > 10 000€<br>
              • Ne rentre dans aucune autre catégorie<br>
            </div>
            <div style="font-size: 14px; margin-top: 12px;"><strong>Actions recommandées :</strong></div>
            <div style="font-size: 13px; color: var(--text); margin-left: 12px;">
              • Maintenir la relation<br>
              • Contacts trimestriels<br>
              • Identifier opportunités d'upsell
            </div>
          </div>

          <div style="margin-bottom: 20px; padding: 16px; background: rgba(245, 158, 11, 0.1); border-radius: 10px; border-left: 4px solid var(--orange);">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
              <span class="badge à-risque" style="font-size: 14px;">À Risque</span>
              <span style="color: var(--orange); font-weight: 700;">⚠️ Action Urgente</span>
            </div>
            <div style="font-size: 14px; margin-bottom: 8px;"><strong>Critères :</strong></div>
            <div style="font-size: 13px; color: var(--text-muted); margin-left: 12px;">
              • Tendance fortement négative (< -20%)<br>
              • Peu importe le CA<br>
            </div>
            <div style="font-size: 14px; margin-top: 12px;"><strong>Actions recommandées :</strong></div>
            <div style="font-size: 13px; color: var(--text); margin-left: 12px;">
              • <strong>Plan de rétention immédiat</strong><br>
              • Identifier les causes de la baisse<br>
              • Rendez-vous prioritaire avec décideur
            </div>
          </div>

          <div style="padding: 16px; background: rgba(239, 68, 68, 0.1); border-radius: 10px; border-left: 4px solid var(--red);">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
              <span class="badge dormant" style="font-size: 14px;">Dormant</span>
              <span style="color: var(--red); font-weight: 700;">Inactif</span>
            </div>
            <div style="font-size: 14px; margin-bottom: 8px;"><strong>Critères :</strong></div>
            <div style="font-size: 13px; color: var(--text-muted); margin-left: 12px;">
              • Aucune activité en 2023 ET 2024<br>
              • Client historique inactif<br>
            </div>
            <div style="font-size: 14px; margin-top: 12px;"><strong>Actions recommandées :</strong></div>
            <div style="font-size: 13px; color: var(--text); margin-left: 12px;">
              • Campagne de réactivation ciblée<br>
              • Enquête de satisfaction / feedback<br>
              • Offre de reconquête
            </div>
          </div>
        </div>
      `;
      break;

    case 'priorites':
      title = '⚡ Niveaux de Priorité';
      content = `
        <div style="color: var(--text); line-height: 1.8;">
          <p style="margin-bottom: 20px;">
            Les <strong>niveaux de priorité</strong> sont déterminés automatiquement en fonction du <strong>Score Client</strong>.
            Ils permettent de prioriser vos actions et votre temps.
          </p>

          <div style="margin-bottom: 20px; padding: 20px; background: rgba(239, 68, 68, 0.1); border-radius: 10px; border-left: 4px solid var(--red);">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <span style="font-size: 24px;">🔴</span>
              <div>
                <div style="font-weight: 700; font-size: 16px; color: var(--red);">HAUTE PRIORITÉ</div>
                <div style="font-size: 13px; color: var(--text-muted);">Score > 70/100</div>
              </div>
            </div>
            <div style="font-size: 14px; margin-top: 12px;">
              <strong>Qui :</strong> Clients stratégiques à forte valeur et fort potentiel<br>
              <strong>Action :</strong> Dédier 60-70% de votre temps à ces clients<br>
              <strong>Fréquence :</strong> Contact hebdomadaire ou bimensuel
            </div>
          </div>

          <div style="margin-bottom: 20px; padding: 20px; background: rgba(245, 158, 11, 0.1); border-radius: 10px; border-left: 4px solid var(--orange);">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <span style="font-size: 24px;">🟠</span>
              <div>
                <div style="font-weight: 700; font-size: 16px; color: var(--orange);">PRIORITÉ MOYENNE</div>
                <div style="font-size: 13px; color: var(--text-muted);">Score entre 40 et 70/100</div>
              </div>
            </div>
            <div style="font-size: 14px; margin-top: 12px;">
              <strong>Qui :</strong> Clients avec potentiel de développement<br>
              <strong>Action :</strong> 20-30% de votre temps, opportunités d'upsell<br>
              <strong>Fréquence :</strong> Contact mensuel ou trimestriel
            </div>
          </div>

          <div style="padding: 20px; background: rgba(59, 130, 246, 0.1); border-radius: 10px; border-left: 4px solid var(--blue);">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <span style="font-size: 24px;">🔵</span>
              <div>
                <div style="font-weight: 700; font-size: 16px; color: var(--blue);">PRIORITÉ BASSE</div>
                <div style="font-size: 13px; color: var(--text-muted);">Score < 40/100</div>
              </div>
            </div>
            <div style="font-size: 14px; margin-top: 12px;">
              <strong>Qui :</strong> Petits comptes ou clients en perte de vitesse<br>
              <strong>Action :</strong> 10% de votre temps, maintien de la relation<br>
              <strong>Fréquence :</strong> Contact trimestriel ou semestriel
            </div>
          </div>

          <div style="background: rgba(99, 102, 241, 0.1); padding: 16px; border-radius: 8px; margin-top: 20px;">
            <div style="font-size: 13px; color: var(--text);">
              <strong>💡 Astuce :</strong> Utilisez le filtre par année pour affiner votre priorité selon l'activité récente.
              Un client Haute Priorité globalement mais inactif en 2024 mérite une attention particulière (réactivation).
            </div>
          </div>
        </div>
      `;
      break;

    case 'recommandations':
      title = '💡 Actions Recommandées';
      content = `
        <div style="color: var(--text); line-height: 1.8;">
          <p style="margin-bottom: 20px;">
            Pour chaque client, le dashboard génère automatiquement une <strong>recommandation d'action</strong>
            basée sur son segment. Voici le détail de chaque recommandation :
          </p>

          <div style="margin-bottom: 16px; padding: 14px; background: var(--bg-card); border-radius: 8px; border-left: 3px solid var(--purple);">
            <div style="font-weight: 700; margin-bottom: 6px; color: var(--purple);">
              📅 Revue trimestrielle + Montée en gamme
            </div>
            <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">
              <strong>Pour :</strong> Clients Stratégiques
            </div>
            <div style="font-size: 14px;">
              • Organiser un point stratégique tous les 3 mois<br>
              • Présenter des solutions premium ou services additionnels<br>
              • Anticiper les besoins futurs et projets à venir<br>
              • Renforcer la relation avec les décideurs clés
            </div>
          </div>

          <div style="margin-bottom: 16px; padding: 14px; background: var(--bg-card); border-radius: 8px; border-left: 3px solid var(--green);">
            <div style="font-weight: 700; margin-bottom: 6px; color: var(--green);">
              🤝 Suivi régulier + Vente croisée
            </div>
            <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">
              <strong>Pour :</strong> Clients Clés
            </div>
            <div style="font-size: 14px;">
              • Maintenir un contact mensuel ou bimensuel<br>
              • Identifier les opportunités de cross-sell<br>
              • Proposer des produits/services complémentaires<br>
              • S'assurer de la satisfaction continue
            </div>
          </div>

          <div style="margin-bottom: 16px; padding: 14px; background: var(--bg-card); border-radius: 8px; border-left: 3px solid var(--orange);">
            <div style="font-weight: 700; margin-bottom: 6px; color: var(--orange);">
              🚨 URGENT : Plan de rétention
            </div>
            <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">
              <strong>Pour :</strong> Clients À Risque
            </div>
            <div style="font-size: 14px;">
              • <strong>Contact immédiat</strong> avec le décideur<br>
              • Enquête de satisfaction pour identifier les problèmes<br>
              • Proposer des solutions correctives rapides<br>
              • Offre de fidélisation si nécessaire<br>
              • Escalade interne si menace de churn
            </div>
          </div>

          <div style="margin-bottom: 16px; padding: 14px; background: var(--bg-card); border-radius: 8px; border-left: 3px solid var(--red);">
            <div style="font-weight: 700; margin-bottom: 6px; color: var(--red);">
              🔄 Campagne de réactivation
            </div>
            <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">
              <strong>Pour :</strong> Clients Dormants
            </div>
            <div style="font-size: 14px;">
              • Email ou appel de reconquête personnalisé<br>
              • Enquête : pourquoi ont-ils arrêté ?<br>
              • Offre spéciale de retour (promotion, essai gratuit)<br>
              • Présenter les nouveautés depuis leur départ
            </div>
          </div>

          <div style="padding: 14px; background: var(--bg-card); border-radius: 8px; border-left: 3px solid var(--blue);">
            <div style="font-weight: 700; margin-bottom: 6px; color: var(--blue);">
              ✅ Maintenir la relation
            </div>
            <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">
              <strong>Pour :</strong> Clients Réguliers
            </div>
            <div style="font-size: 14px;">
              • Contact trimestriel pour garder le lien<br>
              • Newsletter, invitations événements<br>
              • Rester disponible pour futurs besoins<br>
              • Identifier opportunités d'évolution vers segment supérieur
            </div>
          </div>

          <div style="background: rgba(99, 102, 241, 0.1); padding: 16px; border-radius: 8px; margin-top: 20px;">
            <div style="font-size: 13px; color: var(--text);">
              <strong>⚙️ Automatisation :</strong> Ces recommandations peuvent servir de base pour créer des workflows
              automatisés dans votre CRM (rappels, emails, tâches).
            </div>
          </div>
        </div>
      `;
      break;

    case 'kpis':
      title = '📊 KPIs Principaux - Définitions';
      content = `
        <div style="color: var(--text); line-height: 1.8;">
          <p style="margin-bottom: 20px;">
            Les <strong>6 KPIs principaux</strong> affichés en haut du dashboard vous donnent une vue d'ensemble instantanée
            de votre portefeuille clients. Voici leur définition :
          </p>

          <div style="margin-bottom: 16px; padding: 14px; background: var(--bg-card); border-radius: 8px;">
            <div style="font-weight: 700; margin-bottom: 6px; font-size: 15px;">
              💰 CA Total
            </div>
            <div style="font-size: 14px; color: var(--text-muted);">
              <strong>Définition :</strong> Somme de tous les deals "Fermé gagné" sur la période 2022-2025<br>
              <strong>Usage :</strong> Vision globale de la performance commerciale<br>
              <strong>Cliquez dessus</strong> pour voir la répartition par année
            </div>
          </div>

          <div style="margin-bottom: 16px; padding: 14px; background: var(--bg-card); border-radius: 8px;">
            <div style="font-weight: 700; margin-bottom: 6px; font-size: 15px;">
              📈 CA 2024
            </div>
            <div style="font-size: 14px; color: var(--text-muted);">
              <strong>Définition :</strong> Total des deals fermés en 2024 avec % de croissance vs 2023<br>
              <strong>Usage :</strong> Mesurer la performance de l'année en cours<br>
              <strong>Cliquez dessus</strong> pour voir le top 5 clients 2024
            </div>
          </div>

          <div style="margin-bottom: 16px; padding: 14px; background: var(--bg-card); border-radius: 8px;">
            <div style="font-weight: 700; margin-bottom: 6px; font-size: 15px;">
              👥 Nombre de Clients
            </div>
            <div style="font-size: 14px; color: var(--text-muted);">
              <strong>Définition :</strong> Nombre d'entreprises uniques ayant au moins 1 deal fermé gagné<br>
              <strong>Usage :</strong> Taille et diversification du portefeuille<br>
              <strong>Cliquez dessus</strong> pour voir la répartition par segment
            </div>
          </div>

          <div style="margin-bottom: 16px; padding: 14px; background: var(--bg-card); border-radius: 8px;">
            <div style="font-weight: 700; margin-bottom: 6px; font-size: 15px;">
              🎯 Ticket Moyen
            </div>
            <div style="font-size: 14px; color: var(--text-muted);">
              <strong>Définition :</strong> CA Total ÷ Nombre total de deals<br>
              <strong>Formule :</strong> Montant moyen d'une transaction<br>
              <strong>Usage :</strong> Évaluer la taille moyenne de vos contrats<br>
              <strong>Cliquez dessus</strong> pour voir l'évolution par année
            </div>
          </div>

          <div style="margin-bottom: 16px; padding: 14px; background: var(--bg-card); border-radius: 8px;">
            <div style="font-weight: 700; margin-bottom: 6px; font-size: 15px; color: var(--purple);">
              ⭐ Clients Stratégiques
            </div>
            <div style="font-size: 14px; color: var(--text-muted);">
              <strong>Définition :</strong> Nombre de clients avec segment "Stratégique"<br>
              <strong>Critère :</strong> CA annuel moyen > 100 000€ + croissance positive<br>
              <strong>Usage :</strong> Identifier vos champions à chouchouter<br>
              <strong>Cliquez dessus</strong> pour voir la liste complète
            </div>
          </div>

          <div style="padding: 14px; background: var(--bg-card); border-radius: 8px;">
            <div style="font-weight: 700; margin-bottom: 6px; font-size: 15px; color: var(--orange);">
              ⚠️ Clients à Risque
            </div>
            <div style="font-size: 14px; color: var(--text-muted);">
              <strong>Définition :</strong> Nombre de clients avec segment "À Risque"<br>
              <strong>Critère :</strong> Tendance < -20% (forte baisse d'activité)<br>
              <strong>Usage :</strong> Alertes pour actions urgentes de rétention<br>
              <strong>Cliquez dessus</strong> pour voir qui contacter en priorité
            </div>
          </div>

          <div style="background: rgba(34, 197, 94, 0.1); padding: 16px; border-radius: 8px; margin-top: 20px;">
            <div style="font-size: 13px; color: var(--text);">
              <strong>💡 Astuce :</strong> Tous les KPIs sont cliquables ! Cliquez dessus pour obtenir des détails
              et des analyses approfondies de chaque métrique.
            </div>
          </div>
        </div>
      `;
      break;
  }

  openInfoPanel(title, content);
}

// ============================================================================
// Helpers
// ============================================================================
function formatCurrency(value, short = false) {
  if (short && value >= 1000000) {
    return (value / 1000000).toFixed(1) + 'M€';
  }
  if (short && value >= 1000) {
    return (value / 1000).toFixed(0) + 'k€';
  }
  return new Intl.NumberFormat('fr-FR', {
    style: 'currency',
    currency: 'EUR',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0
  }).format(value);
}

function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
  const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
  return {
    x: centerX + (radius * Math.cos(angleInRadians)),
    y: centerY + (radius * Math.sin(angleInRadians))
  };
}

function describeArc(x, y, radius, innerRadius, startAngle, endAngle) {
  const start = polarToCartesian(x, y, radius, endAngle);
  const end = polarToCartesian(x, y, radius, startAngle);
  const innerStart = polarToCartesian(x, y, innerRadius, endAngle);
  const innerEnd = polarToCartesian(x, y, innerRadius, startAngle);

  const largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";

  const d = [
    "M", start.x, start.y,
    "A", radius, radius, 0, largeArcFlag, 0, end.x, end.y,
    "L", innerEnd.x, innerEnd.y,
    "A", innerRadius, innerRadius, 0, largeArcFlag, 1, innerStart.x, innerStart.y,
    "Z"
  ].join(" ");

  return d;
}
</script>
</body>
</html>
