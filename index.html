<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<title>Dashboard Account Manager PRO</title>
<style>
:root {
  --bg: #0a0e27;
  --bg-card: #151932;
  --bg-card-hover: #1d2342;
  --text: #f1f5f9;
  --text-muted: #94a3b8;
  --accent: #6366f1;
  --accent-light: #818cf8;
  --green: #22c55e;
  --green-light: #4ade80;
  --red: #ef4444;
  --red-light: #f87171;
  --orange: #f59e0b;
  --yellow: #eab308;
  --blue: #3b82f6;
  --purple: #a855f7;
  --border: #1e293b;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: linear-gradient(135deg, var(--bg) 0%, #0f1629 100%);
  color: var(--text);
  min-height: 100vh;
  padding: 20px;
}

.container {
  max-width: 1800px;
  margin: 0 auto;
}

/* ===== HEADER ===== */
.header {
  background: linear-gradient(135deg, var(--accent) 0%, var(--purple) 100%);
  border-radius: 16px;
  padding: 28px;
  margin-bottom: 24px;
  box-shadow: 0 20px 60px rgba(99, 102, 241, 0.4);
}

.header h1 {
  font-size: 32px;
  font-weight: 800;
  margin-bottom: 8px;
  color: white;
  text-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

.header p {
  color: rgba(255,255,255,0.95);
  font-size: 16px;
}

/* ===== KPI CARDS ===== */
.kpi-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 20px;
  margin-bottom: 32px;
}

.kpi-card {
  background: var(--bg-card);
  border-radius: 12px;
  padding: 24px;
  border: 1px solid var(--border);
  transition: all 0.3s ease;
}

.kpi-card:hover {
  border-color: var(--accent);
  transform: translateY(-4px);
  box-shadow: 0 12px 24px rgba(0,0,0,0.3);
}

.kpi-label {
  color: var(--text-muted);
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
}

.kpi-value {
  font-size: 32px;
  font-weight: 800;
  color: var(--text);
  margin-bottom: 4px;
}

.kpi-trend {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-muted);
}

.kpi-trend.up { color: var(--green); }
.kpi-trend.down { color: var(--red); }

/* ===== SECTIONS ===== */
.section {
  background: var(--bg-card);
  border-radius: 12px;
  padding: 28px;
  margin-bottom: 24px;
  border: 1px solid var(--border);
}

.section h2 {
  font-size: 22px;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 8px;
}

/* ===== FILTERS ===== */
.filters-row {
  display: flex;
  gap: 24px;
  flex-wrap: wrap;
  margin-bottom: 24px;
}

.filter-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.filter-group label {
  color: var(--text-muted);
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.segment-filters, .year-filters {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.segment-chip, .year-chip {
  padding: 8px 16px;
  background: var(--bg);
  border: 2px solid var(--border);
  border-radius: 20px;
  color: var(--text-muted);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.segment-chip:hover, .year-chip:hover {
  border-color: var(--accent);
  background: var(--bg-card-hover);
}

.segment-chip.active, .year-chip.active {
  background: linear-gradient(135deg, var(--accent) 0%, var(--purple) 100%);
  border-color: var(--accent);
  color: white;
  box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
}

.filter-input {
  padding: 10px 16px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text);
  font-size: 14px;
  min-width: 200px;
}

.filter-input:focus {
  outline: none;
  border-color: var(--accent);
}

/* ===== TABLE ===== */
table {
  width: 100%;
  border-collapse: collapse;
  min-width: 1600px;
}

thead {
  background: var(--bg);
  position: sticky;
  top: 0;
  z-index: 10;
}

th {
  padding: 14px 12px;
  text-align: left;
  font-size: 11px;
  font-weight: 700;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border-bottom: 2px solid var(--border);
  cursor: pointer;
  white-space: nowrap;
}

th:hover {
  color: var(--accent-light);
}

tbody tr {
  border-bottom: 1px solid var(--border);
  transition: all 0.2s ease;
}

tbody tr:hover {
  background: var(--bg-card-hover);
}

td {
  padding: 16px 12px;
  font-size: 14px;
  color: var(--text);
  white-space: nowrap;
}

.client-name {
  font-weight: 600;
  color: var(--accent-light);
  cursor: pointer;
}

.client-name:hover {
  text-decoration: underline;
}

.segment-badge {
  display: inline-block;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.health-score {
  font-weight: 700;
  font-size: 16px;
}

.trend-indicator {
  font-size: 18px;
}

.year-column {
  text-align: right;
}

.year-value {
  font-weight: 600;
}

.year-column.hidden {
  display: none;
}

/* ===== MODAL ===== */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.8);
  backdrop-filter: blur(4px);
}

.modal.active {
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-content {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 32px;
  max-width: 900px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}

.modal-header {
  background: linear-gradient(135deg, var(--accent) 0%, var(--purple) 100%);
  border-radius: 12px;
  padding: 24px;
  margin-bottom: 24px;
}

.modal-header h2 {
  font-size: 28px;
  font-weight: 800;
  color: white;
  margin-bottom: 8px;
}

.modal-meta {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
  color: rgba(255,255,255,0.9);
  font-size: 14px;
}

.close-modal {
  position: absolute;
  top: 16px;
  right: 16px;
  font-size: 32px;
  font-weight: 700;
  color: var(--text-muted);
  cursor: pointer;
  transition: all 0.3s ease;
}

.close-modal:hover {
  color: var(--accent-light);
}

.note-field {
  margin-bottom: 20px;
}

.note-field-label {
  color: var(--accent-light);
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 6px;
}

.note-field-value {
  color: var(--text);
  font-size: 15px;
  line-height: 1.6;
}

.contacts-list {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.contact-badge {
  background: var(--bg);
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 600;
  color: var(--accent-light);
  border: 1px solid var(--border);
}

.typologie-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.typologie-item {
  display: flex;
  align-items: flex-start;
  gap: 8px;
  color: var(--text);
  font-size: 14px;
  line-height: 1.5;
}

.typologie-item::before {
  content: "•";
  color: var(--accent);
  font-weight: 700;
  font-size: 18px;
}

.revenue-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 16px;
  margin-top: 16px;
}

.revenue-item {
  text-align: center;
  background: var(--bg);
  padding: 16px;
  border-radius: 8px;
  border: 1px solid var(--border);
}

.revenue-year {
  color: var(--text-muted);
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  margin-bottom: 8px;
}

.revenue-amount {
  font-size: 20px;
  font-weight: 700;
  color: var(--text);
}

/* ===== STATS GRID ===== */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-top: 20px;
}

.stat-card {
  background: var(--bg);
  padding: 20px;
  border-radius: 8px;
  border: 1px solid var(--border);
}

.stat-label {
  color: var(--text-muted);
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
}

.stat-value {
  font-size: 24px;
  font-weight: 700;
  color: var(--text);
}

/* ===== UTILITIES ===== */
.mb-2 { margin-bottom: 16px; }
.mb-3 { margin-bottom: 24px; }
.text-muted { color: var(--text-muted); }
.hidden { display: none !important; }
</style>
</head>
<body>

<div class="container">
  <!-- HEADER -->
  <div class="header">
    <h1>📊 Dashboard Account Manager PRO</h1>
    <p>Analyse complète et détaillée de votre portefeuille clients avec toutes les données enrichies HubSpot</p>
  </div>

  <!-- KPIs GLOBAUX -->
  <div class="kpi-grid" id="kpi-grid">
    <div class="kpi-card">
      <div class="kpi-label">CA Total</div>
      <div class="kpi-value" id="kpi-ca-total">0 €</div>
      <div class="kpi-trend"></div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Nombre de Clients</div>
      <div class="kpi-value" id="kpi-nb-clients">0</div>
      <div class="kpi-trend"></div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Health Score Moyen</div>
      <div class="kpi-value" id="kpi-health-avg">0</div>
      <div class="kpi-trend"></div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Clients Stratégiques</div>
      <div class="kpi-value" id="kpi-strategiques">0</div>
      <div class="kpi-trend"></div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Clients À Risque</div>
      <div class="kpi-value" id="kpi-risque">0</div>
      <div class="kpi-trend"></div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Clients Dormants</div>
      <div class="kpi-value" id="kpi-dormants">0</div>
      <div class="kpi-trend"></div>
    </div>
  </div>

  <!-- STATISTIQUES DÉTAILLÉES -->
  <div class="section">
    <h2>📈 Statistiques Détaillées</h2>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total Notes</div>
        <div class="stat-value" id="stat-total-notes">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Emails</div>
        <div class="stat-value" id="stat-total-emails">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Calls</div>
        <div class="stat-value" id="stat-total-calls">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Meetings</div>
        <div class="stat-value" id="stat-total-meetings">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">CA 2022</div>
        <div class="stat-value" id="stat-ca-2022">0 €</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">CA 2023</div>
        <div class="stat-value" id="stat-ca-2023">0 €</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">CA 2024</div>
        <div class="stat-value" id="stat-ca-2024">0 €</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">CA 2025</div>
        <div class="stat-value" id="stat-ca-2025">0 €</div>
      </div>
    </div>
  </div>

  <!-- PORTFOLIO CLIENTS COMPLET -->
  <div class="section">
    <h2>👥 Portfolio Clients Complet</h2>

    <!-- Filtres -->
    <div class="filters-row">
      <div class="filter-group">
        <label>Filtrer par Segment</label>
        <div class="segment-filters" id="segment-filters">
          <div class="segment-chip active" data-segment="">Tous</div>
          <div class="segment-chip" data-segment="Stratégique">Stratégique</div>
          <div class="segment-chip" data-segment="Clé">Clé</div>
          <div class="segment-chip" data-segment="Régulier">Régulier</div>
          <div class="segment-chip" data-segment="À Risque">À Risque</div>
          <div class="segment-chip" data-segment="Dormant">Dormant</div>
          <div class="segment-chip" data-segment="Prospect">Prospect</div>
        </div>
      </div>

      <div class="filter-group">
        <label>Afficher les Années</label>
        <div class="year-filters" id="year-filters">
          <div class="year-chip" data-year="2022">2022</div>
          <div class="year-chip" data-year="2023">2023</div>
          <div class="year-chip" data-year="2024">2024</div>
          <div class="year-chip active" data-year="2025">2025</div>
        </div>
      </div>

      <div class="filter-group">
        <label>Rechercher un Client</label>
        <input type="text" class="filter-input" id="filter-search" placeholder="Tapez pour rechercher...">
      </div>
    </div>

    <!-- Table -->
    <div style="overflow-x: auto;">
      <table id="portfolioTable">
        <thead>
          <tr>
            <th>Rang</th>
            <th>Client</th>
            <th>Segment</th>
            <th>Health Score</th>
            <th>CA Total</th>
            <th class="year-column year-2022">2022</th>
            <th class="year-column year-2023">2023</th>
            <th class="year-column year-2024">2024</th>
            <th class="year-column year-2025">2025</th>
            <th>Tendance</th>
            <th>Notes</th>
            <th>Sentiment</th>
            <th>Emails</th>
            <th>Calls</th>
            <th>Meetings</th>
            <th>Contacts</th>
            <th>Owner</th>
            <th>Industrie</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- MODAL FICHE CLIENT -->
<div id="clientModal" class="modal">
  <div class="modal-content">
    <span class="close-modal" onclick="closeClientModal()">&times;</span>

    <div class="modal-header" id="modal-header">
      <!-- Rempli dynamiquement -->
    </div>

    <div class="section" id="modal-notes">
      <h2>📝 Notes et Relation Client</h2>
      <!-- Rempli dynamiquement -->
    </div>

    <div class="section" id="modal-revenue">
      <h2>💰 Chiffre d'Affaires Détaillé</h2>
      <!-- Rempli dynamiquement -->
    </div>

    <div class="section" id="modal-engagement">
      <h2>📊 Engagement et Activité</h2>
      <!-- Rempli dynamiquement -->
    </div>
  </div>
</div>

<script>
// ============================================================================
// GLOBAL STATE
// ============================================================================
let dealsData = [];
let clientsData = [];
let currentSegmentFilter = '';
let visibleYears = ['2025'];

// ============================================================================
// DATA LOADING
// ============================================================================
async function loadHubSpotData() {
  try {
    console.log('🔄 Chargement des données HubSpot...');
    const response = await fetch('data.json');

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }

    const result = await response.json();

    if (!result.success || !result.data) {
      throw new Error('Format de données invalide');
    }

    dealsData = result.data;
    console.log(`✅ ${dealsData.length} deals chargés`);

    processData();
    renderAll();

  } catch (error) {
    console.error('❌ Erreur:', error);
    document.getElementById('kpi-grid').innerHTML = `
      <div class="kpi-card" style="grid-column: 1/-1;">
        <p style="color: var(--red);">
          ⚠️ Impossible de charger les données. Vérifie que le workflow GitHub Actions s'est exécuté.
        </p>
      </div>`;
  }
}

// ============================================================================
// DATA PROCESSING
// ============================================================================
function parseNoteContent(htmlContent) {
  if (!htmlContent) return null;

  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = htmlContent;
  const text = tempDiv.textContent || tempDiv.innerText;

  const parsed = {
    relation: null,
    intro: null,
    historique: null,
    ca: null,
    bu: null,
    contacts: [],
    typologie: [],
    potentiel: null,
    raw: text
  };

  const relationMatch = text.match(/Relation\s*:\s*([^\n]+)/i);
  if (relationMatch) parsed.relation = relationMatch[1].trim();

  const introMatch = text.match(/Intro\s*:\s*([^\n]+(?:\n(?!.*:)[^\n]+)*)/i);
  if (introMatch) parsed.intro = introMatch[1].trim();

  const historiqueMatch = text.match(/Historique\s*:\s*([^\n]+(?:\n(?!.*:)[^\n]+)*)/i);
  if (historiqueMatch) parsed.historique = historiqueMatch[1].trim();

  const caMatch = text.match(/CA\s*:\s*([^\n]+)/i);
  if (caMatch) parsed.ca = caMatch[1].trim();

  const buMatch = text.match(/BU\s*(?:concerné|concernée)?\s*:\s*([^\n]+)/i);
  if (buMatch) parsed.bu = buMatch[1].trim();

  const contactMatch = text.match(/Contact[s]?\s*:\s*([^\n]+)/i);
  if (contactMatch) {
    const contactsStr = contactMatch[1].trim();
    parsed.contacts = contactsStr.split(/[\/,]|(?:\s+et\s+)/)
      .map(c => c.trim())
      .filter(c => c.length > 0);
  }

  const typologieMatch = text.match(/Typologie\s*(?:des\s*sujets)?\s*:(.*?)(?=Potentiel|$)/si);
  if (typologieMatch) {
    const typologieText = typologieMatch[1];
    const bullets = typologieText.match(/[-•]\s*([^\n]+)/g);
    if (bullets) {
      parsed.typologie = bullets.map(b => b.replace(/^[-•]\s*/, '').trim());
    }
  }

  const potentielMatch = text.match(/Potentiel\s*(?:Développement|de\s*développement)?\s*:(.*?)$/si);
  if (potentielMatch) parsed.potentiel = potentielMatch[1].trim();

  return parsed;
}

function processData() {
  const clientStats = {};

  dealsData.forEach(deal => {
    const companyName = deal.companyName || 'Inconnu';
    const montant = parseFloat(deal.amount) || 0;
    const year = deal.year || new Date(deal.closeDate || deal.createDate).getFullYear();

    const notesData = parseNoteContent(deal.latestNoteBody);

    if (!clientStats[companyName]) {
      clientStats[companyName] = {
        name: companyName,
        companyId: deal.companyId,
        domain: deal.companyDomain,
        industry: deal.companyIndustry,
        totalRevenue: 0,
        years: { '2022': 0, '2023': 0, '2024': 0, '2025': 0 },
        deals: [],
        dealCount: 0,
        lastDealDate: null,
        avgHealthScore: 0,
        healthScores: [],
        segment: deal.segment || 'Régulier',
        segmentColor: deal.segmentColor || '#2ecc71',
        segmentReason: deal.segmentReason || '',
        totalNotes: deal.totalNotes || 0,
        notesSentiment: deal.notesSentiment || 'neutral',
        engagementEmails: deal.engagementEmails || 0,
        engagementCalls: deal.engagementCalls || 0,
        engagementMeetings: deal.engagementMeetings || 0,
        latestNoteBody: deal.latestNoteBody || '',
        latestNoteDate: deal.latestNoteDate || '',
        owner: deal.ownerName || 'Non assigné',
        notesStructured: notesData || {}
      };
    }

    if (notesData && !clientStats[companyName].notesStructured.contacts?.length) {
      clientStats[companyName].notesStructured = notesData;
    }

    clientStats[companyName].totalRevenue += montant;
    if (clientStats[companyName].years[year] !== undefined) {
      clientStats[companyName].years[year] += montant;
    }
    clientStats[companyName].deals.push({
      year,
      montant,
      closeDate: deal.closeDate,
      dealName: deal.dealName,
      healthScore: deal.healthScore
    });
    clientStats[companyName].dealCount++;
    clientStats[companyName].healthScores.push(deal.healthScore || 0);

    if (deal.closeDate) {
      const date = new Date(deal.closeDate);
      if (!clientStats[companyName].lastDealDate || date > clientStats[companyName].lastDealDate) {
        clientStats[companyName].lastDealDate = date;
      }
    }
  });

  clientsData = Object.values(clientStats).map(client => {
    client.avgHealthScore = client.healthScores.length > 0
      ? Math.round(client.healthScores.reduce((a, b) => a + b, 0) / client.healthScores.length)
      : 0;

    const years = [2022, 2023, 2024, 2025];
    const revenueByYear = years.map(y => client.years[y.toString()] || 0);
    const nonZeroRevenue = revenueByYear.filter(r => r > 0);

    if (nonZeroRevenue.length >= 2) {
      const last = nonZeroRevenue[nonZeroRevenue.length - 1];
      const prev = nonZeroRevenue[nonZeroRevenue.length - 2];
      const change = ((last - prev) / prev) * 100;

      if (change > 10) client.trend = 'up';
      else if (change < -10) client.trend = 'down';
      else client.trend = 'stable';
    } else {
      client.trend = 'neutral';
    }

    return client;
  });

  clientsData.sort((a, b) => b.totalRevenue - a.totalRevenue);

  console.log(`✅ ${clientsData.length} clients traités`);
}

// ============================================================================
// RENDER ALL
// ============================================================================
function renderAll() {
  renderKPIs();
  renderStats();
  renderPortfolio();
  initFilters();
}

function renderKPIs() {
  const totalCA = clientsData.reduce((sum, c) => sum + c.totalRevenue, 0);
  const nbClients = clientsData.length;
  const avgHealth = Math.round(clientsData.reduce((sum, c) => sum + c.avgHealthScore, 0) / nbClients);
  const strategiques = clientsData.filter(c => c.segment === 'Stratégique').length;
  const risque = clientsData.filter(c => c.segment === 'À Risque').length;
  const dormants = clientsData.filter(c => c.segment === 'Dormant').length;

  document.getElementById('kpi-ca-total').textContent = formatCurrency(totalCA);
  document.getElementById('kpi-nb-clients').textContent = nbClients;
  document.getElementById('kpi-health-avg').textContent = avgHealth;
  document.getElementById('kpi-strategiques').textContent = strategiques;
  document.getElementById('kpi-risque').textContent = risque;
  document.getElementById('kpi-dormants').textContent = dormants;
}

function renderStats() {
  const totalNotes = clientsData.reduce((sum, c) => sum + c.totalNotes, 0);
  const totalEmails = clientsData.reduce((sum, c) => sum + c.engagementEmails, 0);
  const totalCalls = clientsData.reduce((sum, c) => sum + c.engagementCalls, 0);
  const totalMeetings = clientsData.reduce((sum, c) => sum + c.engagementMeetings, 0);
  const ca2022 = clientsData.reduce((sum, c) => sum + (c.years['2022'] || 0), 0);
  const ca2023 = clientsData.reduce((sum, c) => sum + (c.years['2023'] || 0), 0);
  const ca2024 = clientsData.reduce((sum, c) => sum + (c.years['2024'] || 0), 0);
  const ca2025 = clientsData.reduce((sum, c) => sum + (c.years['2025'] || 0), 0);

  document.getElementById('stat-total-notes').textContent = totalNotes;
  document.getElementById('stat-total-emails').textContent = totalEmails;
  document.getElementById('stat-total-calls').textContent = totalCalls;
  document.getElementById('stat-total-meetings').textContent = totalMeetings;
  document.getElementById('stat-ca-2022').textContent = formatCurrency(ca2022);
  document.getElementById('stat-ca-2023').textContent = formatCurrency(ca2023);
  document.getElementById('stat-ca-2024').textContent = formatCurrency(ca2024);
  document.getElementById('stat-ca-2025').textContent = formatCurrency(ca2025);
}

function renderPortfolio() {
  const tbody = document.querySelector('#portfolioTable tbody');

  let filteredClients = [...clientsData];

  if (currentSegmentFilter) {
    filteredClients = filteredClients.filter(c => c.segment === currentSegmentFilter);
  }

  const searchFilter = document.getElementById('filter-search').value.toLowerCase();
  if (searchFilter) {
    filteredClients = filteredClients.filter(c =>
      c.name.toLowerCase().includes(searchFilter)
    );
  }

  tbody.innerHTML = filteredClients.map((client, idx) => {
    const contacts = client.notesStructured?.contacts || [];
    const contactsDisplay = contacts.length > 0
      ? contacts.slice(0, 2).join(', ') + (contacts.length > 2 ? ` +${contacts.length - 2}` : '')
      : '-';

    return `
      <tr>
        <td>${idx + 1}</td>
        <td class="client-name" onclick="openClientModal('${escapeHtml(client.name)}')">${escapeHtml(client.name)}</td>
        <td><span class="segment-badge" style="background: ${client.segmentColor}20; color: ${client.segmentColor};">${client.segment}</span></td>
        <td><span class="health-score" style="color: ${getHealthColor(client.avgHealthScore)}">${client.avgHealthScore}</span></td>
        <td class="year-value">${formatCurrency(client.totalRevenue)}</td>
        <td class="year-column year-2022 year-value">${formatCurrency(client.years['2022'])}</td>
        <td class="year-column year-2023 year-value">${formatCurrency(client.years['2023'])}</td>
        <td class="year-column year-2024 year-value">${formatCurrency(client.years['2024'])}</td>
        <td class="year-column year-2025 year-value">${formatCurrency(client.years['2025'])}</td>
        <td class="trend-indicator">${getTrendIcon(client.trend)}</td>
        <td>${client.totalNotes}</td>
        <td>${getSentimentEmoji(client.notesSentiment)}</td>
        <td>${client.engagementEmails}</td>
        <td>${client.engagementCalls}</td>
        <td>${client.engagementMeetings}</td>
        <td>${contactsDisplay}</td>
        <td>${client.owner}</td>
        <td>${client.industry || '-'}</td>
      </tr>
    `;
  }).join('');
}

// ============================================================================
// FILTERS
// ============================================================================
function initFilters() {
  document.querySelectorAll('.segment-chip').forEach(chip => {
    chip.addEventListener('click', () => {
      document.querySelectorAll('.segment-chip').forEach(c => c.classList.remove('active'));
      chip.classList.add('active');
      currentSegmentFilter = chip.dataset.segment;
      renderPortfolio();
    });
  });

  document.querySelectorAll('.year-chip').forEach(chip => {
    chip.addEventListener('click', () => {
      chip.classList.toggle('active');
      const year = chip.dataset.year;
      const cols = document.querySelectorAll(`.year-${year}`);

      if (chip.classList.contains('active')) {
        cols.forEach(col => col.classList.remove('hidden'));
      } else {
        cols.forEach(col => col.classList.add('hidden'));
      }
    });
  });

  document.getElementById('filter-search').addEventListener('input', renderPortfolio);

  // Initialize year columns visibility
  document.querySelectorAll('.year-chip').forEach(chip => {
    const year = chip.dataset.year;
    const cols = document.querySelectorAll(`.year-${year}`);
    if (!chip.classList.contains('active')) {
      cols.forEach(col => col.classList.add('hidden'));
    }
  });
}

// ============================================================================
// MODAL CLIENT
// ============================================================================
function openClientModal(clientName) {
  const client = clientsData.find(c => c.name === clientName);
  if (!client) return;

  document.getElementById('modal-header').innerHTML = `
    <h2>${escapeHtml(client.name)}</h2>
    <div class="modal-meta">
      <div><span class="segment-badge" style="background: ${client.segmentColor}20; color: ${client.segmentColor};">${client.segment}</span></div>
      <div><strong>Health Score:</strong> <span style="color: ${getHealthColor(client.avgHealthScore)}">${client.avgHealthScore}/100</span></div>
      <div><strong>CA Total:</strong> ${formatCurrency(client.totalRevenue)}</div>
      <div><strong>Owner:</strong> ${client.owner}</div>
      ${client.industry ? `<div><strong>Industrie:</strong> ${client.industry}</div>` : ''}
    </div>
  `;

  const notes = client.notesStructured;
  let notesHTML = '';

  if (notes && Object.keys(notes).length > 1) {
    if (notes.relation) {
      notesHTML += `<div class="note-field"><div class="note-field-label">Type de Relation</div><div class="note-field-value">${escapeHtml(notes.relation)}</div></div>`;
    }
    if (notes.intro) {
      notesHTML += `<div class="note-field"><div class="note-field-label">Introduction</div><div class="note-field-value">${escapeHtml(notes.intro)}</div></div>`;
    }
    if (notes.historique) {
      notesHTML += `<div class="note-field"><div class="note-field-label">Historique</div><div class="note-field-value">${escapeHtml(notes.historique)}</div></div>`;
    }
    if (notes.ca) {
      notesHTML += `<div class="note-field"><div class="note-field-label">CA</div><div class="note-field-value">${escapeHtml(notes.ca)}</div></div>`;
    }
    if (notes.bu) {
      notesHTML += `<div class="note-field"><div class="note-field-label">BU Concernée</div><div class="note-field-value">${escapeHtml(notes.bu)}</div></div>`;
    }
    if (notes.contacts && notes.contacts.length > 0) {
      notesHTML += `<div class="note-field"><div class="note-field-label">Contacts</div><div class="contacts-list">${notes.contacts.map(c => `<span class="contact-badge">${escapeHtml(c)}</span>`).join('')}</div></div>`;
    }
    if (notes.typologie && notes.typologie.length > 0) {
      notesHTML += `<div class="note-field"><div class="note-field-label">Typologie des Sujets</div><div class="typologie-list">${notes.typologie.map(t => `<div class="typologie-item">${escapeHtml(t)}</div>`).join('')}</div></div>`;
    }
    if (notes.potentiel) {
      notesHTML += `<div class="note-field"><div class="note-field-label">Potentiel Développement</div><div class="note-field-value">${escapeHtml(notes.potentiel)}</div></div>`;
    }
  } else {
    notesHTML = '<p class="text-muted">Aucune note structurée disponible</p>';
  }

  document.getElementById('modal-notes').innerHTML = `<h2>📝 Notes et Relation Client</h2>${notesHTML}`;

  document.getElementById('modal-revenue').innerHTML = `
    <h2>💰 Chiffre d'Affaires Détaillé</h2>
    <div class="revenue-grid">
      <div class="revenue-item"><div class="revenue-year">2022</div><div class="revenue-amount">${formatCurrency(client.years['2022'])}</div></div>
      <div class="revenue-item"><div class="revenue-year">2023</div><div class="revenue-amount">${formatCurrency(client.years['2023'])}</div></div>
      <div class="revenue-item"><div class="revenue-year">2024</div><div class="revenue-amount">${formatCurrency(client.years['2024'])}</div></div>
      <div class="revenue-item"><div class="revenue-year">2025</div><div class="revenue-amount">${formatCurrency(client.years['2025'])}</div></div>
      <div class="revenue-item"><div class="revenue-year">Total</div><div class="revenue-amount" style="color: var(--accent-light);">${formatCurrency(client.totalRevenue)}</div></div>
    </div>
  `;

  document.getElementById('modal-engagement').innerHTML = `
    <h2>📊 Engagement et Activité</h2>
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-label">Notes</div><div class="stat-value">${client.totalNotes}</div></div>
      <div class="stat-card"><div class="stat-label">Emails</div><div class="stat-value">${client.engagementEmails}</div></div>
      <div class="stat-card"><div class="stat-label">Calls</div><div class="stat-value">${client.engagementCalls}</div></div>
      <div class="stat-card"><div class="stat-label">Meetings</div><div class="stat-value">${client.engagementMeetings}</div></div>
      <div class="stat-card"><div class="stat-label">Sentiment</div><div class="stat-value">${getSentimentEmoji(client.notesSentiment)} ${client.notesSentiment}</div></div>
      <div class="stat-card"><div class="stat-label">Deals</div><div class="stat-value">${client.dealCount}</div></div>
    </div>
  `;

  document.getElementById('clientModal').classList.add('active');
}

function closeClientModal() {
  document.getElementById('clientModal').classList.remove('active');
}

// ============================================================================
// UTILITY FUNCTIONS
// ============================================================================
function formatCurrency(value) {
  if (!value || value === 0) return '-';
  return new Intl.NumberFormat('fr-FR', {
    style: 'currency',
    currency: 'EUR',
    maximumFractionDigits: 0
  }).format(value);
}

function getHealthColor(score) {
  if (score >= 70) return '#22c55e';
  if (score >= 50) return '#f59e0b';
  return '#ef4444';
}

function getTrendIcon(trend) {
  if (trend === 'up') return '<span style="color: var(--green)">📈</span>';
  if (trend === 'down') return '<span style="color: var(--red)">📉</span>';
  if (trend === 'stable') return '<span style="color: var(--blue)">➡️</span>';
  return '-';
}

function getSentimentEmoji(sentiment) {
  if (sentiment === 'positive') return '😊';
  if (sentiment === 'negative') return '😟';
  return '😐';
}

function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ============================================================================
// INIT
// ============================================================================
window.addEventListener('DOMContentLoaded', () => {
  console.log('🚀 Dashboard Account Manager PRO - Chargement...');
  loadHubSpotData();
});

// Close modal on click outside
window.addEventListener('click', (e) => {
  if (e.target.id === 'clientModal') {
    closeClientModal();
  }
});
</script>

</body>
</html>
