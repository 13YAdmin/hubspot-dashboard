<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<title>HubSpot CRM - Dashboard Account Manager</title>

<style>
:root {
  --bg: #0a0e27;
  --bg-card: #151932;
  --bg-card-hover: #1d2342;
  --text: #f1f5f9;
  --text-muted: #94a3b8;
  --accent: #6366f1;
  --accent-light: #818cf8;
  --green: #22c55e;
  --green-light: #4ade80;
  --red: #ef4444;
  --red-light: #f87171;
  --orange: #f59e0b;
  --yellow: #eab308;
  --blue: #3b82f6;
  --purple: #a855f7;
  --border: #1e293b;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: linear-gradient(135deg, var(--bg) 0%, #0f1629 100%);
  color: var(--text);
  padding: 20px;
  min-height: 100vh;
}

.container {
  max-width: 1800px;
  margin: 0 auto;
}

/* Header */
.header {
  background: linear-gradient(135deg, var(--accent) 0%, var(--purple) 100%);
  border-radius: 16px;
  padding: 28px;
  margin-bottom: 20px;
  box-shadow: 0 20px 60px rgba(99, 102, 241, 0.4);
}

.header h1 {
  font-size: 28px;
  font-weight: 800;
  margin-bottom: 6px;
  color: white;
  text-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

.header p {
  color: rgba(255,255,255,0.95);
  font-size: 15px;
}

.upload-section {
  background: var(--bg-card);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  border: 2px dashed var(--border);
  transition: all 0.3s ease;
  text-align: center;
}

.upload-section:hover {
  border-color: var(--accent);
  background: var(--bg-card-hover);
}

.upload-section h3 {
  margin-bottom: 12px;
  color: var(--text);
  font-size: 16px;
}

.upload-section input[type="file"] {
  padding: 10px 20px;
  background: var(--accent);
  border: none;
  border-radius: 8px;
  color: white;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
}

.upload-section input[type="file"]:hover {
  background: var(--accent-light);
  transform: scale(1.05);
}


/* KPI Grid */
.kpi-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 14px;
  margin-bottom: 20px;
}

.kpi-card {
  background: var(--bg-card);
  border-radius: 12px;
  padding: 18px;
  border: 1px solid var(--border);
  position: relative;
  overflow: hidden;
  transition: all 0.3s ease;
  cursor: pointer;
}

.kpi-card:hover {
  transform: translateY(-5px) scale(1.02);
  box-shadow: 0 15px 40px rgba(99, 102, 241, 0.3);
  border-color: var(--accent);
}

.kpi-card:active {
  transform: translateY(-2px) scale(0.98);
}

.kpi-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--accent), var(--purple));
}

.kpi-label {
  font-size: 12px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 6px;
}

.kpi-value {
  font-size: 28px;
  font-weight: 800;
  color: var(--text);
  margin-bottom: 4px;
}

.kpi-change {
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 4px;
}

.kpi-change.positive { color: var(--green); }
.kpi-change.negative { color: var(--red); }

/* Chart Section */
.chart-section {
  background: var(--bg-card);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  border: 1px solid var(--border);
  transition: all 0.3s ease;
}

.chart-section:hover {
  border-color: var(--accent);
  box-shadow: 0 8px 24px rgba(99, 102, 241, 0.15);
}

.chart-section h3 {
  font-size: 17px;
  margin-bottom: 14px;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 8px;
}

.chart-section h3::before {
  content: '';
  width: 4px;
  height: 18px;
  background: var(--accent);
  border-radius: 2px;
}

.charts-row {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
  margin-bottom: 20px;
}

.chart-container {
  width: 100%;
  height: 300px;
  position: relative;
}

svg {
  width: 100%;
  height: 100%;
}

.bar, .line-point {
  transition: all 0.3s ease;
  cursor: pointer;
}

.bar:hover, .line-point:hover {
  opacity: 0.85;
  filter: brightness(1.15);
}

.bar.selected {
  filter: brightness(1.3);
  stroke: #fff;
  stroke-width: 2;
}

/* Table */
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

thead {
  background: var(--bg);
  position: sticky;
  top: 0;
  z-index: 10;
}

th {
  padding: 10px;
  text-align: left;
  font-weight: 600;
  color: var(--accent);
  border-bottom: 2px solid var(--border);
  cursor: pointer;
  user-select: none;
  font-size: 12px;
}

th:hover {
  background: var(--bg-card-hover);
}

td {
  padding: 10px;
  border-bottom: 1px solid var(--border);
  color: var(--text);
}

tbody tr {
  transition: all 0.2s ease;
  cursor: pointer;
}

tbody tr:hover {
  background: var(--bg-card-hover);
  transform: scale(1.01);
  box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
}

tbody tr:active {
  background: rgba(99, 102, 241, 0.15);
  transform: scale(0.99);
}

.badge {
  display: inline-block;
  padding: 3px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
  transition: all 0.2s ease;
  cursor: help;
}

.badge:hover {
  transform: scale(1.15);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

.badge.stratégique { background: rgba(168, 85, 247, 0.2); color: var(--purple); }
.badge.stratégique:hover { background: rgba(168, 85, 247, 0.4); }

.badge.clé { background: rgba(34, 197, 94, 0.2); color: var(--green); }
.badge.clé:hover { background: rgba(34, 197, 94, 0.4); }

.badge.régulier { background: rgba(59, 130, 246, 0.2); color: var(--blue); }
.badge.régulier:hover { background: rgba(59, 130, 246, 0.4); }

.badge.à-risque { background: rgba(245, 158, 11, 0.2); color: var(--orange); }
.badge.à-risque:hover { background: rgba(245, 158, 11, 0.4); }

.badge.dormant { background: rgba(239, 68, 68, 0.2); color: var(--red); }
.badge.dormant:hover { background: rgba(239, 68, 68, 0.4); }

.priority-high { color: var(--red); font-weight: 700; }
.priority-medium { color: var(--orange); font-weight: 600; }
.priority-low { color: var(--text-muted); }

/* Loading */
.loading {
  text-align: center;
  padding: 40px;
  color: var(--text-muted);
}

.spinner {
  border: 3px solid var(--border);
  border-top: 3px solid var(--accent);
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: 0 auto 12px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.legend {
  display: flex;
  gap: 14px;
  flex-wrap: wrap;
  margin-top: 14px;
  font-size: 12px;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 6px;
}

.legend-color {
  width: 14px;
  height: 14px;
  border-radius: 3px;
}

/* Action Cards */
.action-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 14px;
}

.action-card {
  background: var(--bg-card);
  border-radius: 10px;
  padding: 16px;
  border-left: 4px solid var(--accent);
  transition: all 0.3s ease;
  cursor: pointer;
}

.action-card:hover {
  transform: translateX(5px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
  background: var(--bg-card-hover);
}

.action-card.high { border-left-color: var(--red); }
.action-card.medium { border-left-color: var(--orange); }
.action-card.low { border-left-color: var(--blue); }

.action-card.high:hover { box-shadow: -4px 0 0 var(--red), 0 8px 20px rgba(239, 68, 68, 0.3); }
.action-card.medium:hover { box-shadow: -4px 0 0 var(--orange), 0 8px 20px rgba(245, 158, 11, 0.3); }
.action-card.low:hover { box-shadow: -4px 0 0 var(--blue), 0 8px 20px rgba(59, 130, 246, 0.3); }

.action-card h4 {
  font-size: 14px;
  margin-bottom: 6px;
  color: var(--text);
}

.action-card p {
  color: var(--text-muted);
  font-size: 13px;
  line-height: 1.5;
  margin-bottom: 8px;
}

.action-card .action-tag {
  display: inline-block;
  padding: 3px 8px;
  background: rgba(99, 102, 241, 0.2);
  color: var(--accent);
  border-radius: 6px;
  font-size: 11px;
  font-weight: 600;
}

.hidden { display: none !important; }

/* Info Panel */
.info-panel {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.9);
  background: var(--bg-card);
  border: 2px solid var(--accent);
  border-radius: 16px;
  padding: 24px;
  max-width: 500px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  z-index: 1000;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
  opacity: 0;
  pointer-events: none;
  transition: all 0.3s ease;
}

.info-panel.show {
  opacity: 1;
  pointer-events: all;
  transform: translate(-50%, -50%) scale(1);
}

.info-panel-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  z-index: 999;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
  backdrop-filter: blur(4px);
}

.info-panel-overlay.show {
  opacity: 1;
  pointer-events: all;
}

.info-panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 2px solid var(--border);
}

.info-panel-header h3 {
  color: var(--accent);
  font-size: 20px;
  font-weight: 700;
}

.info-panel-close {
  background: var(--red);
  border: none;
  color: white;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 20px;
  font-weight: bold;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.info-panel-close:hover {
  transform: scale(1.1) rotate(90deg);
  background: var(--red-light);
}

.info-panel-content {
  color: var(--text);
}

.info-row {
  display: flex;
  justify-content: space-between;
  padding: 12px 0;
  border-bottom: 1px solid var(--border);
}

.info-row:last-child {
  border-bottom: none;
}

.info-label {
  color: var(--text-muted);
  font-weight: 600;
  font-size: 13px;
}

.info-value {
  color: var(--text);
  font-weight: 700;
  font-size: 14px;
}

.info-highlight {
  background: rgba(99, 102, 241, 0.1);
  padding: 16px;
  border-radius: 10px;
  margin: 16px 0;
  border-left: 4px solid var(--accent);
}

details {
  transition: all 0.3s ease;
}

details:hover {
  background: rgba(255, 255, 255, 0.05) !important;
}

summary {
  transition: all 0.2s ease;
}

summary:hover {
  color: var(--accent) !important;
}

summary::marker {
  color: var(--accent);
}

details[open] summary {
  color: var(--accent) !important;
  margin-bottom: 12px;
}

/* Filters */
.filters-container {
  background: var(--bg);
  padding: 16px;
  border-radius: 10px;
  margin-bottom: 16px;
  border: 1px solid var(--border);
}

.filter-group {
  margin-bottom: 14px;
}

.filter-group:last-child {
  margin-bottom: 0;
}

.filter-group label {
  display: block;
  font-size: 12px;
  font-weight: 600;
  color: var(--text-muted);
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.filters {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.filter-btn {
  padding: 8px 16px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text);
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 13px;
  font-weight: 500;
  position: relative;
  overflow: hidden;
}

.filter-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.3), transparent);
  transition: left 0.5s ease;
}

.filter-btn:hover::before {
  left: 100%;
}

.filter-btn:hover {
  background: var(--bg-card-hover);
  border-color: var(--accent);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
}

.filter-btn.active {
  background: linear-gradient(135deg, var(--accent) 0%, var(--purple) 100%);
  border-color: var(--accent);
  color: white;
  font-weight: 600;
  box-shadow: 0 4px 16px rgba(99, 102, 241, 0.4);
}

.filter-btn.active:hover {
  transform: translateY(-2px) scale(1.05);
}

/* Animations */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.kpi-card, .chart-section, .action-card {
  animation: fadeInUp 0.5s ease-out;
}

.kpi-card:nth-child(1) { animation-delay: 0.1s; }
.kpi-card:nth-child(2) { animation-delay: 0.15s; }
.kpi-card:nth-child(3) { animation-delay: 0.2s; }
.kpi-card:nth-child(4) { animation-delay: 0.25s; }
.kpi-card:nth-child(5) { animation-delay: 0.3s; }
.kpi-card:nth-child(6) { animation-delay: 0.35s; }

/* Responsive */
@media (max-width: 1200px) {
  .charts-row {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 640px) {
  .kpi-grid {
    grid-template-columns: 1fr;
  }
}

/* ========================================
   GROUPES PARENT/FILIALES
   ======================================== */

/* Ligne de groupe parent */
.group-row {
  background: rgba(99, 102, 241, 0.08) !important;
  font-weight: 700;
  cursor: pointer;
  transition: background 0.2s ease;
}

.group-row:hover {
  background: rgba(99, 102, 241, 0.15) !important;
}

/* Ligne d'enfant (filiale) */
.child-row {
  background: rgba(30, 41, 59, 0.25) !important;
  font-size: 13px;
}

.child-row:hover {
  background: rgba(30, 41, 59, 0.35) !important;
}

/* Ligne white space (prospect/filiale sans deals) */
.white-space-row {
  background: rgba(251, 191, 36, 0.05) !important;
  border-left: 3px solid #f59e0b !important;
  font-style: italic;
  opacity: 0.8;
}

.white-space-row:hover {
  background: rgba(251, 191, 36, 0.15) !important;
  opacity: 1;
}

.white-space-badge {
  background: linear-gradient(135deg, #f59e0b, #fbbf24);
  color: white;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 10px;
  font-weight: 700;
  margin-left: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
}

/* Icône expand/collapse */
.expand-icon {
  display: inline-block;
  width: 16px;
  margin-right: 8px;
  font-size: 14px;
  transition: transform 0.2s ease;
  color: var(--accent);
}

.group-row.expanded .expand-icon {
  transform: rotate(90deg);
}

/* Indicateur de filiale (└─) */
.child-indicator {
  color: #94a3b8;
  margin-right: 6px;
  font-weight: 400;
}

/* Badge nombre de filiales */
.badge-subsidiaries {
  background: var(--accent);
  color: white;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 10px;
  font-weight: 600;
  margin-left: 8px;
}

/* Nom du groupe en gras */
.group-name {
  font-weight: 800;
  color: var(--text);
}

/* Indentation pour les filiales */
.child-cell-indent {
  padding-left: 40px !important;
}
</style>
</head>

<body>
<div class="container">

  <!-- Header -->
  <div class="header" style="position: relative;">
    <h1>Dashboard Account Manager - HubSpot CRM</h1>
    <p>Analyses stratégiques et recommandations pour la gestion de portefeuille clients</p>
    <button onclick="window.open('https://github.com/13YAdmin/hubspot-dashboard/actions', '_blank')" style="
      position: absolute;
      top: 20px;
      right: 20px;
      padding: 10px 20px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(99, 102, 241, 0.4)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 12px rgba(99, 102, 241, 0.3)'">
      🔄 Actualiser
    </button>
  </div>

  <!-- Loading indicator -->
  <div id="loadStatus" style="text-align: center; padding: 20px; color: var(--text-muted);">
    <div style="font-size: 18px; margin-bottom: 8px;">🔄 Chargement des données...</div>
    <p style="font-size: 13px;">Récupération des données enrichies depuis HubSpot</p>
  </div>


  <!-- Loading -->
  <div id="loadingState" class="loading hidden">
    <div class="spinner"></div>
    <p>Chargement des données HubSpot...</p>
  </div>

  <!-- Dashboard -->
  <div id="dashboardContent" class="hidden">

    <!-- KPIs -->
    <div class="kpi-grid" id="kpiGrid"></div>

    <!-- Charts Row 1 -->
    <div class="chart-section">
      <h3>Évolution du CA Global par Année</h3>
      <div class="chart-container">
        <svg id="chartRevenueGlobal"></svg>
      </div>
    </div>

    <!-- Evolution CA par Client -->
    <div class="chart-section">
      <h3>Évolution du CA - Top 10 Clients</h3>
      <div class="chart-container" style="height: 400px;">
        <svg id="chartClientEvolution"></svg>
      </div>
      <div class="legend" id="legendClientEvolution"></div>
    </div>

    <!-- Segmentation Clients -->
    <div class="chart-section">
      <h3>Segmentation & Scoring Clients</h3>

      <!-- Filtres -->
      <div class="filters-container">
        <div class="filter-group">
          <label>Filtrer par Année:</label>
          <div class="filters">
            <button class="filter-btn active" data-filter-type="year" data-filter="all">Toutes</button>
            <button class="filter-btn" data-filter-type="year" data-filter="2022">2022</button>
            <button class="filter-btn" data-filter-type="year" data-filter="2023">2023</button>
            <button class="filter-btn" data-filter-type="year" data-filter="2024">2024</button>
            <button class="filter-btn" data-filter-type="year" data-filter="2025">2025</button>
          </div>
        </div>
      </div>

      <div style="overflow-x: auto; margin-top: 20px;">
        <table id="segmentationTable">
          <thead>
            <tr>
              <th data-sort="rank">Rang</th>
              <th data-sort="name">Client</th>
              <th data-sort="segment" title="Catégorie client" style="font-size: 11px;">Cat.</th>
              <th data-sort="healthScore">Score Santé</th>
              <th data-sort="total">CA Total</th>
              <th data-sort="2022" style="font-size: 11px;" class="year-col year-2022">2022</th>
              <th data-sort="2023" style="font-size: 11px;" class="year-col year-2023">2023</th>
              <th data-sort="2024" style="font-size: 11px;" class="year-col year-2024">2024</th>
              <th data-sort="2025" style="font-size: 11px;" class="year-col year-2025">2025</th>
              <th data-sort="globalTrend" class="global-trend-col" style="font-size: 11px;">Tendance</th>
              <th data-sort="sentiment">Sentiment</th>
              <th data-sort="contacts">Contacts</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="segmentationBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Répartition Secteurs d'Activité -->
    <div class="chart-section">
      <h3>Répartition par Secteur d'Activité (par CA)</h3>
      <!-- Filtres année pour le graphique -->
      <div style="margin-bottom: 16px;">
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <button class="filter-btn" data-industry-year="all" onclick="filterIndustryChart('all')" style="background: var(--accent); color: white;">Toutes</button>
          <button class="filter-btn" data-industry-year="2022" onclick="filterIndustryChart('2022')">2022</button>
          <button class="filter-btn" data-industry-year="2023" onclick="filterIndustryChart('2023')">2023</button>
          <button class="filter-btn" data-industry-year="2024" onclick="filterIndustryChart('2024')">2024</button>
          <button class="filter-btn" data-industry-year="2025" onclick="filterIndustryChart('2025')">2025</button>
        </div>
      </div>
      <div class="chart-container" style="height: 400px;">
        <svg id="chartIndustryPie"></svg>
      </div>
      <div class="legend" id="legendIndustryPie" style="display: flex; justify-content: center; gap: 15px; margin-top: 20px; flex-wrap: wrap;"></div>
    </div>

    <!-- Strategic Recommendations -->
    <div class="chart-section">
      <h3>Recommandations Stratégiques Account Manager</h3>
      <div class="action-grid" id="recommendationsGrid"></div>
    </div>

    <!-- White Spaces - Opportunités non exploitées -->
    <div class="chart-section" style="border-left: 4px solid #f59e0b;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h3 style="margin: 0;">🎯 Opportunités White Space</h3>
        <div style="display: flex; gap: 8px; align-items: center;">
          <span id="whiteSpaceCount" style="background: linear-gradient(135deg, #f59e0b, #fbbf24); color: white; padding: 4px 12px; border-radius: 6px; font-weight: 700; font-size: 14px;">0 opportunités</span>
        </div>
      </div>
      <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 16px; line-height: 1.6;">
        Liste des filiales sans deals et opportunités de cross-sell non exploitées au sein des groupes clients.
      </p>
      <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
          <thead>
            <tr style="background: rgba(251, 191, 36, 0.1); border-bottom: 2px solid #f59e0b;">
              <th style="padding: 12px; text-align: left; font-weight: 700; color: var(--text);">Opportunité</th>
              <th style="padding: 12px; text-align: left; font-weight: 700; color: var(--text);">Groupe Parent</th>
              <th style="padding: 12px; text-align: left; font-weight: 700; color: var(--text);">Secteur</th>
              <th style="padding: 12px; text-align: left; font-weight: 700; color: var(--text);">CA Parent</th>
              <th style="padding: 12px; text-align: left; font-weight: 700; color: var(--text);">Potentiel Estimé</th>
              <th style="padding: 12px; text-align: left; font-weight: 700; color: var(--text);">Priorité</th>
              <th style="padding: 12px; text-align: left; font-weight: 700; color: var(--text);">Action</th>
            </tr>
          </thead>
          <tbody id="whiteSpacesBody">
            <!-- Rempli par JS -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Company Relationships Tree - MASQUÉE (remplacée par tableau groupé) -->
    <div class="chart-section" style="display: none;">
      <h3>Cartographie des Relations Entreprises & Opportunités Cross-Sell</h3>
      <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 8px;">
        ⚠️ Cette vue a été remplacée par le tableau avec groupes parent/filiales ci-dessus.
        Cliquez sur une ligne "groupe" pour déplier et voir les filiales.
      </p>
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <div style="display: flex; gap: 16px; font-size: 12px; flex-wrap: wrap;">
          <div style="display: flex; align-items: center; gap: 6px;">
            <div style="width: 18px; height: 18px; background: linear-gradient(135deg, #4f46e5, #7c3aed); border-radius: 4px; border: 2px solid #818cf8;"></div>
            <span style="color: var(--text); font-weight: 600;">Société Mère</span>
          </div>
          <div style="display: flex; align-items: center; gap: 6px;">
            <div style="width: 18px; height: 18px; background: linear-gradient(135deg, #6366f1, #8b5cf6); border-radius: 4px; border: 2px solid #a5b4fc;"></div>
            <span style="color: var(--text); font-weight: 600;">Client</span>
          </div>
          <div style="display: flex; align-items: center; gap: 6px;">
            <div style="width: 18px; height: 18px; background: linear-gradient(135deg, #818cf8, #a78bfa); border-radius: 4px; border: 2px solid #a78bfa;"></div>
            <span style="color: var(--text); font-weight: 600;">Filiale</span>
          </div>
          <div style="display: flex; align-items: center; gap: 6px;">
            <div style="width: 18px; height: 18px; background: linear-gradient(135deg, #f97316, #ec4899); border-radius: 4px; border: 2px solid #fb923c;"></div>
            <span style="color: #f97316; font-weight: 600;">🎯 Opportunité Cross-Sell</span>
          </div>
        </div>
        <!-- Contrôles de navigation -->
        <div style="display: flex; gap: 8px;">
          <button onclick="zoomCompanyTree(1.2)" style="padding: 6px 12px; background: var(--accent); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
            🔍 Zoom +
          </button>
          <button onclick="zoomCompanyTree(0.8)" style="padding: 6px 12px; background: var(--accent); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
            🔍 Zoom −
          </button>
          <button onclick="resetCompanyTreeZoom()" style="padding: 6px 12px; background: var(--purple); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
            ↻ Reset
          </button>
        </div>
      </div>
      <div id="companyTreeContainer" class="chart-container" style="position: relative; height: 600px; overflow: hidden; border: 1px solid var(--border); border-radius: 8px; background: #f8fafc; cursor: grab;">
        <svg id="chartCompanyTree" style="width: 100%; height: 100%;"></svg>
      </div>
      <p style="color: var(--text-muted); font-size: 11px; margin-top: 8px; font-style: italic;">
        💡 Utilisez la molette de la souris pour zoomer, cliquez-glissez pour vous déplacer, cliquez sur une entreprise pour voir les détails
      </p>
    </div>

    <!-- Detailed Analysis -->
    <div class="chart-section">
      <h3>Analyses Complémentaires</h3>
      <div class="action-grid" id="analysisGrid"></div>
    </div>

    <!-- Methodology Section -->
    <div class="chart-section">
      <h3>📚 Méthodologie & Légendes</h3>
      <p style="color: var(--text-muted); margin-bottom: 20px; font-size: 14px;">
        Cliquez sur chaque section pour comprendre comment sont calculées les métriques et ce que signifient les différents segments.
      </p>

      <div class="action-grid">
        <!-- Score Client -->
        <div class="action-card low" onclick="showMethodologyDetails('score')">
          <h4>Score Client (0-100)</h4>
          <p>Comment le score de chaque client est calculé</p>
          <span class="action-tag">Cliquez pour détails</span>
        </div>

        <!-- Tendance -->
        <div class="action-card low" onclick="showMethodologyDetails('tendance')">
          <h4>Tendance (%)</h4>
          <p>Calcul de l'évolution de l'activité client</p>
          <span class="action-tag">Cliquez pour détails</span>
        </div>

        <!-- Segments -->
        <div class="action-card low" onclick="showMethodologyDetails('segments')">
          <h4>🏷️ Segments Clients</h4>
          <p>Signification des 5 segments (Stratégique, Clé, etc.)</p>
          <span class="action-tag">Cliquez pour détails</span>
        </div>

        <!-- Priorités -->
        <div class="action-card low" onclick="showMethodologyDetails('priorites')">
          <h4>Niveaux de Priorité</h4>
          <p>Haute, Moyenne, Basse - comment c'est défini</p>
          <span class="action-tag">Cliquez pour détails</span>
        </div>

        <!-- Recommandations -->
        <div class="action-card low" onclick="showMethodologyDetails('recommandations')">
          <h4>💡 Recommandations</h4>
          <p>Actions suggérées selon le profil client</p>
          <span class="action-tag">Cliquez pour détails</span>
        </div>

        <!-- KPIs -->
        <div class="action-card low" onclick="showMethodologyDetails('kpis')">
          <h4>KPIs Principaux</h4>
          <p>Définition des indicateurs clés de performance</p>
          <span class="action-tag">Cliquez pour détails</span>
        </div>
      </div>
    </div>

  </div>

  <!-- Info Panel -->
  <div class="info-panel-overlay" id="infoPanelOverlay" onclick="closeInfoPanel()"></div>
  <div class="info-panel" id="infoPanel">
    <div class="info-panel-header">
      <h3 id="infoPanelTitle">Détails</h3>
      <button class="info-panel-close" onclick="closeInfoPanel()">×</button>
    </div>
    <div class="info-panel-content" id="infoPanelContent">
    </div>
  </div>
</div>

<script>
// ============================================================================
// Configuration
// ============================================================================
const HUBSPOT_PORTAL_ID = '146716340'; // Portal ID HubSpot

// ============================================================================
// Global State
// ============================================================================
let dealsData = [];
let processedData = [];
let groupedData = []; // Données avec structure parent/filiales
let currentDisplayedClients = []; // Pour stocker les clients actuellement affichés
let groupExpandedStates = {}; // Stocker l'état expand/collapse par groupId
let currentFilters = {
  year: 'all'
};
let sortColumn = 'name'; // Tri alphabétique par défaut
let sortDirection = 'asc';

// ============================================================================
// Load data from data.json (auto-updated by GitHub Actions)
// ============================================================================
async function loadHubSpotData() {
  const statusEl = document.getElementById('loadStatus');

  statusEl.innerHTML = '<div style="font-size: 18px; margin-bottom: 8px;">🔄 Chargement...</div><p style="font-size: 13px;">Récupération des données enrichies</p>';

  try {
    // Charger data.json (généré par GitHub Actions)
    const response = await fetch('data.json?t=' + Date.now()); // Cache busting

    if (!response.ok) {
      throw new Error(`Impossible de charger les données (${response.status})`);
    }

    const result = await response.json();

    if (result.success && result.data) {
      // Clear cache to avoid data mixing
      dealsData = result.data;
      processedData = [];
      currentFilters = {
        year: 'all'
      };
      sortColumn = 'name'; // Tri alphabétique par défaut
      sortDirection = 'asc';

      // Stocker les companies pour la cartographie des relations
      window.hubspotCompanies = result.companies || {};
      console.log('Données chargées:', result.data.length, 'deals,', Object.keys(window.hubspotCompanies).length, 'companies');

      processData();
      console.log('✅ Données traitées:', processedData.length, 'clients');

      renderDashboard();
      console.log('✅ Dashboard rendu');

      // Hide loading, show dashboard
      statusEl.style.display = 'none';
      document.getElementById('loadingState').classList.add('hidden');
      document.getElementById('dashboardContent').classList.remove('hidden');
    } else {
      throw new Error('Format de données invalide');
    }
  } catch (error) {
    console.error('❌ Erreur:', error);
    statusEl.innerHTML = `<div style="color: var(--red); font-size: 16px;">❌ Erreur: ${error.message}</div>
      <p style="font-size: 13px; margin-top: 8px; color: var(--text-muted);">
        Impossible de charger les données. Vérifie que le workflow GitHub Actions s'est exécuté.
      </p>`;
  }
}

// Chargement automatique au démarrage
window.addEventListener('DOMContentLoaded', () => {
  console.log('🔄 Chargement automatique des données...');
  loadHubSpotData();
});

// ============================================================================
// PARSING INTELLIGENT DES NOTES
// ============================================================================
function parseNoteContent(htmlContent) {
  if (!htmlContent) return null;

  // Créer un élément temporaire pour parser le HTML
  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = htmlContent;
  const text = tempDiv.textContent || tempDiv.innerText;

  // Parser les différentes sections
  const parsed = {
    relation: null,
    intro: null,
    historique: null,
    ca: null,
    bu: null,
    contacts: [],
    typologie: [],
    potentiel: null,
    raw: text
  };

  // Extraire Relation
  const relationMatch = text.match(/Relation\s*:\s*([^\n]+)/i);
  if (relationMatch) parsed.relation = relationMatch[1].trim();

  // Extraire Intro
  const introMatch = text.match(/Intro\s*:\s*([^\n]+(?:\n(?!.*:)[^\n]+)*)/i);
  if (introMatch) parsed.intro = introMatch[1].trim();

  // Extraire Historique
  const historiqueMatch = text.match(/Historique\s*:\s*([^\n]+(?:\n(?!.*:)[^\n]+)*)/i);
  if (historiqueMatch) parsed.historique = historiqueMatch[1].trim();

  // Extraire CA
  const caMatch = text.match(/CA\s*:\s*([^\n]+)/i);
  if (caMatch) parsed.ca = caMatch[1].trim();

  // Extraire BU
  const buMatch = text.match(/BU\s*(?:concerné|concernée)?\s*:\s*([^\n]+)/i);
  if (buMatch) parsed.bu = buMatch[1].trim();

  // Extraire Contacts (plusieurs formats possibles)
  const contactMatch = text.match(/Contact[s]?\s*:\s*([^\n]+)/i);
  if (contactMatch) {
    const contactsStr = contactMatch[1].trim();
    // Séparer par "/" ou "et" ou ","
    parsed.contacts = contactsStr.split(/[\/,]|(?:\s+et\s+)/)
      .map(c => c.trim())
      .filter(c => c.length > 0);
  }

  // Extraire Typologie des sujets
  const typologieMatch = text.match(/Typologie\s*(?:des\s*sujets)?\s*:(.*?)(?=Potentiel|$)/si);
  if (typologieMatch) {
    const typologieText = typologieMatch[1];
    // Extraire les bullet points ou lignes
    const bullets = typologieText.match(/[-•]\s*([^\n]+)/g);
    if (bullets) {
      parsed.typologie = bullets.map(b => b.replace(/^[-•]\s*/, '').trim());
    }
  }

  // Extraire Potentiel Développement
  const potentielMatch = text.match(/Potentiel\s*(?:Développement|de\s*développement)?\s*:(.*?)$/si);
  if (potentielMatch) parsed.potentiel = potentielMatch[1].trim();

  return parsed;
}

// ============================================================================
// Data Processing - NOUVEAU FORMAT ENRICHI
// ============================================================================
function processData() {
  const clientStats = {};

  // Les données sont déjà enrichies avec health scores et segments!
  dealsData.forEach(deal => {
    const companyName = deal.companyName || 'Inconnu';
    const montant = parseFloat(deal.amount) || 0;
    const year = deal.year || new Date(deal.closeDate || deal.createDate).getFullYear();

    // PARSER LES NOTES DE MANIÈRE INTELLIGENTE
    const notesData = parseNoteContent(deal.latestNoteBody);

    if (!clientStats[companyName]) {
      clientStats[companyName] = {
        name: companyName,
        companyId: deal.companyId,
        domain: deal.companyDomain,
        industry: deal.companyIndustry,
        companyIndustry: deal.companyIndustry, // Pour compatibilité graphique
        totalRevenue: 0,
        years: { '2022': 0, '2023': 0, '2024': 0, '2025': 0 },
        deals: [],
        dealCount: 0,
        lastDealDate: null,
        // Données enrichies
        avgHealthScore: 0,
        healthScores: [],
        segment: deal.segment || 'Régulier',
        segmentColor: deal.segmentColor || '#2ecc71',
        segmentReason: deal.segmentReason || '',
        totalNotes: deal.totalNotes || 0,
        notesSentiment: deal.notesSentiment || 'neutral',
        engagementEmails: deal.engagementEmails || 0,
        engagementCalls: deal.engagementCalls || 0,
        engagementMeetings: deal.engagementMeetings || 0,
        latestNoteBody: deal.latestNoteBody || '',
        latestNoteDate: deal.latestNoteDate || '',
        owner: deal.ownerName || 'Non assigné',
        // DONNÉES PARSÉES DES NOTES
        notesStructured: notesData || {}
      };
    }

    // Mettre à jour les données parsées si disponibles
    if (notesData && !clientStats[companyName].notesStructured.contacts) {
      clientStats[companyName].notesStructured = notesData;
    }

    clientStats[companyName].totalRevenue += montant;
    if (clientStats[companyName].years[year] !== undefined) {
      clientStats[companyName].years[year] += montant;
    }
    clientStats[companyName].deals.push({
      year,
      montant,
      closeDate: deal.closeDate,
      dealName: deal.dealName,
      healthScore: deal.healthScore
    });
    clientStats[companyName].dealCount++;
    clientStats[companyName].healthScores.push(deal.healthScore || 0);

    if (deal.closeDate) {
      const date = new Date(deal.closeDate);
      if (!clientStats[companyName].lastDealDate || date > clientStats[companyName].lastDealDate) {
        clientStats[companyName].lastDealDate = date;
      }
    }
  });

  // Finaliser les stats par client
  Object.values(clientStats).forEach(client => {
    // Health score moyen
    client.avgHealthScore = Math.round(
      client.healthScores.reduce((sum, s) => sum + s, 0) / client.healthScores.length
    );

    // Calculer les tendances
    client.trend = calculateTrend(client);
    client.yearlyTrends = calculateYearlyTrends(client);

    // Score basé sur le health score ET le CA
    client.score = Math.round((client.avgHealthScore * 0.6) + Math.min((client.totalRevenue / 100000) * 40, 40));

    // Recommandation basée sur le segment
    client.recommendation = getRecommendation(client);
  });

  // Trier par score santé pour calcul de priority basé sur percentiles
  const sortedByHealthScore = Object.values(clientStats).sort((a, b) => b.avgHealthScore - a.avgHealthScore);

  // Calculer priority basée sur percentiles pour meilleure répartition
  sortedByHealthScore.forEach((client, index) => {
    const percentile = index / sortedByHealthScore.length;

    // Combiner score santé, CA et tendance pour priority
    const hasFortCA = client.totalRevenue > 50000;
    const hasPositiveTrend = client.trend > 10;
    const hasDecentHealthScore = client.avgHealthScore > 30;

    if (percentile < 0.25 && (hasFortCA || hasDecentHealthScore)) {
      // Top 25% avec bon CA ou score correct = high priority
      client.priority = 'high';
    } else if (percentile < 0.6 || (hasFortCA && hasPositiveTrend)) {
      // Top 60% OU fort CA avec tendance positive = medium priority
      client.priority = 'medium';
    } else {
      client.priority = 'low';
    }
  });

  processedData = sortedByHealthScore;
  console.log('✅ Données enrichies traitées:', processedData);
}

// ============================================================================
// Process Grouped Data - Gestion des groupes parent/filiales
// ============================================================================
function processGroupedData() {
  if (!window.hubspotCompanies) {
    console.warn('⚠️ Pas de données companies disponibles, retour aux données non groupées');
    return processedData.map(client => ({
      type: 'standalone',
      ...client
    }));
  }

  const grouped = [];
  const processedClientNames = new Set();

  console.log('🏢 Début processing des groupes parent/filiales...');

  // PASSE 1: Identifier tous les groupes parents et traiter leurs enfants
  console.log('🔍 PASSE 1: Identification des groupes parents');
  processedData.forEach(client => {
    const company = window.hubspotCompanies[client.companyId];
    if (!company) return;

    // Si c'est un parent (a des filiales), traiter maintenant
    if (company.childCompanyIds && company.childCompanyIds.length > 0) {
      // Vérifier qu'on ne l'a pas déjà traité
      if (processedClientNames.has(client.name)) return;
      console.log(`👪 Groupe parent détecté: ${client.name} (ID: ${client.companyId}) avec ${company.childCompanyIds.length} filiale(s):`, company.childCompanyIds);

      // C'est un groupe parent
      const group = {
        type: 'group',
        groupId: client.companyId,
        groupName: client.name,
        isExpanded: groupExpandedStates[client.companyId] || false,  // Restaurer l'état si existant

        // Données du parent
        parentData: client,
        parentRevenue: client.totalRevenue,

        // Données agrégées (seront calculées)
        totalGroupRevenue: client.totalRevenue,
        childrenCount: 0,
        childrenRevenue: 0,

        // Métadonnées du parent
        segment: client.segment,
        segmentColor: client.segmentColor,
        segmentReason: client.segmentReason,
        avgHealthScore: client.avgHealthScore,
        years: { ...client.years },
        trend: client.trend,
        notesSentiment: client.notesSentiment,
        totalNotes: client.totalNotes,
        owner: client.owner,

        // Filiales
        children: []
      };

      // Récupérer les deals des filiales
      company.childCompanyIds.forEach(childId => {
        // Trouver le client correspondant dans processedData
        const childClient = processedData.find(c => c.companyId === childId);

        if (childClient) {
          console.log(`  ✓ Filiale trouvée dans processedData: ${childClient.name} (ID: ${childId}, CA: ${formatCurrency(childClient.totalRevenue)})`);

          group.children.push({
            type: 'child',
            parentGroupId: client.companyId,
            ...childClient
          });

          // Agréger les revenus
          group.totalGroupRevenue += childClient.totalRevenue;
          group.childrenRevenue += childClient.totalRevenue;

          // Agréger les années
          Object.keys(group.years).forEach(year => {
            group.years[year] += (childClient.years[year] || 0);
          });

          // Marquer comme traité
          processedClientNames.add(childClient.name);
        } else {
          // La filiale existe dans HubSpot mais n'a pas de deals
          const childCompany = window.hubspotCompanies[childId];
          if (childCompany) {
            console.log(`  ⚠️ Filiale sans deals (company existe): ${childCompany.name} (ID: ${childId})`);
            group.children.push({
              type: 'child',
              parentGroupId: client.companyId,
              name: childCompany.name,
              companyId: childId,
              domain: childCompany.domain || '',
              industry: childCompany.industry || '',
              totalRevenue: 0,
              years: { '2022': 0, '2023': 0, '2024': 0, '2025': 0 },
              avgHealthScore: 0,
              segment: 'Prospect',
              segmentColor: '#64748b',
              isProspect: true
            });
          } else {
            console.warn(`  ❌ Filiale ID ${childId} non trouvée dans hubspotCompanies!`);
          }
        }
      });

      group.childrenCount = group.children.length;

      // Recalculer le health score du groupe (moyenne pondérée par CA)
      if (group.totalGroupRevenue > 0) {
        let weightedHealthScore = client.avgHealthScore * client.totalRevenue;

        group.children.forEach(child => {
          if (!child.isProspect) {
            weightedHealthScore += (child.avgHealthScore || 0) * (child.totalRevenue || 0);
          }
        });

        group.avgHealthScore = Math.round(weightedHealthScore / group.totalGroupRevenue);
      }

      // Recalculer la tendance globale du groupe
      group.trend = calculateTrend(group);

      // Déterminer le segment du groupe (le plus prioritaire)
      const segmentPriority = {
        'Stratégique': 1,
        'Clé': 2,
        'Régulier': 3,
        'À Risque': 4,
        'Dormant': 5,
        'Prospect': 6
      };

      let bestSegment = client.segment;
      let bestPriority = segmentPriority[client.segment] || 999;
      let bestColor = client.segmentColor;

      group.children.forEach(child => {
        const childPriority = segmentPriority[child.segment] || 999;
        if (childPriority < bestPriority) {
          bestSegment = child.segment;
          bestPriority = childPriority;
          bestColor = child.segmentColor;
        }
      });

      group.segment = bestSegment;
      group.segmentColor = bestColor;

      console.log(`✅ Groupe ${client.name}: CA total ${formatCurrency(group.totalGroupRevenue)} (parent: ${formatCurrency(group.parentRevenue)}, filiales: ${formatCurrency(group.childrenRevenue)})`);

      grouped.push(group);
      processedClientNames.add(client.name);
    }
  });

  console.log(`✅ Passe 1 terminée: ${grouped.filter(g => g.type === 'group').length} groupes créés`);

  // PASSE 2: Ajouter les standalone (qui ne sont NI parents NI enfants)
  console.log('🔍 PASSE 2: Ajout des clients standalone');
  processedData.forEach(client => {
    // Si déjà traité (groupe parent ou filiale), skip
    if (processedClientNames.has(client.name)) {
      return;
    }

    const company = window.hubspotCompanies[client.companyId];

    // Vérifier si c'est une filiale (a des parentCompanyIds)
    if (company && company.parentCompanyIds && company.parentCompanyIds.length > 0) {
      // C'est une filiale
      // Vérifier si le parent est dans processedData (= a des deals)
      const parentHasDeals = company.parentCompanyIds.some(parentId => {
        return processedData.some(c => c.companyId === parentId);
      });

      if (parentHasDeals) {
        // Le parent a des deals, donc cette filiale DOIT être dans le groupe parent
        // NE PAS l'ajouter en standalone
        console.log(`   → Filiale ignorée (déjà dans groupe parent): ${client.name} (parent IDs: ${company.parentCompanyIds})`);
        processedClientNames.add(client.name);
      } else {
        // Le parent n'a PAS de deals, donc cette filiale devient standalone
        console.log(`   → Filiale standalone (parent sans deals): ${client.name} (parent IDs: ${company.parentCompanyIds})`);
        grouped.push({
          type: 'standalone',
          ...client
        });
        processedClientNames.add(client.name);
      }
    } else {
      // Pas de parent = standalone
      console.log(`   → Standalone: ${client.name}`);
      grouped.push({
        type: 'standalone',
        ...client
      });
      processedClientNames.add(client.name);
    }
  });

  console.log(`✅ Groupes créés: ${grouped.filter(g => g.type === 'group').length} groupes, ${grouped.filter(g => g.type === 'standalone').length} standalone`);

  return grouped;
}

// ============================================================================
// Toggle Group - Expand/Collapse des groupes parent/filiales
// ============================================================================
function toggleGroup(groupIndex) {
  // Trouver le groupe dans les données affichées
  const group = currentDisplayedClients[groupIndex];

  if (!group || group.type !== 'group') {
    console.warn('Impossible de toggle: pas un groupe ou index invalide', groupIndex);
    return;
  }

  // Inverser l'état dans le global state (pour persistance)
  const newState = !groupExpandedStates[group.groupId];
  groupExpandedStates[group.groupId] = newState;

  console.log(`${newState ? '▼' : '▶'} Groupe ${group.groupName} ${newState ? 'ouvert' : 'fermé'}`);

  // Re-render le tableau pour afficher/masquer les enfants
  renderSegmentationTable();
}

// Exposer la fonction globalement pour les attributs onclick HTML
window.toggleGroup = toggleGroup;

function calculateTrend(client) {
  /**
   * TENDANCE GLOBALE SIMPLE
   *
   * Calcul: (CA dernière année - CA première année) / CA première année × 100
   *
   * Exemples:
   * - 2022: 100k€, 2025: 150k€ → Tendance = +50%
   * - 2023: 200k€, 2025: 180k€ → Tendance = -10%
   * - 2024: 50k€, 2025: 50k€  → Tendance = 0%
   *
   * Pas d'annualisation, pas de bonus, juste la vraie croissance totale.
   */

  const years = ['2022', '2023', '2024', '2025'];
  const revenues = years.map(y => client.years[y] || 0);

  // Aucune activité = pas de tendance
  if (revenues.every(r => r === 0)) {
    return 0;
  }

  // Trouver la PREMIÈRE année active
  let firstActiveYear = null;
  let firstActiveRevenue = 0;

  for (let i = 0; i < years.length; i++) {
    if (revenues[i] > 0) {
      firstActiveYear = years[i];
      firstActiveRevenue = revenues[i];
      break; // Première trouvée, on arrête
    }
  }

  // Trouver la DERNIÈRE année active
  let lastActiveYear = null;
  let lastActiveRevenue = 0;

  for (let i = years.length - 1; i >= 0; i--) {
    if (revenues[i] > 0) {
      lastActiveYear = years[i];
      lastActiveRevenue = revenues[i];
      break; // Dernière trouvée, on arrête
    }
  }

  // Si une seule année active = pas de tendance
  if (firstActiveYear === lastActiveYear) {
    return 0;
  }

  // Calcul de la tendance GLOBALE (%)
  // Formule: ((Dernière - Première) / Première) × 100
  const trendPercent = ((lastActiveRevenue - firstActiveRevenue) / firstActiveRevenue) * 100;

  // Retourner arrondi à 1 décimale
  return Math.round(trendPercent * 10) / 10;
}

function calculateYearlyTrends(client) {
  // Calcule les tendances année par année de manière intelligente
  const years = ['2022', '2023', '2024', '2025'];
  const trends = {};

  years.forEach((year, index) => {
    if (index === 0) {
      // Première année : pas de tendance (pas d'année précédente)
      trends[year] = {
        value: null,
        label: 'N/A',
        description: 'Première année de référence',
        currentRevenue: client.years[year],
        previousRevenue: 0
      };
    } else {
      const currentYear = client.years[year];
      const previousYear = client.years[years[index - 1]];

      if (currentYear === 0 && previousYear === 0) {
        trends[year] = {
          value: 0,
          label: '—',
          description: 'Aucune activité',
          currentRevenue: 0,
          previousRevenue: 0
        };
      } else if (previousYear === 0 && currentYear > 0) {
        trends[year] = {
          value: 100,
          label: '🚀 Nouveau',
          description: 'Première activité',
          currentRevenue: currentYear,
          previousRevenue: 0
        };
      } else if (previousYear > 0 && currentYear === 0) {
        trends[year] = {
          value: -100,
          label: '⚠️ Arrêt',
          description: `Aucune activité (vs année précédente)`,
          currentRevenue: 0,
          previousRevenue: previousYear,
          previousYearLabel: years[index - 1]
        };
      } else {
        const growth = ((currentYear - previousYear) / previousYear) * 100;
        const rounded = Math.round(growth);

        let icon = '→';
        let label = 'Stable';
        if (rounded > 20) {
          icon = '↗';
          label = 'Forte croissance';
        } else if (rounded > 0) {
          icon = '↗';
          label = 'Croissance';
        } else if (rounded < -20) {
          icon = '↘';
          label = 'Forte baisse';
        } else if (rounded < 0) {
          icon = '↘';
          label = 'Baisse';
        }

        trends[year] = {
          value: rounded,
          label: `${icon} ${rounded > 0 ? '+' : ''}${rounded}%`,
          description: label,
          currentRevenue: currentYear,
          previousRevenue: previousYear
        };
      }
    }
  });

  return trends;
}

function calculateScore(client) {
  let score = 0;

  // CA total (40 points max)
  score += Math.min((client.totalRevenue / 100000) * 40, 40);

  // Trend (30 points max)
  if (client.trend > 50) score += 30;
  else if (client.trend > 20) score += 20;
  else if (client.trend > 0) score += 10;
  else if (client.trend < -20) score -= 10;

  // Récence (20 points max)
  if (client.lastDealDate) {
    const daysSince = (new Date() - client.lastDealDate) / (1000 * 60 * 60 * 24);
    if (daysSince < 180) score += 20;
    else if (daysSince < 365) score += 10;
  }

  // Nombre de deals (10 points max)
  score += Math.min(client.dealCount * 2, 10);

  return Math.round(score);
}

function getSegment(client) {
  // Le segment est déjà calculé côté serveur avec l'algo enrichi!
  return client.segment || 'Régulier';
}

function getRecommendation(client) {
  if (client.segment === 'Stratégique') {
    return 'Revue trimestrielle + Montée en gamme';
  }
  if (client.segment === 'Clé') {
    return 'Suivi régulier + Vente croisée';
  }
  if (client.segment === 'À Risque') {
    return 'URGENT: Plan de rétention';
  }
  if (client.segment === 'Dormant') {
    return 'Campagne de réactivation';
  }
  return 'Maintenir la relation';
}

function getPriority(client) {
  if (client.score > 70) return 'high';
  if (client.score > 40) return 'medium';
  return 'low';
}

// ============================================================================
// Dashboard Rendering
// ============================================================================
function renderDashboard() {
  console.log('🚀 [v3.0 EVENT DELEGATION] Rendering dashboard...');
  console.log('📊 Filtres année secteurs: ACTIVÉS');
  console.log('🔄 Event delegation expand/collapse: ACTIVÉ');

  renderKPIs();
  renderRevenueGlobalChart();
  renderClientEvolutionChart();
  renderSegmentationTable();
  renderWhiteSpaces();
  renderIndustryPieChart();
  renderRecommendations();
  renderCompanyTree();
  renderAnalysis();
  initFilters();

  // Vérifier que les boutons de filtre année sont bien présents
  setTimeout(() => {
    const filterButtons = document.querySelectorAll('[data-industry-year]');
    console.log(`🔍 Vérification boutons filtre année: ${filterButtons.length} boutons trouvés`);
    if (filterButtons.length === 0) {
      console.error('❌ ERREUR: Aucun bouton de filtre année trouvé dans le DOM!');
    } else {
      console.log('   → Boutons:', Array.from(filterButtons).map(b => b.getAttribute('data-industry-year')));
    }
  }, 500);

  console.log('✅ Dashboard rendu complet');
}

// ============================================================================
// KPIs
// ============================================================================
function renderKPIs() {
  const totalRevenue = processedData.reduce((sum, c) => sum + c.totalRevenue, 0);
  const revenue2024 = processedData.reduce((sum, c) => sum + c.years['2024'], 0);
  const revenue2023 = processedData.reduce((sum, c) => sum + c.years['2023'], 0);
  const growth = revenue2023 > 0 ? ((revenue2024 - revenue2023) / revenue2023 * 100) : 0;

  const avgDeal = totalRevenue / processedData.reduce((sum, c) => sum + c.dealCount, 0);

  const strategicClients = processedData.filter(c => c.segment === 'Stratégique').length;
  const atRiskClients = processedData.filter(c => c.segment === 'À Risque').length;

  const kpis = [
    {
      label: 'CA Total',
      value: formatCurrency(totalRevenue),
      change: null
    },
    {
      label: 'CA 2024',
      value: formatCurrency(revenue2024),
      change: { value: growth.toFixed(1) + '%', positive: growth >= 0 }
    },
    {
      label: 'Nombre de Clients',
      value: processedData.length,
      change: null
    },
    {
      label: 'Ticket Moyen',
      value: formatCurrency(avgDeal),
      change: null
    }
  ];

  const kpiData = {
    'CA Total': { value: totalRevenue, context: 'total' },
    'CA 2024': { value: revenue2024, context: '2024', growth },
    'Nombre de Clients': { value: processedData.length, context: 'clients' },
    'Ticket Moyen': { value: avgDeal, context: 'ticket' }
  };

  const grid = document.getElementById('kpiGrid');
  grid.innerHTML = kpis.map((kpi, idx) => `
    <div class="kpi-card" onclick="showKPIDetails('${kpi.label}', ${JSON.stringify(kpiData[kpi.label]).replace(/'/g, "&#39;")})">
      <div class="kpi-label">${kpi.label}</div>
      <div class="kpi-value">${kpi.value}</div>
      ${kpi.change ? `
        <div class="kpi-change ${kpi.change.positive ? 'positive' : 'negative'}">
          ${kpi.change.positive ? '↗' : '↘'} ${kpi.change.value}
        </div>
      ` : ''}
    </div>
  `).join('');
}

// ============================================================================
// Show KPI Details
// ============================================================================
function showKPIDetails(label, data) {
  let content = '';

  switch(data.context) {
    case 'total':
      const years = ['2022', '2023', '2024', '2025'];
      const yearlyRevenues = years.map(y => ({
        year: y,
        revenue: processedData.reduce((sum, c) => sum + c.years[y], 0)
      }));

      content = `
        <div class="info-highlight">
          <div style="font-size: 24px; font-weight: 800; color: var(--accent);">
            ${formatCurrency(data.value)}
          </div>
          <div style="color: var(--text-muted); font-size: 13px;">Chiffre d'affaires total sur 4 ans</div>
        </div>

        <div style="margin-top: 20px;">
          <div style="color: var(--accent); font-weight: 700; margin-bottom: 12px;">Répartition par année</div>
          ${yearlyRevenues.map(yr => `
            <div class="info-row">
              <span class="info-label">${yr.year}</span>
              <span class="info-value" style="color: var(--green);">${formatCurrency(yr.revenue)}</span>
            </div>
          `).join('')}
        </div>
      `;
      break;

    case '2024':
      const top5_2024 = processedData
        .filter(c => c.years['2024'] > 0)
        .sort((a, b) => b.years['2024'] - a.years['2024'])
        .slice(0, 5);

      content = `
        <div class="info-highlight">
          <div style="font-size: 24px; font-weight: 800; color: var(--accent);">
            ${formatCurrency(data.value)}
          </div>
          <div style="color: var(--text-muted); font-size: 13px;">Chiffre d'affaires 2024</div>
        </div>

        <div class="info-row">
          <span class="info-label">Croissance vs 2023</span>
          <span class="info-value" style="color: ${data.growth >= 0 ? 'var(--green)' : 'var(--red)'}">
            ${data.growth >= 0 ? '+' : ''}${data.growth.toFixed(1)}%
          </span>
        </div>

        <div style="margin-top: 20px; padding-top: 16px; border-top: 2px solid var(--border);">
          <div style="color: var(--accent); font-weight: 700; margin-bottom: 12px;">Top 5 Clients 2024</div>
          ${top5_2024.map((c, i) => `
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
              <span>${i + 1}. ${c.name}</span>
              <span style="color: var(--green); font-weight: 700;">${formatCurrency(c.years['2024'])}</span>
            </div>
          `).join('')}
        </div>
      `;
      break;

    case 'clients':
      const segments = {
        'Stratégique': processedData.filter(c => c.segment === 'Stratégique').length,
        'Clé': processedData.filter(c => c.segment === 'Clé').length,
        'Régulier': processedData.filter(c => c.segment === 'Régulier').length,
        'À Risque': processedData.filter(c => c.segment === 'À Risque').length,
        'Dormant': processedData.filter(c => c.segment === 'Dormant').length
      };

      content = `
        <div class="info-highlight">
          <div style="font-size: 24px; font-weight: 800; color: var(--accent);">
            ${data.value} clients
          </div>
          <div style="color: var(--text-muted); font-size: 13px;">Dans le portefeuille</div>
        </div>

        <div style="margin-top: 20px;">
          <div style="color: var(--accent); font-weight: 700; margin-bottom: 12px;">Répartition par segment</div>
          ${Object.entries(segments).map(([seg, count]) => `
            <div class="info-row">
              <span class="info-label">
                <span class="badge ${seg.toLowerCase().replace(' ', '-')}">${seg}</span>
              </span>
              <span class="info-value">${count}</span>
            </div>
          `).join('')}
        </div>
      `;
      break;

    case 'strategic':
      const strategicClients = processedData.filter(c => c.segment === 'Stratégique');
      const strategicRevenue = strategicClients.reduce((sum, c) => sum + c.totalRevenue, 0);

      content = `
        <div class="info-highlight">
          <div style="font-size: 24px; font-weight: 800; color: var(--purple);">
            ${data.value} clients
          </div>
          <div style="color: var(--text-muted); font-size: 13px;">Clients stratégiques</div>
        </div>

        <div class="info-row">
          <span class="info-label">CA Total généré</span>
          <span class="info-value" style="color: var(--green);">${formatCurrency(strategicRevenue)}</span>
        </div>

        <div class="info-row">
          <span class="info-label">% du CA total</span>
          <span class="info-value">${((strategicRevenue / processedData.reduce((sum, c) => sum + c.totalRevenue, 0)) * 100).toFixed(1)}%</span>
        </div>

        ${strategicClients.length > 0 ? `
        <div style="margin-top: 20px; padding-top: 16px; border-top: 2px solid var(--border);">
          <div style="color: var(--purple); font-weight: 700; margin-bottom: 12px;">Liste des clients</div>
          ${strategicClients.slice(0, 10).map(c => `
            <div style="padding: 6px 0; color: var(--text);">• ${c.name}</div>
          `).join('')}
        </div>
        ` : ''}
      `;
      break;

    case 'risk':
      const riskClients = processedData.filter(c => c.segment === 'À Risque');
      const riskRevenue = riskClients.reduce((sum, c) => sum + c.totalRevenue, 0);

      content = `
        <div class="info-highlight" style="border-left-color: var(--orange);">
          <div style="font-size: 24px; font-weight: 800; color: var(--orange);">
            ${data.value} clients
          </div>
          <div style="color: var(--text-muted); font-size: 13px;">Clients à risque - Action requise</div>
        </div>

        ${riskClients.length > 0 ? `
        <div class="info-row">
          <span class="info-label">CA en risque</span>
          <span class="info-value" style="color: var(--orange);">${formatCurrency(riskRevenue)}</span>
        </div>

        <div style="margin-top: 20px; padding: 12px; background: rgba(245, 158, 11, 0.1); border-radius: 8px; border-left: 4px solid var(--orange);">
          <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px; font-weight: 600;">
            ⚠️ Action urgente
          </div>
          <div style="font-size: 13px; color: var(--text);">
            Ces clients montrent une baisse significative. Planifier des revues immédiates.
          </div>
        </div>

        <div style="margin-top: 16px; padding-top: 16px; border-top: 2px solid var(--border);">
          <div style="color: var(--orange); font-weight: 700; margin-bottom: 12px;">Clients à contacter</div>
          ${riskClients.map(c => `
            <div style="padding: 8px 0; border-bottom: 1px solid var(--border);">
              <div style="color: var(--text); font-weight: 600;">${c.name}</div>
              <div style="font-size: 12px; color: var(--text-muted);">
                Baisse: ${c.trend.toFixed(1)}% • ${c.recommendation}
              </div>
            </div>
          `).join('')}
        </div>
        ` : `
        <div style="text-align: center; padding: 20px; color: var(--green);">
          ✓ Aucun client en situation critique
        </div>
        `}
      `;
      break;

    case 'ticket':
      const dealsPerYear = ['2022', '2023', '2024', '2025'].map(year => {
        const yearDeals = processedData.reduce((sum, c) => {
          return sum + c.deals.filter(d => d.year === year).length;
        }, 0);
        const yearRevenue = processedData.reduce((sum, c) => sum + c.years[year], 0);
        return {
          year,
          avgTicket: yearDeals > 0 ? yearRevenue / yearDeals : 0,
          deals: yearDeals
        };
      }).filter(y => y.deals > 0);

      content = `
        <div class="info-highlight">
          <div style="font-size: 24px; font-weight: 800; color: var(--accent);">
            ${formatCurrency(data.value)}
          </div>
          <div style="color: var(--text-muted); font-size: 13px;">Ticket moyen sur tous les deals</div>
        </div>

        <div style="margin-top: 20px;">
          <div style="color: var(--accent); font-weight: 700; margin-bottom: 12px;">Évolution du ticket moyen</div>
          ${dealsPerYear.map(y => `
            <div class="info-row">
              <span class="info-label">${y.year} (${y.deals} deals)</span>
              <span class="info-value">${formatCurrency(y.avgTicket)}</span>
            </div>
          `).join('')}
        </div>
      `;
      break;
  }

  openInfoPanel(label, content);
}

// ============================================================================
// Revenue Global Chart
// ============================================================================
function renderRevenueGlobalChart() {
  const years = ['2022', '2023', '2024', '2025'];
  const revenues = years.map(year =>
    processedData.reduce((sum, c) => sum + c.years[year], 0)
  );

  const svg = document.getElementById('chartRevenueGlobal');
  svg.innerHTML = '';

  const width = 800;
  const height = 300;
  const padding = 60;

  svg.setAttribute('viewBox', `0 0 ${width} ${height}`);

  const maxRevenue = Math.max(...revenues, 1);
  const minRevenue = Math.min(...revenues, 0);

  // Define gradient for area under curve
  const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
  const gradient = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
  gradient.setAttribute('id', 'areaGradient');
  gradient.setAttribute('x1', '0%');
  gradient.setAttribute('y1', '0%');
  gradient.setAttribute('x2', '0%');
  gradient.setAttribute('y2', '100%');

  const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
  stop1.setAttribute('offset', '0%');
  stop1.setAttribute('style', 'stop-color:#6366f1;stop-opacity:0.4');
  gradient.appendChild(stop1);

  const stop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
  stop2.setAttribute('offset', '100%');
  stop2.setAttribute('style', 'stop-color:#6366f1;stop-opacity:0.05');
  gradient.appendChild(stop2);

  defs.appendChild(gradient);
  svg.appendChild(defs);

  // Draw horizontal grid lines
  const gridLines = 5;
  for (let i = 0; i <= gridLines; i++) {
    const y = padding + (height - 2 * padding) * i / gridLines;
    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    line.setAttribute('x1', padding);
    line.setAttribute('y1', y);
    line.setAttribute('x2', width - padding);
    line.setAttribute('y2', y);
    line.setAttribute('stroke', '#334155');
    line.setAttribute('stroke-width', '1');
    line.setAttribute('opacity', '0.3');
    svg.appendChild(line);

    // Add value labels on left
    const value = maxRevenue - (maxRevenue * i / gridLines);
    const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    label.setAttribute('x', padding - 10);
    label.setAttribute('y', y + 4);
    label.setAttribute('text-anchor', 'end');
    label.setAttribute('fill', '#94a3b8');
    label.setAttribute('font-size', '11');
    label.textContent = formatCurrency(value, true);
    svg.appendChild(label);
  }

  // Calculate points for the line
  const points = years.map((year, i) => {
    const x = padding + (i / (years.length - 1)) * (width - 2 * padding);
    const y = padding + (height - 2 * padding) - ((revenues[i] / maxRevenue) * (height - 2 * padding));
    return { x, y, year, revenue: revenues[i], index: i };
  });

  // Create smooth curve path using quadratic bezier curves
  let pathD = `M ${points[0].x} ${points[0].y}`;
  for (let i = 0; i < points.length - 1; i++) {
    const p1 = points[i];
    const p2 = points[i + 1];
    const midX = (p1.x + p2.x) / 2;
    pathD += ` Q ${p1.x} ${p1.y}, ${midX} ${(p1.y + p2.y) / 2}`;
    pathD += ` Q ${p2.x} ${p2.y}, ${p2.x} ${p2.y}`;
  }

  // Draw filled area under curve
  const areaPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  areaPath.setAttribute('d', `${pathD} L ${points[points.length - 1].x} ${height - padding} L ${points[0].x} ${height - padding} Z`);
  areaPath.setAttribute('fill', 'url(#areaGradient)');
  svg.appendChild(areaPath);

  // Draw the main curve
  const curvePath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  curvePath.setAttribute('d', pathD);
  curvePath.setAttribute('stroke', '#6366f1');
  curvePath.setAttribute('stroke-width', '3');
  curvePath.setAttribute('fill', 'none');
  curvePath.setAttribute('stroke-linecap', 'round');
  curvePath.setAttribute('stroke-linejoin', 'round');
  svg.appendChild(curvePath);

  // Create tooltip
  const tooltip = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  tooltip.setAttribute('id', 'globalChartTooltip');
  tooltip.style.opacity = '0';
  tooltip.style.pointerEvents = 'none';
  tooltip.style.transition = 'opacity 0.2s';
  svg.appendChild(tooltip);

  const tooltipRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
  tooltipRect.setAttribute('rx', 8);
  tooltipRect.setAttribute('fill', '#1d2342');
  tooltipRect.setAttribute('stroke', '#6366f1');
  tooltipRect.setAttribute('stroke-width', 2);
  tooltip.appendChild(tooltipRect);

  const tooltipText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  tooltipText.setAttribute('fill', '#f1f5f9');
  tooltipText.setAttribute('font-size', '13');
  tooltipText.setAttribute('font-weight', '600');
  tooltip.appendChild(tooltipText);

  // Draw points and add interaction
  points.forEach((point, i) => {
    const { x, y, year, revenue, index } = point;

    // Outer circle (glow effect)
    const outerCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    outerCircle.setAttribute('cx', x);
    outerCircle.setAttribute('cy', y);
    outerCircle.setAttribute('r', '8');
    outerCircle.setAttribute('fill', '#6366f1');
    outerCircle.setAttribute('opacity', '0.3');
    svg.appendChild(outerCircle);

    // Main point circle
    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    circle.setAttribute('cx', x);
    circle.setAttribute('cy', y);
    circle.setAttribute('r', '5');
    circle.setAttribute('fill', '#6366f1');
    circle.setAttribute('stroke', '#f1f5f9');
    circle.setAttribute('stroke-width', '2');
    circle.style.cursor = 'pointer';
    circle.style.transition = 'all 0.2s';
    svg.appendChild(circle);

    // Tooltip interaction
    circle.addEventListener('mouseenter', function() {
      tooltip.style.opacity = '1';
      circle.setAttribute('r', '7');
      outerCircle.setAttribute('r', '12');

      const prevRevenue = i > 0 ? revenues[i - 1] : 0;
      const growth = prevRevenue > 0 ? (((revenue - prevRevenue) / prevRevenue) * 100).toFixed(1) : 0;
      const growthText = i > 0 ? ` (${growth > 0 ? '+' : ''}${growth}%)` : '';
      tooltipText.textContent = `${year}: ${formatCurrency(revenue)}${growthText}`;

      const textBBox = tooltipText.getBBox();
      const tooltipWidth = textBBox.width + 20;
      const tooltipHeight = textBBox.height + 16;

      tooltipRect.setAttribute('width', tooltipWidth);
      tooltipRect.setAttribute('height', tooltipHeight);

      const tooltipX = x - tooltipWidth / 2;
      const tooltipY = y - tooltipHeight - 15;

      tooltipRect.setAttribute('x', tooltipX);
      tooltipRect.setAttribute('y', tooltipY);
      tooltipText.setAttribute('x', tooltipX + 10);
      tooltipText.setAttribute('y', tooltipY + tooltipHeight / 2 + 5);
    });

    circle.addEventListener('mouseleave', function() {
      tooltip.style.opacity = '0';
      circle.setAttribute('r', '5');
      outerCircle.setAttribute('r', '8');
    });

    // Click handler for details
    circle.addEventListener('click', function() {
      const activeClients = processedData.filter(c => c.years[year] > 0);
      const avgDealSize = revenue / activeClients.reduce((sum, c) => {
        return sum + c.deals.filter(d => d.year === year).length;
      }, 0);

      const topClientsYear = activeClients
        .sort((a, b) => b.years[year] - a.years[year])
        .slice(0, 5);

      const prevRevenue = i > 0 ? revenues[i - 1] : 0;
      const growth = prevRevenue > 0 ? (((revenue - prevRevenue) / prevRevenue) * 100).toFixed(1) : 0;

      const infoContent = `
        <div class="info-highlight">
          <div style="font-size: 24px; font-weight: 800; color: var(--accent); margin-bottom: 8px;">
            ${formatCurrency(revenue)}
          </div>
          <div style="color: var(--text-muted); font-size: 13px;">Chiffre d'affaires ${year}</div>
        </div>

        <div class="info-row">
          <span class="info-label">Nombre de clients actifs</span>
          <span class="info-value">${activeClients.length}</span>
        </div>

        <div class="info-row">
          <span class="info-label">Taille moyenne deal</span>
          <span class="info-value">${formatCurrency(avgDealSize)}</span>
        </div>

        <div class="info-row">
          <span class="info-label">Croissance vs ${parseInt(year) - 1}</span>
          <span class="info-value" style="color: ${growth > 0 ? 'var(--green)' : 'var(--red)'}">
            ${growth > 0 ? '+' : ''}${growth}%
          </span>
        </div>

        <div style="margin-top: 20px; padding-top: 16px; border-top: 2px solid var(--border);">
          <div style="color: var(--accent); font-weight: 700; margin-bottom: 12px; font-size: 14px;">
            Top 5 Clients ${year}
          </div>
          ${topClientsYear.map((client, idx) => `
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
              <span style="color: var(--text);">${idx + 1}. ${client.name}</span>
              <span style="color: var(--green); font-weight: 700;">${formatCurrency(client.years[year])}</span>
            </div>
          `).join('')}
        </div>
      `;

      openInfoPanel(`Détails ${year}`, infoContent);
    });

    // Year label below X axis
    const yearText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    yearText.setAttribute('x', x);
    yearText.setAttribute('y', height - padding + 25);
    yearText.setAttribute('text-anchor', 'middle');
    yearText.setAttribute('fill', '#94a3b8');
    yearText.setAttribute('font-size', '13');
    yearText.setAttribute('font-weight', '600');
    yearText.textContent = year;
    svg.appendChild(yearText);

    // Value label above point
    const valueText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    valueText.setAttribute('x', x);
    valueText.setAttribute('y', y - 15);
    valueText.setAttribute('text-anchor', 'middle');
    valueText.setAttribute('fill', '#6366f1');
    valueText.setAttribute('font-size', '12');
    valueText.setAttribute('font-weight', '700');
    valueText.textContent = formatCurrency(revenue, true);
    svg.appendChild(valueText);
  });
}

// ============================================================================
// Client Evolution Chart (Grouped Bars with Tooltips)
// ============================================================================
function renderClientEvolutionChart() {
  const topClients = processedData.slice(0, 10);
  const years = ['2022', '2023', '2024', '2025'];

  const svg = document.getElementById('chartClientEvolution');
  svg.innerHTML = '';

  const width = 1400;
  const height = 400;
  const padding = 80;
  const chartWidth = width - 2 * padding;
  const chartHeight = height - 2 * padding;

  svg.setAttribute('viewBox', `0 0 ${width} ${height}`);

  // Find max revenue
  const maxRevenue = Math.max(...topClients.flatMap(c =>
    years.map(y => c.years[y])
  ), 1);

  const colors = ['#6366f1', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#ec4899', '#f97316', '#84cc16', '#a855f7'];

  // Create tooltip
  const tooltip = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  tooltip.setAttribute('id', 'chartTooltip');
  tooltip.style.opacity = '0';
  tooltip.style.pointerEvents = 'none';
  tooltip.style.transition = 'opacity 0.2s';
  svg.appendChild(tooltip);

  const tooltipRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
  tooltipRect.setAttribute('rx', 8);
  tooltipRect.setAttribute('fill', '#1d2342');
  tooltipRect.setAttribute('stroke', '#6366f1');
  tooltipRect.setAttribute('stroke-width', 2);
  tooltip.appendChild(tooltipRect);

  const tooltipText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  tooltipText.setAttribute('fill', '#f1f5f9');
  tooltipText.setAttribute('font-size', '13');
  tooltipText.setAttribute('font-weight', '600');
  tooltip.appendChild(tooltipText);

  // Draw grid lines
  for (let i = 0; i <= 5; i++) {
    const y = padding + (chartHeight / 5) * i;
    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    line.setAttribute('x1', padding);
    line.setAttribute('y1', y);
    line.setAttribute('x2', width - padding);
    line.setAttribute('y2', y);
    line.setAttribute('stroke', '#1e293b');
    line.setAttribute('stroke-width', 1);
    svg.appendChild(line);
  }

  const barGroupWidth = chartWidth / years.length;
  const barWidth = (barGroupWidth * 0.8) / topClients.length;
  const barGap = 2;

  // Draw bars for each year
  years.forEach((year, yearIdx) => {
    topClients.forEach((client, clientIdx) => {
      const revenue = client.years[year];
      if (revenue === 0) return;

      const barHeight = (revenue / maxRevenue) * chartHeight;
      const x = padding + yearIdx * barGroupWidth + clientIdx * (barWidth + barGap) + (barGroupWidth * 0.1);
      const y = padding + chartHeight - barHeight;

      const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      rect.setAttribute('x', x);
      rect.setAttribute('y', y);
      rect.setAttribute('width', barWidth);
      rect.setAttribute('height', barHeight);
      rect.setAttribute('rx', 3);
      rect.setAttribute('fill', colors[clientIdx]);
      rect.classList.add('bar');
      rect.style.cursor = 'pointer';

      // Tooltip interaction
      rect.addEventListener('mouseenter', function(e) {
        tooltip.style.opacity = '1';
        tooltipText.textContent = `${client.name}: ${formatCurrency(revenue)} (${year})`;

        const textBBox = tooltipText.getBBox();
        const tooltipWidth = textBBox.width + 20;
        const tooltipHeight = textBBox.height + 16;

        tooltipRect.setAttribute('width', tooltipWidth);
        tooltipRect.setAttribute('height', tooltipHeight);

        let tooltipX = x + barWidth / 2 - tooltipWidth / 2;
        let tooltipY = y - tooltipHeight - 10;

        if (tooltipX < padding) tooltipX = padding;
        if (tooltipX + tooltipWidth > width - padding) tooltipX = width - padding - tooltipWidth;
        if (tooltipY < padding) tooltipY = y + barHeight + 10;

        tooltipRect.setAttribute('x', tooltipX);
        tooltipRect.setAttribute('y', tooltipY);
        tooltipText.setAttribute('x', tooltipX + 10);
        tooltipText.setAttribute('y', tooltipY + tooltipHeight / 2 + 5);

        rect.style.opacity = '0.7';
        rect.style.filter = 'brightness(1.3)';
      });

      rect.addEventListener('mouseleave', function() {
        tooltip.style.opacity = '0';
        rect.style.opacity = '1';
        rect.style.filter = 'none';
      });

      // Click handler for client details
      rect.addEventListener('click', function() {
        const clientDeals = client.deals.filter(d => d.year === year);
        const prevYearRevenue = year === '2022' ? 0 : client.years[(parseInt(year) - 1).toString()];
        const yearGrowth = prevYearRevenue > 0 ? (((revenue - prevYearRevenue) / prevYearRevenue) * 100).toFixed(1) : 0;

        const infoContent = `
          <div class="info-highlight">
            <div style="font-size: 20px; font-weight: 800; color: var(--accent); margin-bottom: 8px;">
              ${client.name}
            </div>
            <div style="color: var(--text-muted); font-size: 13px;">Année ${year}</div>
          </div>

          <div class="info-row">
            <span class="info-label">CA ${year}</span>
            <span class="info-value" style="color: var(--green);">${formatCurrency(revenue)}</span>
          </div>

          <div class="info-row">
            <span class="info-label">Nombre de deals</span>
            <span class="info-value">${clientDeals.length}</span>
          </div>

          <div class="info-row">
            <span class="info-label">Ticket moyen</span>
            <span class="info-value">${formatCurrency(revenue / clientDeals.length)}</span>
          </div>

          ${prevYearRevenue > 0 ? `
          <div class="info-row">
            <span class="info-label">Croissance vs ${parseInt(year) - 1}</span>
            <span class="info-value" style="color: ${yearGrowth > 0 ? 'var(--green)' : 'var(--red)'}">
              ${yearGrowth > 0 ? '+' : ''}${yearGrowth}%
            </span>
          </div>
          ` : ''}

          <div style="margin-top: 20px; padding-top: 16px; border-top: 2px solid var(--border);">
            <div style="color: var(--accent); font-weight: 700; margin-bottom: 12px; font-size: 14px;">
              Vue d'ensemble du client
            </div>

            <div class="info-row">
              <span class="info-label">Segment</span>
              <span class="info-value">
                <span class="badge ${client.segment.toLowerCase().replace(' ', '-')}">${client.segment}</span>
              </span>
            </div>

            <div class="info-row">
              <span class="info-label">Score global</span>
              <span class="info-value priority-${client.priority}">${client.score}/100</span>
            </div>

            <div class="info-row">
              <span class="info-label">CA Total (2022-2025)</span>
              <span class="info-value" style="color: var(--green);">${formatCurrency(client.totalRevenue)}</span>
            </div>

            <div class="info-row">
              <span class="info-label">Tendance globale</span>
              <span class="info-value" style="color: ${client.trend > 0 ? 'var(--green)' : 'var(--red)'}">
                ${client.trend > 10 ? '↗' : client.trend < -10 ? '↘' : '→'} ${client.trend.toFixed(1)}%
              </span>
            </div>

            <div style="margin-top: 12px; padding: 12px; background: rgba(99, 102, 241, 0.1); border-radius: 8px;">
              <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Recommandation:</div>
              <div style="font-size: 13px; font-weight: 600; color: var(--text);">${client.recommendation}</div>
            </div>
          </div>
        `;

        openInfoPanel(`${client.name} - ${year}`, infoContent);
      });

      svg.appendChild(rect);
    });

    // X-axis labels
    const labelX = padding + yearIdx * barGroupWidth + barGroupWidth / 2;
    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    text.setAttribute('x', labelX);
    text.setAttribute('y', height - padding + 25);
    text.setAttribute('text-anchor', 'middle');
    text.setAttribute('fill', '#94a3b8');
    text.setAttribute('font-size', '14');
    text.setAttribute('font-weight', '700');
    text.textContent = year;
    svg.appendChild(text);
  });

  // Legend
  const legend = document.getElementById('legendClientEvolution');
  legend.innerHTML = topClients.map((client, i) => `
    <div class="legend-item" style="cursor: pointer; transition: all 0.2s;"
         onmouseover="this.style.transform='scale(1.1)'"
         onmouseout="this.style.transform='scale(1)'">
      <div class="legend-color" style="background: ${colors[i]}"></div>
      <span>${client.name}</span>
    </div>
  `).join('');
}

// ============================================================================
// Donut Chart - Répartition CA par Segment
// ============================================================================
function renderSegmentDonutChart() {
  const svg = document.getElementById('chartSegmentDonut');
  if (!svg) return;
  svg.innerHTML = '';

  // Agrég données par segment
  const segmentData = {};
  processedData.forEach(client => {
    const segment = client.segment || 'Autre';
    if (!segmentData[segment]) {
      segmentData[segment] = { total: 0, color: client.segmentColor || '#94a3b8' };
    }
    segmentData[segment].total += client.totalRevenue;
  });

  const segments = Object.entries(segmentData)
    .map(([name, data]) => ({ name, ...data }))
    .filter(s => s.total > 0)
    .sort((a, b) => b.total - a.total);

  const total = segments.reduce((sum, s) => sum + s.total, 0);

  // Dimensions
  const cx = 300;
  const cy = 200;
  const radius = 120;
  const holeRadius = 70;

  let currentAngle = -Math.PI / 2;

  // Dessiner les segments
  segments.forEach((segment, i) => {
    const percentage = (segment.total / total) * 100;
    const angle = (segment.total / total) * 2 * Math.PI;
    const endAngle = currentAngle + angle;

    // Calculer les points du segment
    const x1 = cx + Math.cos(currentAngle) * holeRadius;
    const y1 = cy + Math.sin(currentAngle) * holeRadius;
    const x2 = cx + Math.cos(currentAngle) * radius;
    const y2 = cy + Math.sin(currentAngle) * radius;
    const x3 = cx + Math.cos(endAngle) * radius;
    const y3 = cy + Math.sin(endAngle) * radius;
    const x4 = cx + Math.cos(endAngle) * holeRadius;
    const y4 = cy + Math.sin(endAngle) * holeRadius;

    const largeArc = angle > Math.PI ? 1 : 0;

    const pathData = [
      `M ${x1} ${y1}`,
      `L ${x2} ${y2}`,
      `A ${radius} ${radius} 0 ${largeArc} 1 ${x3} ${y3}`,
      `L ${x4} ${y4}`,
      `A ${holeRadius} ${holeRadius} 0 ${largeArc} 0 ${x1} ${y1}`,
      'Z'
    ].join(' ');

    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.setAttribute('d', pathData);
    path.setAttribute('fill', segment.color);
    path.setAttribute('stroke', '#0f172a');
    path.setAttribute('stroke-width', '2');
    path.style.cursor = 'pointer';
    path.style.transition = 'transform 0.2s';

    path.addEventListener('mouseenter', function() {
      this.style.transform = 'scale(1.05)';
      this.style.transformOrigin = `${cx}px ${cy}px`;
    });
    path.addEventListener('mouseleave', function() {
      this.style.transform = 'scale(1)';
    });

    svg.appendChild(path);

    // Label
    const midAngle = currentAngle + angle / 2;
    const labelRadius = radius + 35;
    const labelX = cx + Math.cos(midAngle) * labelRadius;
    const labelY = cy + Math.sin(midAngle) * labelRadius;

    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    text.setAttribute('x', labelX);
    text.setAttribute('y', labelY);
    text.setAttribute('text-anchor', 'middle');
    text.setAttribute('fill', 'var(--text)');
    text.setAttribute('font-size', '12');
    text.setAttribute('font-weight', '600');
    text.textContent = `${segment.name} (${percentage.toFixed(1)}%)`;
    svg.appendChild(text);

    currentAngle = endAngle;
  });

  // Centre - afficher le total
  const centerText1 = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  centerText1.setAttribute('x', cx);
  centerText1.setAttribute('y', cy - 10);
  centerText1.setAttribute('text-anchor', 'middle');
  centerText1.setAttribute('fill', 'var(--accent)');
  centerText1.setAttribute('font-size', '16');
  centerText1.setAttribute('font-weight', '700');
  centerText1.textContent = 'CA Total';
  svg.appendChild(centerText1);

  const centerText2 = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  centerText2.setAttribute('x', cx);
  centerText2.setAttribute('y', cy + 15);
  centerText2.setAttribute('text-anchor', 'middle');
  centerText2.setAttribute('fill', 'var(--text)');
  centerText2.setAttribute('font-size', '18');
  centerText2.setAttribute('font-weight', '800');
  centerText2.textContent = formatCurrency(total);
  svg.appendChild(centerText2);
}

// ============================================================================
// Radar Chart - Top 5 Clients Multi-critères
// ============================================================================
function renderRadarChart() {
  const svg = document.getElementById('chartRadar');
  if (!svg) return;
  svg.innerHTML = '';

  const topClients = processedData.slice(0, 5);
  const criteria = ['CA Total', 'Health Score', 'Notes', 'Engagement', 'Tendance'];

  const cx = 350;
  const cy = 225;
  const maxRadius = 150;
  const numCriteria = criteria.length;

  // Normaliser les données (0-100)
  const normalize = (value, max) => Math.min(value / max * 100, 100);

  const normalized = topClients.map(client => ({
    name: client.name,
    color: ['#6366f1', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6'][processedData.indexOf(client) % 5],
    values: [
      normalize(client.totalRevenue, 200000), // CA max 200k
      client.avgHealthScore, // déjà sur 100
      normalize(client.totalNotes, 50), // max 50 notes
      normalize((client.engagementEmails + client.engagementCalls * 2 + client.engagementMeetings * 3), 100), // engagement
      normalize(client.trend + 50, 100) // tendance centrée à 0
    ]
  }));

  // Grilles concentriques
  [0.2, 0.4, 0.6, 0.8, 1].forEach(ratio => {
    const points = [];
    for (let i = 0; i < numCriteria; i++) {
      const angle = (i / numCriteria) * 2 * Math.PI - Math.PI / 2;
      const x = cx + Math.cos(angle) * maxRadius * ratio;
      const y = cy + Math.sin(angle) * maxRadius * ratio;
      points.push(`${x},${y}`);
    }
    const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
    polygon.setAttribute('points', points.join(' '));
    polygon.setAttribute('fill', 'none');
    polygon.setAttribute('stroke', 'rgba(148, 163, 184, 0.2)');
    polygon.setAttribute('stroke-width', '1');
    svg.appendChild(polygon);
  });

  // Axes
  for (let i = 0; i < numCriteria; i++) {
    const angle = (i / numCriteria) * 2 * Math.PI - Math.PI / 2;
    const x = cx + Math.cos(angle) * maxRadius;
    const y = cy + Math.sin(angle) * maxRadius;

    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    line.setAttribute('x1', cx);
    line.setAttribute('y1', cy);
    line.setAttribute('x2', x);
    line.setAttribute('y2', y);
    line.setAttribute('stroke', 'rgba(148, 163, 184, 0.3)');
    line.setAttribute('stroke-width', '1');
    svg.appendChild(line);

    // Labels
    const labelX = cx + Math.cos(angle) * (maxRadius + 30);
    const labelY = cy + Math.sin(angle) * (maxRadius + 30);
    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    text.setAttribute('x', labelX);
    text.setAttribute('y', labelY);
    text.setAttribute('text-anchor', 'middle');
    text.setAttribute('fill', 'var(--text)');
    text.setAttribute('font-size', '11');
    text.setAttribute('font-weight', '600');
    text.textContent = criteria[i];
    svg.appendChild(text);
  }

  // Polygones clients
  normalized.forEach(client => {
    const points = [];
    for (let i = 0; i < numCriteria; i++) {
      const angle = (i / numCriteria) * 2 * Math.PI - Math.PI / 2;
      const radius = (client.values[i] / 100) * maxRadius;
      const x = cx + Math.cos(angle) * radius;
      const y = cy + Math.sin(angle) * radius;
      points.push(`${x},${y}`);
    }

    const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
    polygon.setAttribute('points', points.join(' '));
    polygon.setAttribute('fill', client.color);
    polygon.setAttribute('fill-opacity', '0.2');
    polygon.setAttribute('stroke', client.color);
    polygon.setAttribute('stroke-width', '2');
    polygon.style.cursor = 'pointer';
    svg.appendChild(polygon);
  });

  // Légende
  normalized.forEach((client, i) => {
    const legendY = 30 + i * 20;
    const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
    rect.setAttribute('x', 20);
    rect.setAttribute('y', legendY);
    rect.setAttribute('width', 15);
    rect.setAttribute('height', 15);
    rect.setAttribute('fill', client.color);
    svg.appendChild(rect);

    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    text.setAttribute('x', 40);
    text.setAttribute('y', legendY + 12);
    text.setAttribute('fill', 'var(--text)');
    text.setAttribute('font-size', '12');
    text.textContent = client.name;
    svg.appendChild(text);
  });
}

// ============================================================================
// Stacked Area Chart - Évolution CA par Segment
// ============================================================================
function renderStackedAreaChart() {
  const svg = document.getElementById('chartStackedArea');
  if (!svg) return;
  svg.innerHTML = '';

  const years = ['2022', '2023', '2024', '2025'];
  const segments = [...new Set(processedData.map(c => c.segment))].filter(Boolean);

  // Données par segment et année
  const data = years.map(year => {
    const yearData = { year };
    let cumulative = 0;
    segments.forEach(segment => {
      const total = processedData
        .filter(c => c.segment === segment)
        .reduce((sum, c) => sum + (c.years[year] || 0), 0);
      cumulative += total;
      yearData[segment] = cumulative;
      yearData[`${segment}_base`] = cumulative - total;
    });
    return yearData;
  });

  const width = 800;
  const height = 350;
  const padding = 60;
  const chartWidth = width - 2 * padding;
  const chartHeight = height - 2 * padding - 40;

  const maxValue = Math.max(...data.map(d =>
    Math.max(...segments.map(s => d[s] || 0))
  ), 1);

  const segmentColors = {
    'Stratégique': '#6366f1',
    'Clé': '#22c55e',
    'Régulier': '#f59e0b',
    'À Risque': '#ef4444',
    'Dormant': '#94a3b8',
    'Prospect': '#8b5cf6'
  };

  // Grille
  [0, 0.25, 0.5, 0.75, 1].forEach(ratio => {
    const y = padding + chartHeight - ratio * chartHeight;
    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    line.setAttribute('x1', padding);
    line.setAttribute('y1', y);
    line.setAttribute('x2', width - padding);
    line.setAttribute('y2', y);
    line.setAttribute('stroke', 'rgba(148, 163, 184, 0.2)');
    line.setAttribute('stroke-width', '1');
    svg.appendChild(line);

    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    text.setAttribute('x', padding - 10);
    text.setAttribute('y', y + 4);
    text.setAttribute('text-anchor', 'end');
    text.setAttribute('fill', 'var(--text-muted)');
    text.setAttribute('font-size', '10');
    text.textContent = `${(maxValue * ratio / 1000).toFixed(0)}k€`;
    svg.appendChild(text);
  });

  // Aires empilées
  segments.reverse().forEach(segment => {
    const points = [];

    // Points supérieurs
    data.forEach((d, i) => {
      const x = padding + (i / (years.length - 1)) * chartWidth;
      const y = padding + chartHeight - ((d[segment] || 0) / maxValue) * chartHeight;
      points.push(`${x},${y}`);
    });

    // Points inférieurs (inversés)
    for (let i = data.length - 1; i >= 0; i--) {
      const d = data[i];
      const x = padding + (i / (years.length - 1)) * chartWidth;
      const y = padding + chartHeight - ((d[`${segment}_base`] || 0) / maxValue) * chartHeight;
      points.push(`${x},${y}`);
    }

    const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
    polygon.setAttribute('points', points.join(' '));
    polygon.setAttribute('fill', segmentColors[segment] || '#94a3b8');
    polygon.setAttribute('fill-opacity', '0.7');
    polygon.setAttribute('stroke', segmentColors[segment] || '#94a3b8');
    polygon.setAttribute('stroke-width', '2');
    svg.appendChild(polygon);
  });

  // Labels années
  years.forEach((year, i) => {
    const x = padding + (i / (years.length - 1)) * chartWidth;
    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    text.setAttribute('x', x);
    text.setAttribute('y', padding + chartHeight + 25);
    text.setAttribute('text-anchor', 'middle');
    text.setAttribute('fill', 'var(--text)');
    text.setAttribute('font-size', '12');
    text.setAttribute('font-weight', '600');
    text.textContent = year;
    svg.appendChild(text);
  });

  // Légende
  segments.reverse().forEach((segment, i) => {
    const legendX = 50 + Math.floor(i / 2) * 150;
    const legendY = height - 25 + (i % 2) * 20;

    const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
    rect.setAttribute('x', legendX);
    rect.setAttribute('y', legendY);
    rect.setAttribute('width', 15);
    rect.setAttribute('height', 15);
    rect.setAttribute('fill', segmentColors[segment] || '#94a3b8');
    svg.appendChild(rect);

    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    text.setAttribute('x', legendX + 20);
    text.setAttribute('y', legendY + 12);
    text.setAttribute('fill', 'var(--text)');
    text.setAttribute('font-size', '11');
    text.textContent = segment;
    svg.appendChild(text);
  });
}

// ============================================================================
// Health Trends Line Chart - Évolution Health Scores
// ============================================================================
function renderHealthTrendsChart() {
  const svg = document.getElementById('chartHealthTrends');
  if (!svg) return;
  svg.innerHTML = '';

  // Simuler évolution health score (données fictives basées sur tendances)
  const topClients = processedData.slice(0, 10);
  const years = ['2022', '2023', '2024', '2025'];

  const width = 800;
  const height = 350;
  const padding = 60;
  const chartWidth = width - 2 * padding;
  const chartHeight = height - 2 * padding - 40;

  // Grille
  [0, 25, 50, 75, 100].forEach(value => {
    const y = padding + chartHeight - (value / 100) * chartHeight;
    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    line.setAttribute('x1', padding);
    line.setAttribute('y1', y);
    line.setAttribute('x2', width - padding);
    line.setAttribute('y2', y);
    line.setAttribute('stroke', 'rgba(148, 163, 184, 0.2)');
    line.setAttribute('stroke-width', '1');
    svg.appendChild(line);

    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    text.setAttribute('x', padding - 10);
    text.setAttribute('y', y + 4);
    text.setAttribute('text-anchor', 'end');
    text.setAttribute('fill', 'var(--text-muted)');
    text.setAttribute('font-size', '10');
    text.textContent = value;
    svg.appendChild(text);
  });

  const colors = ['#6366f1', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#ec4899', '#f97316', '#84cc16', '#a855f7'];

  // Lignes pour chaque client
  topClients.forEach((client, clientIdx) => {
    const points = [];

    years.forEach((year, i) => {
      // Simuler score basé sur CA et tendance
      const revenue = client.years[year] || 0;
      const baseScore = client.avgHealthScore;
      const variation = (revenue > 0 ? Math.random() * 20 - 10 : -20);
      const score = Math.max(0, Math.min(100, baseScore + variation));

      const x = padding + (i / (years.length - 1)) * chartWidth;
      const y = padding + chartHeight - (score / 100) * chartHeight;
      points.push({ x, y, score, year });
    });

    // Ligne
    const pathData = points.map((p, i) =>
      `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`
    ).join(' ');

    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.setAttribute('d', pathData);
    path.setAttribute('fill', 'none');
    path.setAttribute('stroke', colors[clientIdx]);
    path.setAttribute('stroke-width', '2');
    path.style.cursor = 'pointer';
    svg.appendChild(path);

    // Points
    points.forEach(p => {
      const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      circle.setAttribute('cx', p.x);
      circle.setAttribute('cy', p.y);
      circle.setAttribute('r', '4');
      circle.setAttribute('fill', colors[clientIdx]);
      circle.setAttribute('stroke', '#0f172a');
      circle.setAttribute('stroke-width', '2');
      circle.style.cursor = 'pointer';
      svg.appendChild(circle);
    });
  });

  // Labels années
  years.forEach((year, i) => {
    const x = padding + (i / (years.length - 1)) * chartWidth;
    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    text.setAttribute('x', x);
    text.setAttribute('y', padding + chartHeight + 25);
    text.setAttribute('text-anchor', 'middle');
    text.setAttribute('fill', 'var(--text)');
    text.setAttribute('font-size', '12');
    text.setAttribute('font-weight', '600');
    text.textContent = year;
    svg.appendChild(text);
  });

  // Légende
  topClients.forEach((client, i) => {
    const legendX = 60 + Math.floor(i / 2) * 150;
    const legendY = height - 30 + (i % 2) * 18;

    const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
    rect.setAttribute('x', legendX);
    rect.setAttribute('y', legendY);
    rect.setAttribute('width', 12);
    rect.setAttribute('height', 12);
    rect.setAttribute('fill', colors[i]);
    svg.appendChild(rect);

    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    text.setAttribute('x', legendX + 18);
    text.setAttribute('y', legendY + 10);
    text.setAttribute('fill', 'var(--text)');
    text.setAttribute('font-size', '10');
    text.textContent = client.name;
    svg.appendChild(text);
  });
}

// ============================================================================
// Industry Pie Chart - Répartition par secteur d'activité
// ============================================================================
// Variable globale pour stocker le filtre année du graphique
let industryChartYear = 'all';

function renderIndustryPieChart(filterYear = 'all') {
  console.log(`📊 renderIndustryPieChart appelée avec filterYear: ${filterYear}`);

  // Filtrer les données par année si nécessaire
  let dataToUse = processedData;
  if (filterYear !== 'all') {
    console.log(`   → Filtrage par année ${filterYear}`);
    dataToUse = processedData.filter(client => client.years[filterYear] > 0);
    console.log(`   → ${dataToUse.length} clients après filtrage`);
  }

  // Mapping COMPLET EN→FR des industries HubSpot standards
  const industryMapping = {
    // Tech & IT
    'Computer Software': 'Logiciels & IT',
    'Information Technology and Services': 'Logiciels & IT',
    'IT Services and IT Consulting': 'Logiciels & IT',
    'Internet': 'Internet & Web',
    'Computer & Network Security': 'Cybersécurité',
    'Software Development': 'Développement logiciel',
    'Telecommunications': 'Télécommunications',

    // Finance & Banking
    'Financial Services': 'Services financiers',
    'Banking': 'Banque',
    'Insurance': 'Assurance',
    'Venture Capital & Private Equity': 'Capital-risque & Private Equity',
    'Investment Banking': 'Banque d\'investissement',
    'Investment Management': 'Gestion d\'actifs',

    // Manufacturing & Industrial
    'Manufacturing': 'Industrie & Manufacturing',
    'Industrial Automation': 'Automatisation industrielle',
    'Machinery': 'Machinerie',
    'Electrical/Electronic Manufacturing': 'Électronique',
    'Automotive': 'Automobile',
    'Aviation & Aerospace': 'Aéronautique & Spatial',

    // Retail & E-commerce
    'Retail': 'Commerce de détail',
    'E-commerce': 'E-commerce',
    'Consumer Goods': 'Biens de consommation',
    'Consumer Electronics': 'Électronique grand public',
    'Luxury Goods & Jewelry': 'Luxe & Joaillerie',
    'Apparel & Fashion': 'Mode & Habillement',

    // Healthcare & Pharma
    'Hospital & Health Care': 'Santé & Soins',
    'Medical Devices': 'Dispositifs médicaux',
    'Pharmaceuticals': 'Pharmaceutique',
    'Biotechnology': 'Biotechnologie',
    'Medical Practice': 'Pratique médicale',

    // Consulting & Services
    'Management Consulting': 'Conseil en management',
    'Marketing and Advertising': 'Marketing & Publicité',
    'Public Relations and Communications': 'Relations publiques',
    'Human Resources': 'Ressources humaines',
    'Business Consulting and Services': 'Conseil & Services',
    'Professional Services': 'Services professionnels',

    // Construction & Real Estate
    'Construction': 'BTP & Construction',
    'Real Estate': 'Immobilier',
    'Architecture & Planning': 'Architecture',
    'Civil Engineering': 'Génie civil',

    // Education
    'Education Management': 'Gestion éducative',
    'Higher Education': 'Enseignement supérieur',
    'E-Learning': 'E-learning',
    'Primary/Secondary Education': 'Enseignement primaire/secondaire',

    // Media & Entertainment
    'Media Production': 'Production média',
    'Entertainment': 'Divertissement',
    'Publishing': 'Édition',
    'Broadcast Media': 'Médias audiovisuels',

    // Transport & Logistics
    'Transportation/Trucking/Railroad': 'Transport',
    'Logistics and Supply Chain': 'Logistique',
    'Airlines/Aviation': 'Aviation',
    'Maritime': 'Maritime',

    // Hospitality & Food
    'Hospitality': 'Hôtellerie',
    'Restaurants': 'Restauration',
    'Food & Beverages': 'Agroalimentaire',
    'Food Production': 'Production alimentaire',

    // Energy & Environment
    'Oil & Energy': 'Pétrole & Énergie',
    'Renewable Energy': 'Énergies renouvelables',
    'Utilities': 'Services publics',
    'Environmental Services': 'Services environnementaux',

    // Government & Non-Profit
    'Government Administration': 'Administration publique',
    'Non-Profit Organization Management': 'Association',
    'International Affairs': 'Affaires internationales',

    // Legal
    'Law Practice': 'Juridique',
    'Legal Services': 'Services juridiques',

    // Agriculture
    'Farming': 'Agriculture',
    'Ranching': 'Élevage',

    // Other
    'Research': 'Recherche',
    'Security and Investigations': 'Sécurité & Investigation',
    'Sports': 'Sports',
    'Think Tanks': 'Think tanks',
    'Staffing and Recruiting': 'Recrutement',

    // ========================================================================
    // HUBSPOT UNDERSCORE FORMAT (uppercase with underscores)
    // ========================================================================

    // Tech & IT
    'COMPUTER_SOFTWARE': 'Logiciels & IT',
    'INFORMATION_TECHNOLOGY_AND_SERVICES': 'Logiciels & IT',
    'INFORMATION_SERVICES': 'Services informatiques',
    'COMPUTER_HARDWARE': 'Matériel informatique',
    'TELECOMMUNICATIONS': 'Télécommunications',
    'SEMICONDUCTORS': 'Semi-conducteurs',
    'DESIGN': 'Design & CAO',
    'E_LEARNING': 'E-learning',

    // Finance & Banking
    'FINANCIAL_SERVICES': 'Services financiers',
    'BANKING': 'Banque',
    'INSURANCE': 'Assurance',
    'CAPITAL_MARKETS': 'Marchés financiers',
    'ACCOUNTING': 'Comptabilité',

    // Manufacturing & Industrial
    'INDUSTRIAL_AUTOMATION': 'Automatisation industrielle',
    'AUTOMOTIVE': 'Automobile',
    'AVIATION_AEROSPACE': 'Aéronautique & Spatial',
    'AIRLINES_AVIATION': 'Aviation',
    'ELECTRICAL_ELECTRONIC_MANUFACTURING': 'Électronique',
    'MACHINERY': 'Machinerie',
    'MECHANICAL_OR_INDUSTRIAL_ENGINEERING': 'Ingénierie industrielle',
    'BUILDING_MATERIALS': 'Matériaux de construction',
    'CHEMICALS': 'Chimie',
    'PLASTICS': 'Plastiques',
    'PAPER_FOREST_PRODUCTS': 'Papier & Produits forestiers',
    'MINING_METALS': 'Mines & Métaux',
    'RAILROAD_MANUFACTURE': 'Fabrication ferroviaire',
    'DEFENSE_SPACE': 'Défense & Spatial',
    'MILITARY': 'Militaire',

    // Retail & Consumer
    'RETAIL': 'Commerce de détail',
    'CONSUMER_GOODS': 'Biens de consommation',
    'CONSUMER_ELECTRONICS': 'Électronique grand public',
    'LUXURY_GOODS_JEWELRY': 'Luxe & Joaillerie',
    'APPAREL_FASHION': 'Mode & Habillement',
    'COSMETICS': 'Cosmétiques',
    'TEXTILES': 'Textile',
    'FURNITURE': 'Ameublement',
    'SPORTING_GOODS': 'Articles de sport',
    'BUSINESS_SUPPLIES_AND_EQUIPMENT': 'Fournitures & Équipements',

    // Healthcare & Pharma
    'HOSPITAL_HEALTH_CARE': 'Santé & Soins',
    'MEDICAL_DEVICES': 'Dispositifs médicaux',
    'PHARMACEUTICALS': 'Pharmaceutique',
    'BIOTECHNOLOGY': 'Biotechnologie',
    'HEALTH_WELLNESS_AND_FITNESS': 'Santé & Bien-être',
    'VETERINARY': 'Vétérinaire',

    // Consulting & Services
    'MANAGEMENT_CONSULTING': 'Conseil en management',
    'MARKETING_AND_ADVERTISING': 'Marketing & Publicité',
    'HUMAN_RESOURCES': 'Ressources humaines',
    'STAFFING_AND_RECRUITING': 'Recrutement',
    'OUTSOURCING_OFFSHORING': 'Externalisation',
    'EVENTS_SERVICES': 'Événementiel',
    'MARKET_RESEARCH': 'Études de marché',

    // Construction & Real Estate
    'CONSTRUCTION': 'BTP & Construction',
    'REAL_ESTATE': 'Immobilier',
    'COMMERCIAL_REAL_ESTATE': 'Immobilier commercial',

    // Education
    'HIGHER_EDUCATION': 'Enseignement supérieur',

    // Media & Entertainment
    'MEDIA_PRODUCTION': 'Production média',
    'ENTERTAINMENT': 'Divertissement',
    'PUBLISHING': 'Édition',
    'BROADCAST_MEDIA': 'Médias audiovisuels',
    'ONLINE_MEDIA': 'Médias en ligne',
    'COMPUTER_GAMES': 'Jeux vidéo',
    'ARTS_AND_CRAFTS': 'Arts & Artisanat',

    // Transport & Logistics
    'TRANSPORTATION_TRUCKING_RAILROAD': 'Transport',
    'LOGISTICS_AND_SUPPLY_CHAIN': 'Logistique',
    'MARITIME': 'Maritime',

    // Hospitality & Food
    'HOSPITALITY': 'Hôtellerie',
    'FOOD_BEVERAGES': 'Agroalimentaire',
    'FOOD_PRODUCTION': 'Production alimentaire',
    'WINE_AND_SPIRITS': 'Vins & Spiritueux',
    'LEISURE_TRAVEL_TOURISM': 'Tourisme & Loisirs',
    'GAMBLING_CASINOS': 'Casinos & Jeux',

    // Energy & Environment
    'OIL_ENERGY': 'Pétrole & Énergie',
    'RENEWABLES_ENVIRONMENT': 'Énergies renouvelables',
    'UTILITIES': 'Services publics',
    'ENVIRONMENTAL_SERVICES': 'Services environnementaux',

    // Government & Non-Profit
    'GOVERNMENT_ADMINISTRATION': 'Administration publique',
    'NON_PROFIT_ORGANIZATION_MANAGEMENT': 'Association',
    'CIVIC_SOCIAL_ORGANIZATION': 'Organisation civique',
    'PHILANTHROPY': 'Philanthropie',
    'INTERNATIONAL_TRADE_AND_DEVELOPMENT': 'Commerce international',

    // Legal
    'LAW_PRACTICE': 'Juridique',

    // Agriculture
    'FARMING': 'Agriculture',

    // Other
    'RESEARCH': 'Recherche',
    'SECURITY_AND_INVESTIGATIONS': 'Sécurité & Investigation',

    // Fallback for unknown
    'PROSPECT': 'Prospect',
    'Client': 'Client'
  };

  // DEBUG: Logger toutes les industries trouvées
  const allIndustries = new Set();
  dataToUse.forEach(client => {
    if (client.companyIndustry) {
      allIndustries.add(client.companyIndustry);
    }
  });
  console.log('🔍 Industries EN trouvées (année: ' + filterYear + '):', Array.from(allIndustries).sort());

  // Regrouper par secteur avec mapping EN→FR
  const industryCounts = {};
  const industryRevenues = {};

  dataToUse.forEach(client => {
    // Utiliser le CA de l'année filtrée si spécifiée
    const revenue = filterYear === 'all' ? client.totalRevenue : (client.years[filterYear] || 0);
    const rawIndustry = client.companyIndustry || 'Non spécifié';
    // Utiliser le mapping, sinon garder la valeur originale
    const frenchIndustry = industryMapping[rawIndustry] || rawIndustry;

    industryCounts[frenchIndustry] = (industryCounts[frenchIndustry] || 0) + 1;
    industryRevenues[frenchIndustry] = (industryRevenues[frenchIndustry] || 0) + revenue; // FIX: Utiliser revenue filtré
  });

  console.log('📊 Industries FR après mapping:', Object.keys(industryCounts).sort());

  // Calculer le CA total pour les pourcentages
  const totalRevenue = Object.values(industryRevenues).reduce((sum, rev) => sum + rev, 0);

  // Convertir en array et trier par CA (revenue)
  const industries = Object.keys(industryCounts)
    .map(name => ({
      name,
      count: industryCounts[name],
      revenue: industryRevenues[name],
      percentage: totalRevenue > 0 ? (industryRevenues[name] / totalRevenue * 100).toFixed(1) : 0
    }))
    .sort((a, b) => b.revenue - a.revenue); // Tri par CA, pas par nombre de clients

  // Palette de couleurs
  const colors = [
    '#6366f1', // Violet
    '#22c55e', // Vert
    '#f59e0b', // Orange
    '#ec4899', // Rose
    '#14b8a6', // Teal
    '#8b5cf6', // Purple
    '#f97316', // Orange foncé
    '#06b6d4', // Cyan
    '#84cc16', // Lime
    '#ef4444', // Rouge
    '#a855f7', // Violet clair
    '#10b981'  // Vert émeraude
  ];

  const svg = document.getElementById('chartIndustryPie');
  svg.innerHTML = '';

  const width = 800;
  const height = 400;
  const radius = Math.min(width, height) / 2 - 40;
  const centerX = width / 2;
  const centerY = height / 2;

  svg.setAttribute('viewBox', `0 0 ${width} ${height}`);

  // Create tooltip
  const tooltip = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  tooltip.setAttribute('id', 'industryTooltip');
  tooltip.style.opacity = '0';
  tooltip.style.pointerEvents = 'none';
  tooltip.style.transition = 'opacity 0.2s';
  svg.appendChild(tooltip);

  const tooltipRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
  tooltipRect.setAttribute('rx', 8);
  tooltipRect.setAttribute('fill', '#1d2342');
  tooltipRect.setAttribute('stroke', '#6366f1');
  tooltipRect.setAttribute('stroke-width', 2);
  tooltip.appendChild(tooltipRect);

  const tooltipText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  tooltipText.setAttribute('fill', '#f1f5f9');
  tooltipText.setAttribute('font-size', '12');
  tooltipText.setAttribute('font-weight', '600');
  tooltip.appendChild(tooltipText);

  // Draw pie slices
  let startAngle = -Math.PI / 2; // Commence en haut

  industries.forEach((industry, idx) => {
    const sliceAngle = (industry.revenue / totalRevenue) * 2 * Math.PI;
    const endAngle = startAngle + sliceAngle;
    const midAngle = startAngle + sliceAngle / 2;

    // Calculate path
    const x1 = centerX + radius * Math.cos(startAngle);
    const y1 = centerY + radius * Math.sin(startAngle);
    const x2 = centerX + radius * Math.cos(endAngle);
    const y2 = centerY + radius * Math.sin(endAngle);

    const largeArcFlag = sliceAngle > Math.PI ? 1 : 0;

    const pathData = [
      `M ${centerX} ${centerY}`,
      `L ${x1} ${y1}`,
      `A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2}`,
      'Z'
    ].join(' ');

    const slice = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    slice.setAttribute('d', pathData);
    slice.setAttribute('fill', colors[idx % colors.length]);
    slice.style.cursor = 'pointer';
    slice.style.transition = 'all 0.2s';
    slice.setAttribute('opacity', '0.9');

    // Hover effects
    slice.addEventListener('mouseenter', function() {
      this.setAttribute('opacity', '1');
      this.setAttribute('transform', `translate(${Math.cos(midAngle) * 10}, ${Math.sin(midAngle) * 10})`);

      tooltip.style.opacity = '1';
      tooltipText.textContent = `${industry.name}: ${formatCurrency(industry.revenue)} (${industry.percentage}% du CA)`;

      const textBBox = tooltipText.getBBox();
      const tooltipWidth = textBBox.width + 20;
      const tooltipHeight = textBBox.height + 16;

      tooltipRect.setAttribute('width', tooltipWidth);
      tooltipRect.setAttribute('height', tooltipHeight);

      const tooltipX = centerX - tooltipWidth / 2;
      const tooltipY = 20;

      tooltipRect.setAttribute('x', tooltipX);
      tooltipRect.setAttribute('y', tooltipY);
      tooltipText.setAttribute('x', tooltipX + 10);
      tooltipText.setAttribute('y', tooltipY + tooltipHeight / 2 + 5);
    });

    slice.addEventListener('mouseleave', function() {
      this.setAttribute('opacity', '0.9');
      this.setAttribute('transform', '');
      tooltip.style.opacity = '0';
    });

    // Click event pour afficher les détails du secteur
    slice.addEventListener('click', function() {
      console.log(`🖱️ Clic sur secteur: ${industry.name}`);
      showIndustryDetails(industry.name, filterYear);
    });

    svg.appendChild(slice);

    // Add percentage label si slice assez grand
    if (industry.percentage > 5) {
      const labelRadius = radius * 0.7;
      const labelX = centerX + labelRadius * Math.cos(midAngle);
      const labelY = centerY + labelRadius * Math.sin(midAngle);

      const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      label.setAttribute('x', labelX);
      label.setAttribute('y', labelY);
      label.setAttribute('text-anchor', 'middle');
      label.setAttribute('fill', 'white');
      label.setAttribute('font-size', '12');
      label.setAttribute('font-weight', '700');
      label.textContent = `${industry.percentage}%`;
      svg.appendChild(label);
    }

    startAngle = endAngle;
  });

  // Render legend
  const legend = document.getElementById('legendIndustryPie');
  legend.innerHTML = industries.map((industry, idx) => `
    <div style="display: flex; align-items: center; gap: 8px; padding: 6px 12px; background: var(--card); border-radius: 6px;">
      <div style="width: 12px; height: 12px; border-radius: 50%; background: ${colors[idx % colors.length]};"></div>
      <span style="color: var(--text); font-size: 11px; font-weight: 500;">${industry.name} (${industry.count})</span>
    </div>
  `).join('');
}

// ============================================================================
// Show Industry Details - Afficher détails d'un secteur au clic
// ============================================================================
function showIndustryDetails(industryNameFr, filterYear = 'all') {
  console.log(`📊 showIndustryDetails: ${industryNameFr}, année: ${filterYear}`);

  // Filtrer les clients de ce secteur
  let dataToUse = processedData;
  if (filterYear !== 'all') {
    dataToUse = processedData.filter(client => client.years[filterYear] > 0);
  }

  // Mapping inversé pour retrouver les codes HubSpot depuis le nom français
  const industryMapping = {
    // Tech & IT
    'Logiciels & IT': ['Computer Software', 'Information Technology and Services', 'IT Services and IT Consulting', 'COMPUTER_SOFTWARE', 'INFORMATION_TECHNOLOGY_AND_SERVICES', 'SOFTWARE_DEVELOPMENT'],
    'Internet & Web': ['Internet', 'INTERNET'],
    'Cybersécurité': ['Computer & Network Security', 'COMPUTER_NETWORK_SECURITY'],
    'Développement logiciel': ['Software Development', 'SOFTWARE_DEVELOPMENT'],
    'Télécommunications': ['Telecommunications', 'TELECOMMUNICATIONS'],

    // Finance & Banking
    'Services financiers': ['Financial Services', 'FINANCIAL_SERVICES'],
    'Banque': ['Banking', 'BANKING'],
    'Assurance': ['Insurance', 'INSURANCE'],
    'Capital-risque & Private Equity': ['Venture Capital & Private Equity', 'VENTURE_CAPITAL_PRIVATE_EQUITY'],
    'Banque d\'investissement': ['Investment Banking', 'INVESTMENT_BANKING'],
    'Gestion d\'actifs': ['Investment Management', 'INVESTMENT_MANAGEMENT'],

    // Manufacturing & Industrial
    'Industrie & Manufacturing': ['Manufacturing', 'MANUFACTURING'],
    'Automatisation industrielle': ['Industrial Automation', 'INDUSTRIAL_AUTOMATION'],
    'Machinerie': ['Machinery', 'MACHINERY'],
    'Électronique': ['Electrical/Electronic Manufacturing', 'ELECTRICAL_ELECTRONIC_MANUFACTURING'],
    'Automobile': ['Automotive', 'AUTOMOTIVE'],
    'Aéronautique & Spatial': ['Aviation & Aerospace', 'AVIATION_AEROSPACE'],

    // Retail & E-commerce
    'Commerce de détail': ['Retail', 'RETAIL'],
    'E-commerce': ['E-commerce', 'ECOMMERCE'],
    'Biens de consommation': ['Consumer Goods', 'CONSUMER_GOODS'],
    'Électronique grand public': ['Consumer Electronics', 'CONSUMER_ELECTRONICS'],
    'Luxe & Joaillerie': ['Luxury Goods & Jewelry', 'LUXURY_GOODS_JEWELRY'],
    'Mode & Habillement': ['Apparel & Fashion', 'APPAREL_FASHION'],

    // Healthcare & Pharma
    'Santé & Soins': ['Hospital & Health Care', 'HOSPITAL_HEALTH_CARE'],
    'Dispositifs médicaux': ['Medical Devices', 'MEDICAL_DEVICES'],
    'Pharmaceutique': ['Pharmaceuticals', 'PHARMACEUTICALS'],
    'Biotechnologie': ['Biotechnology', 'BIOTECHNOLOGY'],
    'Pratique médicale': ['Medical Practice', 'MEDICAL_PRACTICE'],

    // Consulting & Services
    'Conseil en management': ['Management Consulting', 'MANAGEMENT_CONSULTING'],
    'Marketing & Publicité': ['Marketing and Advertising', 'MARKETING_ADVERTISING'],
    'Relations publiques': ['Public Relations and Communications', 'PUBLIC_RELATIONS_COMMUNICATIONS'],
    'Ressources humaines': ['Human Resources', 'HUMAN_RESOURCES'],
    'Conseil & Services': ['Business Consulting and Services', 'BUSINESS_CONSULTING_SERVICES'],
    'Services professionnels': ['Professional Services', 'PROFESSIONAL_SERVICES'],

    // Construction & Real Estate
    'BTP & Construction': ['Construction', 'CONSTRUCTION'],
    'Immobilier': ['Real Estate', 'REAL_ESTATE'],
    'Architecture': ['Architecture & Planning', 'ARCHITECTURE_PLANNING'],
    'Génie civil': ['Civil Engineering', 'CIVIL_ENGINEERING'],

    // Education
    'Gestion éducative': ['Education Management', 'EDUCATION_MANAGEMENT'],
    'Enseignement supérieur': ['Higher Education', 'HIGHER_EDUCATION'],
    'E-learning': ['E-Learning', 'ELEARNING'],
    'Enseignement primaire/secondaire': ['Primary/Secondary Education', 'PRIMARY_SECONDARY_EDUCATION'],

    // Media & Entertainment
    'Production média': ['Media Production', 'MEDIA_PRODUCTION'],
    'Divertissement': ['Entertainment', 'ENTERTAINMENT'],
    'Édition': ['Publishing', 'PUBLISHING'],
    'Médias audiovisuels': ['Broadcast Media', 'BROADCAST_MEDIA'],

    // Transport & Logistics
    'Transport': ['Transportation/Trucking/Railroad', 'TRANSPORTATION_TRUCKING_RAILROAD'],
    'Logistique': ['Logistics and Supply Chain', 'LOGISTICS_SUPPLY_CHAIN'],
    'Aviation': ['Airlines/Aviation', 'AIRLINES_AVIATION'],
    'Maritime': ['Maritime', 'MARITIME'],

    // Hospitality & Food
    'Hôtellerie': ['Hospitality', 'HOSPITALITY'],
    'Restauration': ['Restaurants', 'RESTAURANTS'],
    'Agroalimentaire': ['Food & Beverages', 'FOOD_BEVERAGES'],
    'Production alimentaire': ['Food Production', 'FOOD_PRODUCTION'],

    // Energy & Environment
    'Pétrole & Énergie': ['Oil & Energy', 'OIL_ENERGY'],
    'Énergies renouvelables': ['Renewable Energy', 'RENEWABLE_ENERGY'],
    'Services publics': ['Utilities', 'UTILITIES'],
    'Services environnementaux': ['Environmental Services', 'ENVIRONMENTAL_SERVICES'],

    // Government & Non-Profit
    'Administration publique': ['Government Administration', 'GOVERNMENT_ADMINISTRATION'],
    'Association': ['Non-Profit Organization Management', 'NONPROFIT_ORGANIZATION_MANAGEMENT'],

    // Other
    'Non spécifié': ['', null, undefined]
  };

  // Trouver les codes HubSpot correspondants
  const hubspotCodes = industryMapping[industryNameFr] || [industryNameFr];

  // Filtrer les clients de ce secteur
  const clientsInIndustry = dataToUse.filter(client => {
    const clientIndustry = client.companyIndustry || '';
    return hubspotCodes.some(code =>
      code === clientIndustry ||
      clientIndustry === industryNameFr ||
      clientIndustry === '' && industryNameFr === 'Non spécifié'
    );
  });

  console.log(`   → ${clientsInIndustry.length} clients trouvés dans ${industryNameFr}`);

  // Calculer le CA total
  const totalRevenue = clientsInIndustry.reduce((sum, client) => {
    if (filterYear === 'all') {
      return sum + client.totalRevenue;
    } else {
      return sum + (client.years[filterYear] || 0);
    }
  }, 0);

  // Trier par CA décroissant
  clientsInIndustry.sort((a, b) => {
    const revenueA = filterYear === 'all' ? a.totalRevenue : (a.years[filterYear] || 0);
    const revenueB = filterYear === 'all' ? b.totalRevenue : (b.years[filterYear] || 0);
    return revenueB - revenueA;
  });

  // Générer le contenu HTML
  const yearText = filterYear === 'all' ? 'Toutes années' : `Année ${filterYear}`;

  const content = `
    <!-- Header -->
    <div class="info-highlight" style="margin-bottom: 24px;">
      <div style="font-size: 24px; font-weight: 800; color: var(--accent); margin-bottom: 8px;">
        ${industryNameFr}
      </div>
      <div style="color: var(--text-muted); margin-bottom: 12px;">
        ${yearText}
      </div>
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-top: 16px;">
        <div style="background: var(--bg-card); padding: 16px; border-radius: 8px;">
          <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">CA Total</div>
          <div style="font-size: 24px; font-weight: 800; color: var(--accent);">${formatCurrency(totalRevenue)}</div>
        </div>
        <div style="background: var(--bg-card); padding: 16px; border-radius: 8px;">
          <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Nombre de clients</div>
          <div style="font-size: 24px; font-weight: 800; color: var(--green);">${clientsInIndustry.length}</div>
        </div>
      </div>
    </div>

    <!-- Liste des clients -->
    <div style="margin-bottom: 16px;">
      <h4 style="color: var(--text); font-size: 16px; margin-bottom: 12px;">Clients de ce secteur:</h4>
      ${clientsInIndustry.length === 0 ?
        '<div style="color: var(--text-muted); font-style: italic; padding: 20px; text-align: center;">Aucun client dans ce secteur pour cette période</div>' :
        `<div style="max-height: 400px; overflow-y: auto;">
          ${clientsInIndustry.map((client, idx) => {
            const revenue = filterYear === 'all' ? client.totalRevenue : (client.years[filterYear] || 0);
            const percentage = totalRevenue > 0 ? ((revenue / totalRevenue) * 100).toFixed(1) : 0;

            return `
              <div class="info-row" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.2s;"
                   onmouseover="this.style.background='rgba(99, 102, 241, 0.05)'"
                   onmouseout="this.style.background='transparent'"
                   onclick="closeInfoPanel(); setTimeout(() => showClientDetails(${processedData.indexOf(client)}), 100)">
                <div style="flex: 1;">
                  <div style="font-weight: 700; color: var(--text); margin-bottom: 4px;">
                    ${idx + 1}. ${client.name}
                  </div>
                  <div style="font-size: 11px; color: var(--text-muted);">
                    ${client.domain || 'N/A'} • Health Score: ${client.avgHealthScore}/100
                  </div>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 18px; font-weight: 800; color: var(--accent);">
                    ${formatCurrency(revenue)}
                  </div>
                  <div style="font-size: 11px; color: var(--text-muted);">
                    ${percentage}% du secteur
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>`
      }
    </div>
  `;

  openInfoPanel(`Secteur: ${industryNameFr}`, content);
}

// Fonction de filtrage par année pour le graphique des secteurs
function filterIndustryChart(year) {
  console.log(`🎯 filterIndustryChart APPELÉE avec année: ${year}`);
  console.log(`   → Type de year: ${typeof year}`);

  // Mettre à jour les styles des boutons
  const buttons = document.querySelectorAll('[data-industry-year]');
  buttons.forEach(btn => {
    const btnYear = btn.getAttribute('data-industry-year');
    if (btnYear === year) {
      btn.style.background = 'var(--accent)';
      btn.style.color = 'white';
      btn.style.fontWeight = '600';
    } else {
      btn.style.background = 'rgba(99, 102, 241, 0.1)';
      btn.style.color = 'var(--text)';
      btn.style.fontWeight = '400';
    }
  });

  // Stocker le filtre actuel
  industryChartYear = year;

  // Re-render le graphique avec le filtre
  renderIndustryPieChart(year);
}

// Exposer globalement pour les onclick HTML
window.filterIndustryChart = filterIndustryChart;
console.log('✅ window.filterIndustryChart exposée globalement');

// ============================================================================
// Company Relationships Tree - Organigramme des relations (CROSS-SELL)
// ============================================================================
function renderCompanyTree() {
  // Utiliser les VRAIES associations parent/child HubSpot + détecter opportunités cross-sell
  console.log('🔗 Construction arbre relations avec détection opportunités cross-sell');

  if (!window.hubspotCompanies) {
    console.warn('⚠️ Aucune donnée companies disponible');
    const svg = document.getElementById('chartCompanyTree');
    svg.innerHTML = '';
    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    text.setAttribute('x', '50%');
    text.setAttribute('y', '50%');
    text.setAttribute('text-anchor', 'middle');
    text.setAttribute('fill', '#94a3b8');
    text.setAttribute('font-size', '14');
    text.textContent = 'Données companies non chargées (lancez le workflow GitHub Actions)';
    svg.appendChild(text);
    svg.setAttribute('viewBox', `0 0 800 100`);
    return;
  }

  // Créer index companyId → client pour savoir qui est déjà client
  const companyIdToClient = {};
  processedData.forEach(client => {
    if (client.companyId) {
      companyIdToClient[client.companyId] = client;
    }
  });

  // Fonction helper pour créer un objet "prospect" depuis les données brutes HubSpot
  function createProspectFromCompany(companyId) {
    const company = window.hubspotCompanies[companyId];
    if (!company) return null;

    return {
      companyId: company.id,
      name: company.name || 'Sans nom',
      domain: company.domain || '',
      totalRevenue: 0, // Pas client donc pas de CA
      isProspect: true, // Marqueur pour affichage différent
      companyIndustry: company.industry || ''
    };
  }

  // NOUVEAU: Construire composantes connexes pour éliminer doublons
  console.log(`📊 Début analyse: ${Object.keys(window.hubspotCompanies).length} companies HubSpot, ${processedData.length} clients`);

  // 1. Construire un graphe de toutes les relations
  const graph = {}; // companyId → Set(companyIds liés)
  Object.values(window.hubspotCompanies).forEach(company => {
    if (!graph[company.id]) graph[company.id] = new Set();

    // Ajouter les enfants
    if (company.childCompanyIds) {
      company.childCompanyIds.forEach(childId => {
        graph[company.id].add(childId);
        if (!graph[childId]) graph[childId] = new Set();
        graph[childId].add(company.id); // Relation bidirectionnelle
      });
    }

    // Ajouter les parents
    if (company.parentCompanyIds) {
      company.parentCompanyIds.forEach(parentId => {
        graph[company.id].add(parentId);
        if (!graph[parentId]) graph[parentId] = new Set();
        graph[parentId].add(company.id); // Relation bidirectionnelle
      });
    }
  });

  // 2. Trouver les composantes connexes (groupes d'entreprises liées)
  const visited = new Set();
  const components = []; // Chaque composante = Set(companyIds)

  function findComponent(startId) {
    const component = new Set();
    const queue = [startId];

    while (queue.length > 0) {
      const id = queue.shift();
      if (visited.has(id)) continue;

      visited.add(id);
      component.add(id);

      // Ajouter tous les voisins non visités
      if (graph[id]) {
        graph[id].forEach(neighborId => {
          if (!visited.has(neighborId)) {
            queue.push(neighborId);
          }
        });
      }
    }

    return component;
  }

  // Trouver toutes les composantes
  Object.keys(graph).forEach(companyId => {
    if (!visited.has(companyId) && graph[companyId].size > 0) {
      const component = findComponent(companyId);

      // Ne garder que si au moins UNE entreprise est cliente
      const hasClient = Array.from(component).some(id => companyIdToClient[id]);
      if (hasClient) {
        components.push(component);
      }
    }
  });

  console.log(`🔗 ${components.length} groupes d'entreprises liées détectés (sans doublons)`);

  // 3. Pour chaque composante, construire UN SEUL arbre (élimine vraiment les doublons)
  const companyGroups = [];
  let opportunitiesCount = 0;

  components.forEach((component, idx) => {
    const companyIds = Array.from(component);
    console.log(`📊 Groupe ${idx + 1}: ${companyIds.length} entreprises`);

    // Trouver la VRAIE racine (company sans aucun parent dans le groupe)
    const allChildren = new Set();
    companyIds.forEach(id => {
      const company = window.hubspotCompanies[id];
      if (company && company.childCompanyIds) {
        company.childCompanyIds.forEach(childId => {
          if (component.has(childId)) {
            allChildren.add(childId);
          }
        });
      }
    });

    // La vraie racine = pas enfant de personne dans ce groupe
    const trueRoots = companyIds.filter(id => !allChildren.has(id));
    console.log(`  Racines ultimes: ${trueRoots.length}`);

    // Si plusieurs racines, prendre la première qui est cliente (sinon la première tout court)
    const rootId = trueRoots.find(id => companyIdToClient[id]) || trueRoots[0];
    if (!rootId) return;

    const rootCompany = window.hubspotCompanies[rootId];
    if (!rootCompany) return;

    // Construire le nœud racine
    let centerNode;
    if (companyIdToClient[rootId]) {
      centerNode = companyIdToClient[rootId];
    } else {
      centerNode = createProspectFromCompany(rootId);
      if (centerNode) opportunitiesCount++;
    }

    if (!centerNode) return;

    // Construire récursivement TOUS les enfants de cette racine
    function buildChildren(parentId, visited = new Set()) {
      if (visited.has(parentId)) return []; // Éviter boucles infinies
      visited.add(parentId);

      const children = [];
      const parent = window.hubspotCompanies[parentId];
      if (!parent || !parent.childCompanyIds) return children;

      parent.childCompanyIds.forEach(childId => {
        if (!component.has(childId)) return; // Seulement dans ce groupe

        let childNode;
        if (companyIdToClient[childId]) {
          childNode = companyIdToClient[childId];
        } else {
          childNode = createProspectFromCompany(childId);
          if (childNode) opportunitiesCount++;
        }

        if (childNode) {
          // Ajouter aussi les petits-enfants récursivement
          childNode.subChildren = buildChildren(childId, visited);
          children.push(childNode);
        }
      });

      return children;
    }

    const rootChildren = buildChildren(rootId);

    // Récupérer les parents (si la racine en a, ce qui ne devrait pas arriver)
    const parents = [];
    if (rootCompany.parentCompanyIds) {
      rootCompany.parentCompanyIds.forEach(parentId => {
        if (!component.has(parentId)) return;

        let parentNode;
        if (companyIdToClient[parentId]) {
          parentNode = companyIdToClient[parentId];
        } else {
          parentNode = createProspectFromCompany(parentId);
          if (parentNode) opportunitiesCount++;
        }
        if (parentNode) parents.push(parentNode);
      });
    }

    // Créer UN SEUL groupe pour toute cette composante
    companyGroups.push({
      center: centerNode,
      parents: parents,
      children: rootChildren,
      componentSize: companyIds.length // Pour le debug
    });
  });

  console.log(`✅ ${companyGroups.length} arbres générés, ${opportunitiesCount} opportunités cross-sell détectées`);

  const svg = document.getElementById('chartCompanyTree');
  svg.innerHTML = '';

  // FOND NOIR pour dark mode
  const background = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
  background.setAttribute('width', '100%');
  background.setAttribute('height', '100%');
  background.setAttribute('fill', '#0f172a'); // Slate-900 dark
  svg.insertBefore(background, svg.firstChild);

  if (companyGroups.length === 0) {
    // Message si aucune relation détectée
    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    text.setAttribute('x', '50%');
    text.setAttribute('y', '50%');
    text.setAttribute('text-anchor', 'middle');
    text.setAttribute('fill', '#94a3b8');
    text.setAttribute('font-size', '14');
    text.textContent = 'Aucune relation entreprise détectée pour le moment';
    svg.appendChild(text);
    svg.setAttribute('viewBox', `0 0 800 100`);
    return;
  }

  // Créer les dégradés SVG (plus sexy!)
  const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');

  // Gradient bleu-violet pour clients
  const gradientClient = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
  gradientClient.setAttribute('id', 'gradientClient');
  gradientClient.setAttribute('x1', '0%');
  gradientClient.setAttribute('y1', '0%');
  gradientClient.setAttribute('x2', '100%');
  gradientClient.setAttribute('y2', '100%');
  gradientClient.innerHTML = `
    <stop offset="0%" style="stop-color:#6366f1;stop-opacity:1" />
    <stop offset="100%" style="stop-color:#8b5cf6;stop-opacity:1" />
  `;
  defs.appendChild(gradientClient);

  // Gradient orange-rose pour prospects
  const gradientProspect = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
  gradientProspect.setAttribute('id', 'gradientProspect');
  gradientProspect.setAttribute('x1', '0%');
  gradientProspect.setAttribute('y1', '0%');
  gradientProspect.setAttribute('x2', '100%');
  gradientProspect.setAttribute('y2', '100%');
  gradientProspect.innerHTML = `
    <stop offset="0%" style="stop-color:#f97316;stop-opacity:1" />
    <stop offset="100%" style="stop-color:#ec4899;stop-opacity:1" />
  `;
  defs.appendChild(gradientProspect);

  // Gradient parent (plus foncé)
  const gradientParent = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
  gradientParent.setAttribute('id', 'gradientParent');
  gradientParent.setAttribute('x1', '0%');
  gradientParent.setAttribute('y1', '0%');
  gradientParent.setAttribute('x2', '100%');
  gradientParent.setAttribute('y2', '100%');
  gradientParent.innerHTML = `
    <stop offset="0%" style="stop-color:#4f46e5;stop-opacity:1" />
    <stop offset="100%" style="stop-color:#7c3aed;stop-opacity:1" />
  `;
  defs.appendChild(gradientParent);

  // Gradient enfant (plus clair)
  const gradientChild = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
  gradientChild.setAttribute('id', 'gradientChild');
  gradientChild.setAttribute('x1', '0%');
  gradientChild.setAttribute('y1', '0%');
  gradientChild.setAttribute('x2', '100%');
  gradientChild.setAttribute('y2', '100%');
  gradientChild.innerHTML = `
    <stop offset="0%" style="stop-color:#818cf8;stop-opacity:1" />
    <stop offset="100%" style="stop-color:#a78bfa;stop-opacity:1" />
  `;
  defs.appendChild(gradientChild);

  svg.appendChild(defs);

  // Helper pour dessiner un nœud avec PLUS D'INFOS
  function drawNode(x, y, nodeData, label, nodeType = 'center') {
    const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    g.style.cursor = 'pointer';
    g.classList.add('company-node'); // Marquer pour éviter le pan

    // Choisir le gradient selon le type et le statut
    let gradientId;
    let strokeColor;

    if (nodeData.isProspect) {
      gradientId = 'gradientProspect';
      strokeColor = '#fb923c';
    } else {
      if (nodeType === 'parent') {
        gradientId = 'gradientParent';
        strokeColor = '#818cf8';
      } else if (nodeType === 'child') {
        gradientId = 'gradientChild';
        strokeColor = '#a78bfa';
      } else {
        gradientId = 'gradientClient';
        strokeColor = '#a5b4fc';
      }
    }

    // Rendre le nœud cliquable
    g.addEventListener('click', (e) => {
      e.stopPropagation();
      showCompanyDetails(nodeData);
    });

    // Rectangle avec gradient (PLUS GRAND pour plus d'infos)
    const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
    rect.setAttribute('x', x);
    rect.setAttribute('y', y);
    rect.setAttribute('width', 280); // 220 → 280
    rect.setAttribute('height', 110); // 80 → 110
    rect.setAttribute('rx', 12);
    rect.setAttribute('fill', `url(#${gradientId})`);
    rect.setAttribute('stroke', strokeColor);
    rect.setAttribute('stroke-width', 3);
    rect.setAttribute('filter', 'drop-shadow(0 4px 6px rgba(0,0,0,0.2))');
    g.appendChild(rect);

    // Nom
    const name = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    name.setAttribute('x', x + 140);
    name.setAttribute('y', y + 22);
    name.setAttribute('text-anchor', 'middle');
    name.setAttribute('fill', 'white');
    name.setAttribute('font-size', '14');
    name.setAttribute('font-weight', '800');
    const nameText = nodeData.name.length > 30 ? nodeData.name.substring(0, 27) + '...' : nodeData.name;
    name.textContent = nameText;
    g.appendChild(name);

    // Industrie (NOUVEAU)
    const industry = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    industry.setAttribute('x', x + 140);
    industry.setAttribute('y', y + 40);
    industry.setAttribute('text-anchor', 'middle');
    industry.setAttribute('fill', 'rgba(255,255,255,0.85)');
    industry.setAttribute('font-size', '10');
    industry.setAttribute('font-style', 'italic');
    const industryText = nodeData.companyIndustry || 'Secteur non défini';
    const industryShort = industryText.length > 35 ? industryText.substring(0, 32) + '...' : industryText;
    industry.textContent = industryShort;
    g.appendChild(industry);

    // CA
    const ca = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    ca.setAttribute('x', x + 140);
    ca.setAttribute('y', y + 60);
    ca.setAttribute('text-anchor', 'middle');
    ca.setAttribute('fill', 'rgba(255,255,255,0.95)');
    ca.setAttribute('font-size', '12');
    ca.setAttribute('font-weight', '700');
    ca.textContent = nodeData.isProspect ? 'Prospect' : formatCurrency(nodeData.totalRevenue);
    g.appendChild(ca);

    // Domaine (NOUVEAU)
    if (nodeData.domain) {
      const domain = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      domain.setAttribute('x', x + 140);
      domain.setAttribute('y', y + 78);
      domain.setAttribute('text-anchor', 'middle');
      domain.setAttribute('fill', 'rgba(255,255,255,0.75)');
      domain.setAttribute('font-size', '9');
      const domainShort = nodeData.domain.length > 35 ? nodeData.domain.substring(0, 32) + '...' : nodeData.domain;
      domain.textContent = domainShort;
      g.appendChild(domain);
    }

    // Badge
    const badge = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    badge.setAttribute('x', x + 140);
    badge.setAttribute('y', y + 96);
    badge.setAttribute('text-anchor', 'middle');
    badge.setAttribute('fill', 'rgba(255,255,255,0.9)');
    badge.setAttribute('font-size', '9');
    badge.setAttribute('font-weight', '700');
    badge.setAttribute('letter-spacing', '0.5');
    badge.textContent = nodeData.isProspect ? 'CROSS-SELL' : label;
    g.appendChild(badge);

    return g;
  }

  // NOUVEAU LAYOUT SIMPLE ET LISIBLE
  const groupSpacing = 550; // Espacement horizontal entre groupes (augmenté pour nœuds plus larges)
  const nodeWidth = 280; // Largeur nœud mise à jour
  const nodeHeight = 110; // Hauteur nœud mise à jour
  const verticalSpacing = 130; // Espacement vertical entre nœuds (augmenté)

  // Calculer la hauteur nécessaire pour chaque groupe
  const groupHeights = companyGroups.map(group => {
    // Compter tous les nœuds à afficher verticalement
    let nodeCount = 1; // Centre
    nodeCount += group.parents.length;

    // Compter récursivement les enfants
    function countChildren(children) {
      if (!children || children.length === 0) return 0;
      let count = children.length;
      children.forEach(child => {
        if (child.subChildren) {
          count += countChildren(child.subChildren);
        }
      });
      return count;
    }
    nodeCount += countChildren(group.children);

    return nodeCount * (nodeHeight + verticalSpacing) + 200; // Marge en haut/bas
  });

  const maxHeight = Math.max(...groupHeights, 800);
  const width = Math.max(1400, companyGroups.length * groupSpacing + 200);

  svg.setAttribute('viewBox', `0 0 ${width} ${maxHeight}`);

  companyGroups.forEach((group, groupIdx) => {
    const baseX = 100 + groupIdx * groupSpacing;
    let currentY = 100; // Position Y courante (on empile verticalement)

    // RECTANGLE DE FOND pour séparer visuellement chaque groupe
    const groupBg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
    groupBg.setAttribute('x', baseX - 40);
    groupBg.setAttribute('y', 50);
    groupBg.setAttribute('width', groupSpacing - 100);
    groupBg.setAttribute('height', maxHeight - 100);
    groupBg.setAttribute('fill', 'rgba(30, 41, 59, 0.3)');
    groupBg.setAttribute('stroke', 'rgba(71, 85, 105, 0.4)');
    groupBg.setAttribute('stroke-width', 2);
    groupBg.setAttribute('rx', 20);
    svg.appendChild(groupBg);

    // Titre du groupe
    const groupTitle = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    groupTitle.setAttribute('x', baseX + (groupSpacing - 100) / 2 - 40);
    groupTitle.setAttribute('y', 80);
    groupTitle.setAttribute('text-anchor', 'middle');
    groupTitle.setAttribute('fill', '#cbd5e1');
    groupTitle.setAttribute('font-size', '14');
    groupTitle.setAttribute('font-weight', '700');
    groupTitle.textContent = `Groupe ${groupIdx + 1} (${group.componentSize} entreprises)`;
    svg.appendChild(groupTitle);

    // Parents EMPILÉS VERTICALEMENT en haut
    group.parents.forEach((parent) => {
      const parentNode = drawNode(baseX, currentY, parent, 'SOCIÉTÉ MÈRE', 'parent');
      svg.appendChild(parentNode);

      // Ligne vers le centre (qui viendra après)
      const centerYPos = currentY + (group.parents.length - group.parents.indexOf(parent)) * (nodeHeight + verticalSpacing);
      currentY += nodeHeight + verticalSpacing;
    });

    // Nœud centre
    const centerYPos = currentY;
    const centerNode = drawNode(baseX, centerYPos, group.center, 'CLIENT', 'center');
    svg.appendChild(centerNode);
    currentY += nodeHeight + verticalSpacing;

    // Lignes des parents vers le centre
    group.parents.forEach((parent, idx) => {
      const parentYPos = 100 + idx * (nodeHeight + verticalSpacing);
      const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      line.setAttribute('x1', baseX + nodeWidth / 2);
      line.setAttribute('y1', parentYPos + nodeHeight);
      line.setAttribute('x2', baseX + nodeWidth / 2);
      line.setAttribute('y2', centerYPos);
      line.setAttribute('stroke', '#6366f1');
      line.setAttribute('stroke-width', 3);
      line.setAttribute('stroke-dasharray', '8,4');
      line.setAttribute('opacity', '0.6');
      svg.appendChild(line);
    });

    // Enfants EMPILÉS VERTICALEMENT en dessous (récursif)
    function drawChildren(children, startY, indent = 0) {
      if (!children || children.length === 0) return startY;

      let y = startY;
      children.forEach((child) => {
        // Ligne du parent vers cet enfant
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', baseX + nodeWidth / 2);
        line.setAttribute('y1', startY - verticalSpacing);
        line.setAttribute('x2', baseX + nodeWidth / 2 + indent);
        line.setAttribute('y2', y);
        line.setAttribute('stroke', '#8b5cf6');
        line.setAttribute('stroke-width', 3);
        line.setAttribute('stroke-dasharray', '8,4');
        line.setAttribute('opacity', '0.6');
        svg.appendChild(line);

        // Nœud enfant (légèrement décalé si sous-enfant)
        const childNode = drawNode(baseX + indent, y, child, 'FILIALE', 'child');
        svg.appendChild(childNode);
        y += nodeHeight + verticalSpacing;

        // Sous-enfants récursifs (encore plus décalés)
        if (child.subChildren && child.subChildren.length > 0) {
          y = drawChildren(child.subChildren, y, indent + 30);
        }
      });

      return y;
    }

    drawChildren(group.children, currentY, 0);
  });

  // Initialiser le zoom/pan sur le SVG
  initCompanyTreeZoom();
}

// ============================================================================
// Navigation interactive pour la cartographie (Zoom/Pan)
// ============================================================================

let companyTreeZoom = {
  scale: 1,
  translateX: 0,
  translateY: 0,
  isDragging: false,
  startX: 0,
  startY: 0
};

function initCompanyTreeZoom() {
  const container = document.getElementById('companyTreeContainer');
  const svg = document.getElementById('chartCompanyTree');

  if (!container || !svg) return;

  // Appliquer le transform initial
  updateCompanyTreeTransform();

  // Mouse wheel pour zoom
  container.addEventListener('wheel', (e) => {
    e.preventDefault();
    const delta = e.deltaY > 0 ? 0.9 : 1.1;

    // Calculer le point de zoom (position de la souris)
    const rect = container.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;

    // Ajuster la translation pour zoomer sur le point de la souris
    const oldScale = companyTreeZoom.scale;
    const newScale = Math.min(Math.max(companyTreeZoom.scale * delta, 1.0), 5); // Bloquer zoom out à 1.0 (vue initiale)

    companyTreeZoom.translateX = mouseX - (mouseX - companyTreeZoom.translateX) * (newScale / oldScale);
    companyTreeZoom.translateY = mouseY - (mouseY - companyTreeZoom.translateY) * (newScale / oldScale);
    companyTreeZoom.scale = newScale;

    updateCompanyTreeTransform();
  });

  // Mouse down pour démarrer le drag
  container.addEventListener('mousedown', (e) => {
    // Autoriser le drag sauf si on clique sur un nœud cliquable
    const isNode = e.target.closest('.company-node');
    if (!isNode) {
      companyTreeZoom.isDragging = true;
      companyTreeZoom.startX = e.clientX - companyTreeZoom.translateX;
      companyTreeZoom.startY = e.clientY - companyTreeZoom.translateY;
      container.style.cursor = 'grabbing';
      e.preventDefault(); // Empêcher sélection texte
    }
  });

  // Mouse move pour drag
  container.addEventListener('mousemove', (e) => {
    if (companyTreeZoom.isDragging) {
      e.preventDefault();
      companyTreeZoom.translateX = e.clientX - companyTreeZoom.startX;
      companyTreeZoom.translateY = e.clientY - companyTreeZoom.startY;
      updateCompanyTreeTransform();
    }
  });

  // Mouse up pour arrêter le drag
  container.addEventListener('mouseup', () => {
    companyTreeZoom.isDragging = false;
    container.style.cursor = 'grab';
  });

  container.addEventListener('mouseleave', () => {
    companyTreeZoom.isDragging = false;
    container.style.cursor = 'grab';
  });
}

function updateCompanyTreeTransform() {
  const svg = document.getElementById('chartCompanyTree');
  if (!svg) return;

  svg.style.transform = `translate(${companyTreeZoom.translateX}px, ${companyTreeZoom.translateY}px) scale(${companyTreeZoom.scale})`;
  svg.style.transformOrigin = '0 0';
}

function zoomCompanyTree(factor) {
  companyTreeZoom.scale = Math.min(Math.max(companyTreeZoom.scale * factor, 0.1), 5);
  updateCompanyTreeTransform();
}

function resetCompanyTreeZoom() {
  companyTreeZoom.scale = 1;
  companyTreeZoom.translateX = 0;
  companyTreeZoom.translateY = 0;
  updateCompanyTreeTransform();
}

// ============================================================================
// Modal détails company
// ============================================================================

function showCompanyDetails(nodeData) {
  const isClient = !nodeData.isProspect;
  const HUBSPOT_PORTAL_ID = '146716340';

  let content = `
    <div class="info-highlight">
      <div style="font-size: 20px; font-weight: 700; color: ${isClient ? 'var(--accent)' : '#f97316'}; margin-bottom: 8px;">
        ${nodeData.name}
      </div>
      <div style="font-size: 13px; color: var(--text-muted);">
        ${isClient ? '✅ Client actuel' : '🎯 Opportunité cross-sell (pas encore client)'}
      </div>
    </div>

    <div style="margin-top: 20px;">
      <div class="info-row">
        <span class="info-label">Statut</span>
        <span class="info-value" style="color: ${isClient ? 'var(--green)' : '#f97316'};">
          ${isClient ? 'CLIENT' : 'PROSPECT'}
        </span>
      </div>

      ${isClient ? `
        <div class="info-row">
          <span class="info-label">CA Total</span>
          <span class="info-value" style="color: var(--accent);">${formatCurrency(nodeData.totalRevenue)}</span>
        </div>
      ` : ''}

      ${nodeData.domain ? `
        <div class="info-row">
          <span class="info-label">Domaine</span>
          <span class="info-value">${nodeData.domain}</span>
        </div>
      ` : ''}

      ${nodeData.companyIndustry ? `
        <div class="info-row">
          <span class="info-label">Secteur d'activité</span>
          <span class="info-value">${nodeData.companyIndustry}</span>
        </div>
      ` : ''}
    </div>

    ${nodeData.companyId ? `
      <div style="margin-top: 24px; padding: 16px; background: rgba(99, 102, 241, 0.1); border-radius: 8px; border-left: 4px solid var(--accent);">
        <div style="font-size: 14px; font-weight: 600; color: var(--accent); margin-bottom: 12px;">
          🔗 Liens HubSpot
        </div>
        <div style="display: flex; flex-direction: column; gap: 10px;">
          <a href="https://app.hubspot.com/contacts/${HUBSPOT_PORTAL_ID}/company/${nodeData.companyId}"
             target="_blank"
             style="display: inline-flex; align-items: center; gap: 8px; padding: 10px 16px; background: var(--accent); color: white; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 13px; transition: all 0.2s;">
            📊 Voir dans HubSpot →
          </a>
        </div>
      </div>
    ` : ''}

    ${!isClient ? `
      <div style="margin-top: 20px; padding: 16px; background: rgba(249, 115, 22, 0.1); border-radius: 8px; border-left: 4px solid #f97316;">
        <div style="font-size: 13px; font-weight: 600; color: #f97316; margin-bottom: 8px;">
          🎯 Opportunité de cross-sell
        </div>
        <div style="font-size: 12px; color: var(--text-muted); line-height: 1.6;">
          Cette entreprise est reliée à un de vos clients actuels. C'est une opportunité de cross-sell à explorer !
        </div>
      </div>
    ` : ''}

    ${isClient && nodeData.avgHealthScore ? `
      <div style="margin-top: 20px;">
        <div class="info-row">
          <span class="info-label">Score Santé</span>
          <span class="info-value" style="color: ${nodeData.avgHealthScore > 70 ? 'var(--green)' : nodeData.avgHealthScore > 40 ? '#fbbf24' : 'var(--red)'};">
            ${nodeData.avgHealthScore}/100
          </span>
        </div>
      </div>
    ` : ''}
  `;

  openInfoPanel(`Détails Entreprise`, content);
}

// ============================================================================
// Segmentation Table
// ============================================================================
function renderSegmentationTable() {
  const tbody = document.getElementById('segmentationBody');

  // ========================================================================
  // ÉTAPE 1: Créer la structure groupée parent/filiales
  // ========================================================================
  const groupedStructure = processGroupedData();

  // Apply filters sur la structure groupée
  let filteredData = groupedStructure.filter(item => {
    // Pour les groupes, vérifier le CA total du groupe
    // Pour les standalone, vérifier leur CA
    const dataToCheck = item.type === 'group' ? item : item;

    // Year filter
    if (currentFilters.year !== 'all') {
      const yearRevenue = dataToCheck.years[currentFilters.year];
      if (!yearRevenue || yearRevenue === 0) return false;
    }
    return true;
  });

  // Apply sorting (gestion groupes + standalone)
  filteredData.sort((a, b) => {
    let aVal, bVal;

    // Helper pour extraire la valeur à comparer
    const getValue = (item, column) => {
      // Pour un groupe, utiliser les données agrégées
      if (item.type === 'group') {
        switch(column) {
          case 'name': return item.groupName.toLowerCase();
          case 'total': return item.totalGroupRevenue;
          default:
            // Pour les autres colonnes, utiliser les données du groupe
            return item[column] !== undefined ? item[column] : item.parentData?.[column] || 0;
        }
      }
      // Pour standalone, utiliser directement les données
      return item[column] !== undefined ? item[column] : 0;
    };

    switch(sortColumn) {
      case 'rank':
        // Tri par ordre original
        return sortDirection === 'asc' ?
          groupedStructure.indexOf(a) - groupedStructure.indexOf(b) :
          groupedStructure.indexOf(b) - groupedStructure.indexOf(a);
      case 'name':
        aVal = getValue(a, 'name');
        bVal = getValue(b, 'name');
        break;
      case 'segment':
        aVal = a.segment || '';
        bVal = b.segment || '';
        break;
      case 'healthScore':
        aVal = a.avgHealthScore || 0;
        bVal = b.avgHealthScore || 0;
        break;
      case 'total':
        aVal = a.type === 'group' ? a.totalGroupRevenue : a.totalRevenue;
        bVal = b.type === 'group' ? b.totalGroupRevenue : b.totalRevenue;
        break;
      case '2022':
      case '2023':
      case '2024':
      case '2025':
        aVal = a.years[sortColumn] || 0;
        bVal = b.years[sortColumn] || 0;
        break;
      case 'globalTrend':
        aVal = a.trend || 0;
        bVal = b.trend || 0;
        break;
      case 'sentiment':
        // Sort by sentiment priority (positive > neutral > negative)
        // Plus engagement and notes count as tiebreaker
        const getSentimentPriority = (client) => {
          const sentiment = client.notesSentiment || 'neutral';
          const notesCount = client.totalNotes || 0;
          const engagement = (client.engagementEmails || 0) +
                            (client.engagementCalls || 0) * 2 +
                            (client.engagementMeetings || 0) * 3;

          // Base priority: positive=100, neutral=50, negative=0
          let priority = sentiment === 'positive' ? 100 : (sentiment === 'negative' ? 0 : 50);

          // Add engagement bonus (0-30)
          priority += Math.min(engagement, 30);

          // Add notes bonus (0-20)
          priority += Math.min(notesCount * 2, 20);

          return priority;
        };

        aVal = getSentimentPriority(a);
        bVal = getSentimentPriority(b);
        break;
      case 'contacts':
        // Extract contacts for sorting
        const extractContacts = (client) => {
          if (!client.latestNoteBody) return 'zzz'; // Sort N/A at end

          let contactMatch = client.latestNoteBody.match(/<strong>Contact\s*:\s*<\/strong>(.*?)<\/p>/i);
          if (contactMatch) {
            return contactMatch[1].replace(/<[^>]*>/g, '').trim().toLowerCase();
          }

          // Try to find names
          const namePatterns = [
            /\b(M\.|Mme|Monsieur|Madame)\s+([A-ZÀ-Ü][a-zà-ü]+)\s+([A-ZÀ-Ü]{2,})\b/g,
            /\b([A-ZÀ-Ü][a-zà-ü]+)\s+([A-ZÀ-Ü]{2,})\b/g
          ];

          const plainText = client.latestNoteBody.replace(/<[^>]*>/g, ' ');

          for (const pattern of namePatterns) {
            const match = pattern.exec(plainText);
            if (match && match[0]) {
              return match[0].trim().toLowerCase();
            }
          }

          return 'zzz'; // Sort N/A at end
        };

        aVal = extractContacts(a);
        bVal = extractContacts(b);
        break;
      default:
        return 0;
    }

    if (typeof aVal === 'string') {
      return sortDirection === 'asc' ?
        aVal.localeCompare(bVal) :
        bVal.localeCompare(aVal);
    }

    return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
  });

  // ========================================================================
  // ÉTAPE 2: "Flatten" les groupes pour le rendering
  // Transformer la structure hiérarchique en liste plate pour affichage
  // ========================================================================
  const flattenedForDisplay = [];
  filteredData.forEach(item => {
    if (item.type === 'group') {
      // Ajouter le groupe parent
      flattenedForDisplay.push(item);

      // Si le groupe est étendu, ajouter les enfants
      if (item.isExpanded && item.children && item.children.length > 0) {
        item.children.forEach(child => {
          flattenedForDisplay.push(child);
        });
      }
    } else {
      // Standalone
      flattenedForDisplay.push(item);
    }
  });

  // Stocker les clients affichés pour accès dans showClientDetails
  currentDisplayedClients = flattenedForDisplay;

  tbody.innerHTML = flattenedForDisplay.map((client, idx) => {
    // ========================================================================
    // Gérer les différents types de lignes
    // ========================================================================
    const isGroup = client.type === 'group';
    const isChild = client.type === 'child';

    // Pour les groupes, utiliser les données agrégées
    const displayName = isGroup ? client.groupName : client.name;
    const displayRevenue = isGroup ? client.totalGroupRevenue : (client.totalRevenue || 0);

    // Extraire les contacts depuis les notes HTML - Version intelligente
    let contacts = 'N/A';
    if (client.latestNoteBody) {
      // Chercher pattern "Contact: ..."
      let contactMatch = client.latestNoteBody.match(/<strong>Contact\s*:\s*<\/strong>(.*?)<\/p>/i);
      if (contactMatch) {
        contacts = contactMatch[1].replace(/<[^>]*>/g, '').trim();
      } else {
        // Chercher patterns de noms (M./Mme Prénom NOM, ou juste Prénom NOM)
        const namePatterns = [
          /\b(M\.|Mme|Monsieur|Madame)\s+([A-ZÀ-Ü][a-zà-ü]+)\s+([A-ZÀ-Ü]{2,})\b/g,
          /\b([A-ZÀ-Ü][a-zà-ü]+)\s+([A-ZÀ-Ü]{2,})\b/g
        ];

        const foundNames = new Set();
        const plainText = client.latestNoteBody.replace(/<[^>]*>/g, ' ');

        for (const pattern of namePatterns) {
          let match;
          while ((match = pattern.exec(plainText)) !== null && foundNames.size < 3) {
            const name = match[0].trim();
            // Éviter les mots communs qui ne sont pas des noms
            if (!['Dans', 'Pour', 'Selon', 'Client', 'Société'].includes(name.split(' ')[0])) {
              foundNames.add(name);
            }
          }
          if (foundNames.size > 0) break;
        }

        if (foundNames.size > 0) {
          contacts = Array.from(foundNames).join(', ');
        }
      }
    }

    // Couleur du health score
    const healthColor = client.avgHealthScore >= 70 ? 'var(--green)' :
                       client.avgHealthScore >= 40 ? 'var(--orange)' : 'var(--red)';

    // Analyse sentimentale granulaire
    const baseSentiment = client.notesSentiment || 'neutral';
    const notesCount = client.totalNotes || 0;
    const engagement = (client.engagementEmails || 0) +
                      (client.engagementCalls || 0) * 2 +
                      (client.engagementMeetings || 0) * 3;
    const healthScore = client.avgHealthScore || 0;

    let sentimentText = 'Non évalué';
    let sentimentColor = '#94a3b8';

    if (baseSentiment === 'positive') {
      // Positif avec granularité
      if (notesCount >= 10 && engagement >= 20 && healthScore >= 80) {
        sentimentText = 'Excellent';
        sentimentColor = '#10b981';
      } else if (notesCount >= 5 && engagement >= 10) {
        sentimentText = 'Très positif';
        sentimentColor = '#22c55e';
      } else {
        sentimentText = 'Positif';
        sentimentColor = '#4ade80';
      }
    } else if (baseSentiment === 'negative') {
      // Négatif avec granularité
      if (notesCount >= 5 || healthScore < 30) {
        sentimentText = 'Très négatif';
        sentimentColor = '#ef4444';
      } else {
        sentimentText = 'Négatif';
        sentimentColor = '#f87171';
      }
    } else {
      // Neutre avec granularité
      if (engagement >= 15 && notesCount >= 5) {
        sentimentText = 'Neutre favorable';
        sentimentColor = '#a3e635';
      } else if (healthScore < 40 || notesCount < 3) {
        sentimentText = 'Préoccupant';
        sentimentColor = '#fb923c';
      } else {
        sentimentText = 'Neutre';
        sentimentColor = '#fbbf24';
      }
    }

    const sentimentScore = `(${notesCount} notes, ${engagement} eng.)`;

    // Utiliser la tendance globale calculée (première année → dernière année)
    const years = ['2022', '2023', '2024', '2025'];
    let trendDisplay = '-';
    let trendColor = '#94a3b8';

    if (client.trend !== undefined && client.trend !== 0) {
      const trendValue = client.trend.toFixed(1);
      trendDisplay = (client.trend > 0 ? '+' : '') + trendValue + '%';
      trendColor = client.trend > 0 ? '#22c55e' : client.trend < 0 ? '#ef4444' : '#94a3b8';
    }

    // ========================================================================
    // Déterminer les classes et handlers selon le type
    // ========================================================================
    let rowClass = '';
    let rowOnClick = `showClientDetails(${idx})`;
    let expandIcon = '';

    if (isGroup) {
      rowClass = `group-row ${client.isExpanded ? 'expanded' : ''}`;
      rowOnClick = `toggleGroup(${idx})`;
      expandIcon = `<span class="expand-icon">${client.isExpanded ? '▼' : '▶'}</span>`;
    } else if (isChild) {
      rowClass = 'child-row';
      // Si c'est un white space (filiale sans deals/prospect)
      if (client.isProspect) {
        rowClass += ' white-space-row';
      }
      rowOnClick = `showClientDetails(${idx})`;
    } else {
      // Standalone
      rowOnClick = `showClientDetails(${idx})`;
    }

    return `
      <tr class="${rowClass}" data-row-index="${idx}" data-row-type="${client.type}" style="cursor: pointer;">
        <td><strong>${idx + 1}</strong></td>
        <td ${isChild ? 'class="child-cell-indent"' : ''}>
          ${isGroup ? expandIcon : ''}
          ${isChild ? '<span class="child-indicator">└─</span>' : ''}
          <strong class="${isGroup ? 'group-name' : ''}">${displayName}</strong>
          ${isGroup ? `<span class="badge-subsidiaries">${client.childrenCount} filiale${client.childrenCount > 1 ? 's' : ''}</span>` : ''}
          ${client.isProspect ? '<span class="white-space-badge">White Space</span>' : ''}
          ${client.domain ? `<br><small style="color: var(--text-muted);">${client.domain}</small>` : ''}
        </td>
        <td style="text-align: center;">
          <div style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: ${client.segmentColor || '#94a3b8'};" title="${client.segment}: ${client.segmentReason}"></div>
        </td>
        <td>
          <div style="font-size: 18px; font-weight: 800; color: ${healthColor};">${client.avgHealthScore}</div>
          <small style="color: var(--text-muted); font-size: 10px;">/100</small>
        </td>
        <td style="font-weight: 700; color: #6366f1;">${formatCurrency(displayRevenue)}</td>
        ${years.map((year, idx) => {
          const revenue = client.years[year] || 0;
          let yearTrend = '';
          let yearTrendColor = '#94a3b8';

          if (idx > 0) {
            const prevRevenue = client.years[years[idx - 1]] || 0;
            if (prevRevenue > 0 && revenue > 0) {
              const change = ((revenue - prevRevenue) / prevRevenue * 100).toFixed(1);
              yearTrend = (change > 0 ? '+' : '') + change + '%';
              yearTrendColor = change > 0 ? '#22c55e' : change < 0 ? '#ef4444' : '#94a3b8';
            }
          }

          return `
            <td class="year-col year-${year}" style="text-align: right; font-size: 11px;">
              <div style="font-weight: 600;">${revenue > 0 ? formatCurrency(revenue) : '-'}</div>
              ${yearTrend ? `<small style="color: ${yearTrendColor}; font-size: 9px;">${yearTrend}</small>` : ''}
            </td>
          `;
        }).join('')}
        <td class="global-trend-col" style="text-align: center;">
          <div style="font-size: 14px; font-weight: 700; color: ${trendColor};">${trendDisplay}</div>
        </td>
        <td style="text-align: center;">
          <div style="font-weight: 700; color: ${sentimentColor}; font-size: 13px;">${sentimentText}</div>
          <small style="color: var(--text-muted); font-size: 9px;">${sentimentScore}</small>
        </td>
        <td>
          <div style="font-size: 11px; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${contacts}">
            ${contacts}
          </div>
        </td>
        <td>
          <button onclick='event.stopPropagation(); showClientDetails(${idx})'
                  style="padding: 6px 12px; background: var(--accent); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px;">
            Voir détails
          </button>
        </td>
      </tr>
    `;
  }).join('');

  // ========================================================================
  // ÉTAPE 3: Attacher les event listeners après le rendering
  // ========================================================================
  console.log(`🔗 Attachement event listeners sur ${flattenedForDisplay.length} lignes`);

  // Récupérer toutes les lignes TR
  const allRows = tbody.querySelectorAll('tr[data-row-index]');
  console.log(`   → ${allRows.length} lignes trouvées dans le DOM`);

  allRows.forEach((row, idx) => {
    const rowIndex = parseInt(row.getAttribute('data-row-index'));
    const rowType = row.getAttribute('data-row-type');

    // Attacher un listener de clic sur chaque ligne
    row.addEventListener('click', function(event) {
      // Ignorer si c'est un bouton
      if (event.target.tagName === 'BUTTON') return;

      console.log(`🖱️ Clic ligne ${rowIndex}, type: ${rowType}`);

      if (rowType === 'group') {
        console.log(`🔄 TOGGLE groupe ${rowIndex}`);
        toggleGroup(rowIndex);
      } else {
        console.log(`📋 Détails client ${rowIndex}`);
        showClientDetails(rowIndex);
      }
    });
  });

  console.log(`✅ Event listeners attachés sur toutes les lignes`);
}

// ============================================================================
// Show Client Details - VERSION ENRICHIE
// ============================================================================
function showClientDetails(clientIndex) {
  console.log('📋 showClientDetails APPELÉE avec index:', clientIndex);
  console.log('   → currentDisplayedClients.length:', currentDisplayedClients.length);

  // Récupérer le client depuis la liste affichée
  const client = currentDisplayedClients[clientIndex];

  if (!client) {
    console.error('❌ Client non trouvé à l\'index:', clientIndex);
    console.error('   → currentDisplayedClients:', currentDisplayedClients);
    return;
  }

  console.log('✓ Client trouvé:', client.name || client.groupName);
  console.log('   → Type:', client.type);
  console.log('Affichage détails client:', client);

  // Vérification de sécurité pour les propriétés manquantes
  if (!client.years) {
    console.warn('⚠️ client.years manquant, initialisation...');
    client.years = { '2022': 0, '2023': 0, '2024': 0, '2025': 0 };
  }
  if (client.totalRevenue === undefined) {
    console.warn('⚠️ client.totalRevenue manquant, initialisation à 0');
    client.totalRevenue = 0;
  }
  if (client.avgHealthScore === undefined) {
    console.warn('⚠️ client.avgHealthScore manquant, initialisation à 0');
    client.avgHealthScore = 0;
  }

  const years = ['2022', '2023', '2024', '2025'];
  const activeYears = years.filter(y => client.years && client.years[y] > 0);

  // Calcul du score (pour afficher les détails)
  const scoreCA = Math.min((client.totalRevenue / 100000) * 40, 40);
  let scoreTrend = 0;
  if (client.trend > 50) scoreTrend = 30;
  else if (client.trend > 20) scoreTrend = 20;
  else if (client.trend > 0) scoreTrend = 10;
  else if (client.trend < -20) scoreTrend = -10;

  let scoreRecence = 0;
  if (client.lastDealDate) {
    const daysSince = (new Date() - client.lastDealDate) / (1000 * 60 * 60 * 24);
    if (daysSince < 180) scoreRecence = 20;
    else if (daysSince < 365) scoreRecence = 10;
  }

  const scoreDeals = Math.min(client.dealCount * 2, 10);

  // Extraire le contenu HTML des notes (nettoyer le HTML)
  let notesContent = 'Aucune note disponible';
  if (client.latestNoteBody) {
    // Convertir le HTML en texte lisible
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = client.latestNoteBody;
    notesContent = tempDiv.innerHTML; // Garder le HTML pour le formatage
  }

  // Couleur health score
  const healthColor = client.avgHealthScore >= 70 ? 'var(--green)' :
                     client.avgHealthScore >= 40 ? 'var(--orange)' : 'var(--red)';

  const sentimentText = client.notesSentiment === 'positive' ? 'Positif' :
                       client.notesSentiment === 'negative' ? 'Négatif' : 'Neutre';
  const sentimentColor = client.notesSentiment === 'positive' ? '#22c55e' :
                        client.notesSentiment === 'negative' ? '#ef4444' : '#94a3b8';

  const infoContent = `
    <!-- Header -->
    <div class="info-highlight">
      <div style="font-size: 24px; font-weight: 800; color: var(--accent); margin-bottom: 12px;">
        ${client.name}
      </div>
      ${client.domain ? `<div style="color: var(--text-muted); margin-bottom: 8px;">🌐 ${client.domain}</div>` : ''}
      ${client.companyId && HUBSPOT_PORTAL_ID !== 'YOUR_PORTAL_ID' ? `
      <div style="margin-bottom: 12px;">
        <a href="https://app.hubspot.com/contacts/${HUBSPOT_PORTAL_ID}/company/${client.companyId}"
           target="_blank"
           style="color: var(--accent); text-decoration: none; font-size: 13px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px;">
          🔗 Voir dans HubSpot
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
            <polyline points="15 3 21 3 21 9"></polyline>
            <line x1="10" y1="14" x2="21" y2="3"></line>
          </svg>
        </a>
      </div>
      ` : ''}
      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
        <span class="badge ${client.segment.toLowerCase().replace(/[àâäéèêëïîôùûüç\s]/g, c => ({
          'à':'a','â':'a','ä':'a','é':'e','è':'e','ê':'e','ë':'e',
          'ï':'i','î':'i','ô':'o','ù':'u','û':'u','ü':'u','ç':'c',' ':'-'
        })[c] || c)}">${client.segment}</span>
        <span class="badge" style="background: ${healthColor}; color: white;">
          Health Score: ${client.avgHealthScore}/100
        </span>
        <span class="badge" style="background: ${sentimentColor}; color: white;">
          Sentiment: ${sentimentText}
        </span>
      </div>
      <div style="margin-top: 8px; font-size: 12px; color: var(--text-muted);">
        ${client.segmentReason}
      </div>
    </div>

    <!-- NOTES COMPLÈTES - LE PLUS IMPORTANT! -->
    <div style="margin-top: 24px; padding: 20px; background: rgba(99, 102, 241, 0.05); border-radius: 12px; border-left: 4px solid var(--accent);">
      <div style="font-size: 16px; font-weight: 700; color: var(--accent); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
        📝 Notes et Informations Client (${client.totalNotes} note${client.totalNotes > 1 ? 's' : ''})
      </div>
      <div style="background: var(--bg-card); padding: 16px; border-radius: 8px; line-height: 1.8; color: var(--text);">
        ${notesContent}
      </div>
      ${client.latestNoteDate ? `
      <div style="margin-top: 12px; font-size: 11px; color: var(--text-muted);">
        📅 Dernière mise à jour: ${new Date(client.latestNoteDate).toLocaleString('fr-FR')}
      </div>
      ` : ''}
    </div>

    <!-- Engagement & Relationnel -->
    <div style="margin-top: 20px; padding: 16px; background: var(--bg-card); border-radius: 10px;">
      <div style="font-size: 14px; font-weight: 700; color: var(--accent); margin-bottom: 12px;">
        Engagement & Relationnel
      </div>
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
        <div style="text-align: center; padding: 12px; background: rgba(99, 102, 241, 0.1); border-radius: 8px;">
          <div style="font-size: 20px; font-weight: 700; color: var(--accent);">${client.engagementEmails}</div>
          <div style="font-size: 11px; color: var(--text-muted);">Emails</div>
        </div>
        <div style="text-align: center; padding: 12px; background: rgba(99, 102, 241, 0.1); border-radius: 8px;">
          <div style="font-size: 20px; font-weight: 700; color: var(--accent);">${client.engagementCalls}</div>
          <div style="font-size: 11px; color: var(--text-muted);">Calls</div>
        </div>
        <div style="text-align: center; padding: 12px; background: rgba(99, 102, 241, 0.1); border-radius: 8px;">
          <div style="font-size: 20px; font-weight: 700; color: var(--accent);">${client.engagementMeetings}</div>
          <div style="font-size: 11px; color: var(--text-muted);">Meetings</div>
        </div>
      </div>
      <div style="margin-top: 12px; padding: 12px; background: rgba(99, 102, 241, 0.05); border-radius: 6px;">
        <div style="font-size: 12px; color: var(--text-muted);">Analyse des notes:</div>
        <div style="font-size: 11px; margin-top: 6px; display: flex; gap: 12px; flex-wrap: wrap;">
          <span style="color: #22c55e;">Positif: ${client.notesPositiveKeywords}</span>
          <span style="color: #ef4444;">Négatif: ${client.notesNegativeKeywords}</span>
          <span style="color: #6366f1;">Action: ${client.notesActionKeywords}</span>
          <span style="color: #8b5cf6;">Meeting: ${client.notesMeetingKeywords}</span>
        </div>
      </div>
    </div>

    <!-- Graphique d'évolution du CA -->
    <div style="margin-top: 20px; padding: 16px; background: var(--bg-card); border-radius: 10px;">
      <div style="font-size: 14px; font-weight: 700; color: var(--accent); margin-bottom: 16px;">
        Évolution du Chiffre d'Affaires
      </div>
      ${(() => {
        const chartYears = ['2022', '2023', '2024', '2025'];
        const chartValues = chartYears.map(y => client.years[y] || 0);
        const maxValue = Math.max(...chartValues, 1);
        const chartHeight = 200;
        const chartWidth = 600;
        const barWidth = 80;
        const gap = 60;
        const padding = 40;

        return `
          <svg width="100%" height="${chartHeight + 60}" viewBox="0 0 ${chartWidth} ${chartHeight + 60}" style="max-width: 100%;">
            <!-- Grille horizontale -->
            ${[0, 0.25, 0.5, 0.75, 1].map(ratio => `
              <line
                x1="${padding}"
                y1="${chartHeight - ratio * chartHeight + 20}"
                x2="${chartWidth - 20}"
                y2="${chartHeight - ratio * chartHeight + 20}"
                stroke="rgba(148, 163, 184, 0.2)"
                stroke-width="1"
              />
              <text
                x="${padding - 10}"
                y="${chartHeight - ratio * chartHeight + 24}"
                fill="var(--text-muted)"
                font-size="10"
                text-anchor="end"
              >
                ${(maxValue * ratio / 1000).toFixed(0)}k€
              </text>
            `).join('')}

            <!-- Barres -->
            ${chartYears.map((year, i) => {
              const value = chartValues[i];
              const barHeight = maxValue > 0 ? (value / maxValue) * (chartHeight - 40) : 0;
              const x = padding + i * (barWidth + gap);
              const y = chartHeight - barHeight + 20;

              // Couleur basée sur la tendance
              let barColor = '#6366f1';
              if (i > 0 && chartValues[i-1] > 0) {
                const change = ((value - chartValues[i-1]) / chartValues[i-1]) * 100;
                if (change > 10) barColor = '#22c55e';
                else if (change > 0) barColor = '#4ade80';
                else if (change < -10) barColor = '#ef4444';
                else if (change < 0) barColor = '#fb923c';
              }

              return `
                <rect
                  x="${x}"
                  y="${y}"
                  width="${barWidth}"
                  height="${barHeight}"
                  fill="${barColor}"
                  rx="4"
                  opacity="0.9"
                >
                  <title>${year}: ${(value / 1000).toFixed(1)}k€</title>
                </rect>
                <text
                  x="${x + barWidth/2}"
                  y="${chartHeight + 35}"
                  fill="var(--text)"
                  font-size="12"
                  font-weight="600"
                  text-anchor="middle"
                >
                  ${year}
                </text>
                ${value > 0 ? `
                <text
                  x="${x + barWidth/2}"
                  y="${y - 6}"
                  fill="${barColor}"
                  font-size="11"
                  font-weight="700"
                  text-anchor="middle"
                >
                  ${(value / 1000).toFixed(0)}k
                </text>
                ` : ''}
              `;
            }).join('')}
          </svg>
        `;
      })()}
    </div>

    <div class="info-row">
      <span class="info-label">CA Total (2022-2025)</span>
      <span class="info-value" style="color: var(--green); font-size: 18px;">${formatCurrency(client.totalRevenue)}</span>
    </div>

    <div class="info-row">
      <span class="info-label">Nombre total de deals</span>
      <span class="info-value">${client.dealCount}</span>
    </div>

    <div class="info-row">
      <span class="info-label">Ticket moyen</span>
      <span class="info-value">${formatCurrency(client.totalRevenue / client.dealCount)}</span>
    </div>

    <div class="info-row">
      <span class="info-label">Tendance globale</span>
      <span class="info-value" style="color: ${client.trend > 0 ? 'var(--green)' : 'var(--red)'}">
        ${client.trend > 10 ? '↗' : client.trend < -10 ? '↘' : '→'} ${client.trend.toFixed(1)}%
      </span>
    </div>

    ${client.lastDealDate ? `
    <div class="info-row">
      <span class="info-label">Dernier deal</span>
      <span class="info-value">${new Date(client.lastDealDate).toLocaleDateString('fr-FR')}</span>
    </div>
    ` : ''}

    <div style="margin-top: 20px; padding-top: 16px; border-top: 2px solid var(--border);">
      <div style="color: var(--accent); font-weight: 700; margin-bottom: 12px; font-size: 14px;">
        Évolution année par année
      </div>
      ${years.map(year => {
        const revenue = client.years[year];
        const trend = client.yearlyTrends[year];
        if (revenue === 0 && year !== '2022') return '';

        let trendColor = 'var(--text-muted)';
        if (trend.value !== null && trend.value !== 0) {
          if (trend.value > 20) trendColor = 'var(--green)';
          else if (trend.value > 0) trendColor = 'var(--green-light)';
          else if (trend.value < -20) trendColor = 'var(--red)';
          else if (trend.value < 0) trendColor = 'var(--orange)';
        }

        // Format description with proper currency formatting
        let fullDescription = trend.description;
        if (trend.currentRevenue && trend.previousRevenue) {
          fullDescription = `${trend.description}: ${formatCurrency(trend.previousRevenue)} → ${formatCurrency(trend.currentRevenue)}`;
        } else if (trend.currentRevenue && !trend.previousRevenue) {
          fullDescription = `${trend.description}: ${formatCurrency(trend.currentRevenue)}`;
        } else if (trend.previousRevenue && trend.previousYearLabel) {
          fullDescription = `${trend.description} (vs ${formatCurrency(trend.previousRevenue)} en ${trend.previousYearLabel})`;
        }

        return `
        <div style="padding: 10px 0; border-bottom: 1px solid var(--border);">
          <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
            <span style="color: var(--text); font-weight: 600;">${year}</span>
            <span style="color: var(--green); font-weight: 700;">${revenue > 0 ? formatCurrency(revenue) : '-'}</span>
          </div>
          ${revenue > 0 ? `
          <div style="font-size: 11px; color: ${trendColor}; margin-left: 8px;">
            ${trend.label} <span style="color: var(--text-muted);">• ${fullDescription}</span>
          </div>
          ` : ''}
        </div>
        `;
      }).join('')}
    </div>

    <!-- Section Calculs (Discrète) -->
    <details style="margin-top: 20px; padding: 12px; background: rgba(255, 255, 255, 0.02); border-radius: 8px; border: 1px solid var(--border);">
      <summary style="cursor: pointer; font-size: 12px; color: var(--text-muted); font-weight: 600; user-select: none;">
        🔍 Voir les détails des calculs
      </summary>

      <div style="margin-top: 16px; padding-top: 12px; border-top: 1px solid var(--border);">
        <div style="font-size: 13px; color: var(--accent); font-weight: 700; margin-bottom: 12px;">
          Calcul du Score (${client.score}/100)
        </div>

        <div style="font-size: 12px; color: var(--text); line-height: 1.8;">
          <div style="margin-bottom: 8px;">
            <span style="color: var(--text-muted);">CA Total:</span>
            <span style="float: right; color: var(--accent); font-weight: 600;">+${scoreCA.toFixed(1)} pts</span><br>
            <span style="font-size: 11px; color: var(--text-muted); margin-left: 8px;">
              ${formatCurrency(client.totalRevenue)} = ${(client.totalRevenue / 2500).toFixed(1)} × 1pt (max 40)
            </span>
          </div>

          <div style="margin-bottom: 8px;">
            <span style="color: var(--text-muted);">Tendance:</span>
            <span style="float: right; color: ${scoreTrend >= 0 ? 'var(--green)' : 'var(--red)'}; font-weight: 600;">
              ${scoreTrend >= 0 ? '+' : ''}${scoreTrend} pts
            </span><br>
            <span style="font-size: 11px; color: var(--text-muted); margin-left: 8px;">
              ${client.trend.toFixed(1)}% ${scoreTrend === 30 ? '(>50% = 30pts)' : scoreTrend === 20 ? '(20-50% = 20pts)' : scoreTrend === 10 ? '(0-20% = 10pts)' : scoreTrend === -10 ? '(<-20% = -10pts)' : '(stable = 0pt)'}
            </span>
          </div>

          <div style="margin-bottom: 8px;">
            <span style="color: var(--text-muted);">Récence:</span>
            <span style="float: right; color: var(--blue); font-weight: 600;">+${scoreRecence} pts</span><br>
            <span style="font-size: 11px; color: var(--text-muted); margin-left: 8px;">
              ${client.lastDealDate ?
                `Dernier deal: ${Math.round((new Date() - client.lastDealDate) / (1000 * 60 * 60 * 24))} jours` +
                (scoreRecence === 20 ? ' (<6 mois = 20pts)' : scoreRecence === 10 ? ' (6-12 mois = 10pts)' : ' (>12 mois = 0pt)')
                : 'Aucune date (0pt)'}
            </span>
          </div>

          <div style="margin-bottom: 8px;">
            <span style="color: var(--text-muted);">Deals:</span>
            <span style="float: right; color: var(--purple); font-weight: 600;">+${scoreDeals} pts</span><br>
            <span style="font-size: 11px; color: var(--text-muted); margin-left: 8px;">
              ${client.dealCount} deals × 2pts (max 10)
            </span>
          </div>

          <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); text-align: right;">
            <span style="font-size: 14px; font-weight: 700; color: var(--accent);">
              Total: ${scoreCA.toFixed(1)} + ${scoreTrend} + ${scoreRecence} + ${scoreDeals} = ${client.score}/100
            </span>
          </div>
        </div>

        <div style="margin-top: 20px; padding-top: 12px; border-top: 1px solid var(--border);">
          <div style="font-size: 13px; color: var(--accent); font-weight: 700; margin-bottom: 8px;">
            Calcul de la Tendance Globale (${client.trend.toFixed(1)}%)
          </div>
          <div style="font-size: 11px; color: var(--text-muted); line-height: 1.6;">
            Méthode: % de croissance entre la PREMIÈRE année active et la DERNIÈRE année active.<br>
            Formule: ((CA Dernière - CA Première) / CA Première) × 100
          </div>
        </div>
      </div>
    </details>

    <div style="margin-top: 20px; padding: 16px; background: rgba(99, 102, 241, 0.1); border-radius: 10px; border-left: 4px solid var(--accent);">
      <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 6px; font-weight: 600;">
        Action recommandée:
      </div>
      <div style="font-size: 14px; font-weight: 600; color: var(--text);">
        ${client.recommendation}
      </div>
    </div>
  `;

  const clientName = client.name || client.groupName || 'Client inconnu';
  console.log('🔓 Ouverture du panel avec:', clientName);

  try {
    openInfoPanel(`Détails Client - ${clientName}`, infoContent);
    console.log('✅ Panel ouvert avec succès');
  } catch (error) {
    console.error('❌ Erreur lors de l\'ouverture du panel:', error);
  }
}

// ============================================================================
// White Spaces Opportunities Table
// ============================================================================
function renderWhiteSpaces() {
  console.log('🎯 Génération tableau White Spaces...');

  const whiteSpaces = [];

  // Créer un Set de toutes les companies qui ont des deals
  const companiesWithDeals = new Set(processedData.map(client => client.companyId));
  console.log(`   → ${companiesWithDeals.size} companies avec deals`);

  // DEBUG: Logger les IDs pour debug
  console.log('   → Exemple companyIds dans processedData:',
    processedData.slice(0, 3).map(c => ({ name: c.name, id: c.companyId, type: typeof c.companyId })));

  // Parcourir TOUTES les companies dans HubSpot pour trouver les relations parent/child
  Object.values(window.hubspotCompanies).forEach(company => {
    // Si cette company a des enfants (childCompanyIds)
    if (company.childCompanyIds && company.childCompanyIds.length > 0) {
      console.log(`   → Parent trouvé: ${company.name} (ID: ${company.id}, type: ${typeof company.id}) avec ${company.childCompanyIds.length} filiales`);

      // Trouver le parent dans processedData pour obtenir son CA et health score
      // Convertir les IDs en string pour la comparaison (au cas où l'un est number et l'autre string)
      const parentDeal = processedData.find(client => String(client.companyId) === String(company.id));
      const parentRevenue = parentDeal ? parentDeal.totalRevenue : 0;
      const parentHealthScore = parentDeal ? parentDeal.avgHealthScore : 50;

      // DEBUG: Logger le résultat de la recherche
      console.log(`     → Parent deal trouvé: ${parentDeal ? 'OUI' : 'NON'}, CA: ${parentRevenue}, Health: ${parentHealthScore}`);

      // Parcourir chaque filiale
      company.childCompanyIds.forEach(childId => {
        // Si cette filiale N'A PAS de deals (n'est pas dans companiesWithDeals)
        if (!companiesWithDeals.has(childId)) {
          const childCompany = window.hubspotCompanies[childId];
          if (childCompany) {
            console.log(`     ✓ WHITE SPACE trouvé: ${childCompany.name} (filiale de ${company.name})`);
            whiteSpaces.push({
              name: childCompany.name || 'Filiale sans nom',
              parentName: company.name,
              parentId: company.id,
              parentRevenue: parentRevenue,
              parentHealthScore: parentHealthScore,
              sector: childCompany.industry || 'Non spécifié',
              companyId: childId,
              isUnmapped: true // Pas de deals du tout
            });
          }
        }
      });
    }
  });

  console.log(`   → ${whiteSpaces.length} white spaces identifiés`);

  // Calculer le potentiel estimé pour chaque white space
  whiteSpaces.forEach(ws => {
    // Potentiel = % du CA parent (entre 5% et 15% selon le health score)
    const potentialPercent = ws.parentHealthScore >= 70 ? 0.15 :
                            ws.parentHealthScore >= 50 ? 0.10 :
                            0.05;
    ws.estimatedPotential = ws.parentRevenue * potentialPercent;

    // Priorité basée sur le potentiel
    if (ws.estimatedPotential >= 50000 && ws.parentHealthScore >= 70) {
      ws.priority = 'HIGH';
      ws.priorityColor = '#22c55e';
      ws.priorityLabel = 'HAUTE';
    } else if (ws.estimatedPotential >= 20000 || ws.parentHealthScore >= 50) {
      ws.priority = 'MEDIUM';
      ws.priorityColor = '#f59e0b';
      ws.priorityLabel = 'MOYENNE';
    } else {
      ws.priority = 'LOW';
      ws.priorityColor = '#94a3b8';
      ws.priorityLabel = 'BASSE';
    }

    // Action recommandée
    if (ws.priority === 'HIGH') {
      ws.action = 'Contact immédiat';
    } else if (ws.priority === 'MEDIUM') {
      ws.action = 'Prospection ciblée';
    } else {
      ws.action = 'Veille passive';
    }
  });

  // Trier par priorité, puis potentiel, puis alphabétique par nom du parent
  const priorityOrder = { 'HIGH': 1, 'MEDIUM': 2, 'LOW': 3 };
  whiteSpaces.sort((a, b) => {
    // 1. Priorité
    if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
      return priorityOrder[a.priority] - priorityOrder[b.priority];
    }
    // 2. Potentiel estimé (descendant)
    if (b.estimatedPotential !== a.estimatedPotential) {
      return b.estimatedPotential - a.estimatedPotential;
    }
    // 3. Ordre alphabétique du nom du parent
    return a.parentName.localeCompare(b.parentName);
  });

  // Mettre à jour le compteur
  const countBadge = document.getElementById('whiteSpaceCount');
  if (countBadge) {
    countBadge.textContent = `${whiteSpaces.length} opportunité${whiteSpaces.length > 1 ? 's' : ''}`;
  }

  // Remplir le tableau
  const tbody = document.getElementById('whiteSpacesBody');
  if (!tbody) {
    console.warn('⚠️ Element whiteSpacesBody non trouvé');
    return;
  }

  if (whiteSpaces.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="7" style="text-align: center; padding: 40px; color: var(--text-muted); font-style: italic;">
          Aucun white space identifié. Toutes les filiales mappées ont des deals actifs.
        </td>
      </tr>
    `;
    return;
  }

  tbody.innerHTML = whiteSpaces.map((ws, idx) => {
    // Mapping secteur FR (utiliser le mapping complet des industries)
    const sectorMapping = {
      // Tech & IT
      'Computer Software': 'Logiciels & IT', 'Information Technology and Services': 'Logiciels & IT',
      'IT Services and IT Consulting': 'Logiciels & IT', 'Internet': 'Internet & Web',
      'Computer & Network Security': 'Cybersécurité', 'Software Development': 'Développement logiciel',
      'Telecommunications': 'Télécommunications', 'COMPUTER_SOFTWARE': 'Logiciels & IT',
      'INFORMATION_TECHNOLOGY_AND_SERVICES': 'Logiciels & IT', 'INFORMATION_SERVICES': 'Services informatiques',
      'COMPUTER_HARDWARE': 'Matériel informatique', 'TELECOMMUNICATIONS': 'Télécommunications',
      'SEMICONDUCTORS': 'Semi-conducteurs', 'DESIGN': 'Design & CAO', 'E_LEARNING': 'E-learning',
      // Finance & Banking
      'Financial Services': 'Services financiers', 'Banking': 'Banque', 'Insurance': 'Assurance',
      'Venture Capital & Private Equity': 'Capital-risque & Private Equity',
      'Investment Banking': 'Banque d\'investissement', 'Investment Management': 'Gestion d\'actifs',
      'FINANCIAL_SERVICES': 'Services financiers', 'BANKING': 'Banque', 'INSURANCE': 'Assurance',
      'CAPITAL_MARKETS': 'Marchés financiers', 'ACCOUNTING': 'Comptabilité',
      // Manufacturing & Industrial
      'Manufacturing': 'Industrie & Manufacturing', 'Industrial Automation': 'Automatisation industrielle',
      'Machinery': 'Machinerie', 'Electrical/Electronic Manufacturing': 'Électronique',
      'Automotive': 'Automobile', 'Aviation & Aerospace': 'Aéronautique & Spatial',
      'INDUSTRIAL_AUTOMATION': 'Automatisation industrielle', 'AUTOMOTIVE': 'Automobile',
      'AVIATION_AEROSPACE': 'Aéronautique & Spatial', 'AIRLINES_AVIATION': 'Aviation',
      'ELECTRICAL_ELECTRONIC_MANUFACTURING': 'Électronique', 'MACHINERY': 'Machinerie',
      'MECHANICAL_OR_INDUSTRIAL_ENGINEERING': 'Ingénierie industrielle',
      'BUILDING_MATERIALS': 'Matériaux de construction', 'CHEMICALS': 'Chimie',
      'PLASTICS': 'Plastiques', 'PAPER_FOREST_PRODUCTS': 'Papier & Produits forestiers',
      'MINING_METALS': 'Mines & Métaux', 'RAILROAD_MANUFACTURE': 'Fabrication ferroviaire',
      'DEFENSE_SPACE': 'Défense & Spatial', 'MILITARY': 'Militaire',
      // Retail & E-commerce
      'Retail': 'Commerce de détail', 'E-commerce': 'E-commerce', 'Consumer Goods': 'Biens de consommation',
      'Consumer Electronics': 'Électronique grand public', 'Luxury Goods & Jewelry': 'Luxe & Joaillerie',
      'Apparel & Fashion': 'Mode & Habillement', 'RETAIL': 'Commerce de détail',
      'CONSUMER_GOODS': 'Biens de consommation', 'CONSUMER_ELECTRONICS': 'Électronique grand public',
      'LUXURY_GOODS_JEWELRY': 'Luxe & Joaillerie', 'APPAREL_FASHION': 'Mode & Habillement',
      'COSMETICS': 'Cosmétiques', 'TEXTILES': 'Textile', 'FURNITURE': 'Ameublement',
      'SPORTING_GOODS': 'Articles de sport', 'BUSINESS_SUPPLIES_AND_EQUIPMENT': 'Fournitures & Équipements',
      // Healthcare & Pharma
      'Hospital & Health Care': 'Santé & Soins', 'Medical Devices': 'Dispositifs médicaux',
      'Pharmaceuticals': 'Pharmaceutique', 'Biotechnology': 'Biotechnologie',
      'Medical Practice': 'Pratique médicale', 'HOSPITAL_HEALTH_CARE': 'Santé & Soins',
      'MEDICAL_DEVICES': 'Dispositifs médicaux', 'PHARMACEUTICALS': 'Pharmaceutique',
      'BIOTECHNOLOGY': 'Biotechnologie', 'HEALTH_WELLNESS_AND_FITNESS': 'Santé & Bien-être',
      'VETERINARY': 'Vétérinaire',
      // Consulting & Services
      'Management Consulting': 'Conseil en management', 'Marketing and Advertising': 'Marketing & Publicité',
      'Public Relations and Communications': 'Relations publiques', 'Human Resources': 'Ressources humaines',
      'Business Consulting and Services': 'Conseil & Services', 'Professional Services': 'Services professionnels',
      'MANAGEMENT_CONSULTING': 'Conseil en management', 'MARKETING_AND_ADVERTISING': 'Marketing & Publicité',
      'HUMAN_RESOURCES': 'Ressources humaines', 'STAFFING_AND_RECRUITING': 'Recrutement',
      'OUTSOURCING_OFFSHORING': 'Externalisation', 'EVENTS_SERVICES': 'Événementiel',
      'MARKET_RESEARCH': 'Études de marché',
      // Construction & Real Estate
      'Construction': 'BTP & Construction', 'Real Estate': 'Immobilier',
      'Architecture & Planning': 'Architecture', 'Civil Engineering': 'Génie civil',
      'CONSTRUCTION': 'BTP & Construction', 'REAL_ESTATE': 'Immobilier',
      'COMMERCIAL_REAL_ESTATE': 'Immobilier commercial',
      // Education
      'Education Management': 'Gestion éducative', 'Higher Education': 'Enseignement supérieur',
      'E-Learning': 'E-learning', 'Primary/Secondary Education': 'Enseignement primaire/secondaire',
      'HIGHER_EDUCATION': 'Enseignement supérieur',
      // Media & Entertainment
      'Media Production': 'Production média', 'Entertainment': 'Divertissement',
      'Publishing': 'Édition', 'Broadcast Media': 'Médias audiovisuels',
      'MEDIA_PRODUCTION': 'Production média', 'ENTERTAINMENT': 'Divertissement',
      'PUBLISHING': 'Édition', 'BROADCAST_MEDIA': 'Médias audiovisuels',
      'ONLINE_MEDIA': 'Médias en ligne', 'COMPUTER_GAMES': 'Jeux vidéo',
      'ARTS_AND_CRAFTS': 'Arts & Artisanat',
      // Transport & Logistics
      'Transportation/Trucking/Railroad': 'Transport', 'Logistics and Supply Chain': 'Logistique',
      'Airlines/Aviation': 'Aviation', 'Maritime': 'Maritime',
      'TRANSPORTATION_TRUCKING_RAILROAD': 'Transport', 'LOGISTICS_AND_SUPPLY_CHAIN': 'Logistique',
      'MARITIME': 'Maritime',
      // Hospitality & Food
      'Hospitality': 'Hôtellerie', 'Restaurants': 'Restauration', 'Food & Beverages': 'Agroalimentaire',
      'Food Production': 'Production alimentaire', 'HOSPITALITY': 'Hôtellerie',
      'FOOD_BEVERAGES': 'Agroalimentaire', 'FOOD_PRODUCTION': 'Production alimentaire',
      'WINE_AND_SPIRITS': 'Vins & Spiritueux', 'RESTAURANTS': 'Restauration',
      'LEISURE_TRAVEL_TOURISM': 'Tourisme & Loisirs', 'GAMBLING_CASINOS': 'Casinos & Jeux',
      // Energy & Environment
      'Oil & Energy': 'Pétrole & Énergie', 'Renewable Energy': 'Énergies renouvelables',
      'Utilities': 'Services publics', 'Environmental Services': 'Services environnementaux',
      'OIL_ENERGY': 'Pétrole & Énergie', 'RENEWABLES_ENVIRONMENT': 'Énergies renouvelables',
      'UTILITIES': 'Services publics', 'ENVIRONMENTAL_SERVICES': 'Services environnementaux',
      // Government & Non-Profit
      'Government Administration': 'Administration publique',
      'Non-Profit Organization Management': 'Association', 'International Affairs': 'Affaires internationales',
      'GOVERNMENT_ADMINISTRATION': 'Administration publique',
      'NON_PROFIT_ORGANIZATION_MANAGEMENT': 'Association', 'CIVIC_SOCIAL_ORGANIZATION': 'Organisation civique',
      'PHILANTHROPY': 'Philanthropie', 'INTERNATIONAL_TRADE_AND_DEVELOPMENT': 'Commerce international',
      // Legal
      'Law Practice': 'Juridique', 'Legal Services': 'Services juridiques', 'LAW_PRACTICE': 'Juridique',
      // Agriculture
      'Farming': 'Agriculture', 'Ranching': 'Élevage', 'FARMING': 'Agriculture',
      // Other
      'Research': 'Recherche', 'Security and Investigations': 'Sécurité & Investigation',
      'Sports': 'Sports', 'Think Tanks': 'Think tanks', 'Staffing and Recruiting': 'Recrutement',
      'RESEARCH': 'Recherche', 'SECURITY_AND_INVESTIGATIONS': 'Sécurité & Investigation',
      'PROSPECT': 'Prospect', 'Client': 'Client'
    };
    const sectorFr = sectorMapping[ws.sector] || ws.sector;

    return `
      <tr style="border-bottom: 1px solid var(--border); transition: all 0.2s;"
          onmouseover="this.style.background='rgba(251, 191, 36, 0.08)'"
          onmouseout="this.style.background='transparent'">

        <!-- Opportunité -->
        <td style="padding: 12px;">
          <div style="font-weight: 600; color: var(--text); margin-bottom: 4px;">
            ${ws.name}
          </div>
          ${ws.isUnmapped ? `
          <div style="font-size: 10px; color: #f59e0b; font-style: italic;">
            Filiale non contactée
          </div>
          ` : ''}
        </td>

        <!-- Groupe Parent -->
        <td style="padding: 12px;">
          <div style="color: var(--text-muted); font-size: 13px;">
            ${ws.parentName}
          </div>
        </td>

        <!-- Secteur -->
        <td style="padding: 12px;">
          <div style="color: var(--text); font-size: 12px;">
            ${sectorFr}
          </div>
        </td>

        <!-- CA Parent -->
        <td style="padding: 12px;">
          <div style="color: var(--accent); font-weight: 600; font-size: 13px;">
            ${formatCurrency(ws.parentRevenue)}
          </div>
        </td>

        <!-- Potentiel Estimé -->
        <td style="padding: 12px;">
          <div style="color: var(--green); font-weight: 700; font-size: 14px;">
            ${formatCurrency(ws.estimatedPotential)}
          </div>
          <div style="font-size: 10px; color: var(--text-muted); margin-top: 2px;">
            ${((ws.estimatedPotential / ws.parentRevenue) * 100).toFixed(0)}% du parent
          </div>
        </td>

        <!-- Priorité -->
        <td style="padding: 12px;">
          <div style="display: inline-block; background: ${ws.priorityColor}; color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; letter-spacing: 0.5px;">
            ${ws.priorityLabel}
          </div>
        </td>

        <!-- Action -->
        <td style="padding: 12px;">
          <button onclick="showWhiteSpaceDetails(${idx})"
                  style="padding: 6px 14px; background: linear-gradient(135deg, #f59e0b, #fbbf24); color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                  onmouseover="this.style.transform='scale(1.05)'"
                  onmouseout="this.style.transform='scale(1)'">
            ${ws.action}
          </button>
        </td>
      </tr>
    `;
  }).join('');

  // Stocker les white spaces globalement pour accès dans showWhiteSpaceDetails
  window.currentWhiteSpaces = whiteSpaces;

  console.log('✅ Tableau White Spaces rendu');
}

// ============================================================================
// Show White Space Details
// ============================================================================
function showWhiteSpaceDetails(wsIndex) {
  const ws = window.currentWhiteSpaces[wsIndex];

  if (!ws) {
    console.error('❌ White space non trouvé:', wsIndex);
    return;
  }

  // Mapping secteur FR complet
  const sectorMapping = {
    'Computer Software': 'Logiciels & IT', 'Information Technology and Services': 'Logiciels & IT',
    'IT Services and IT Consulting': 'Logiciels & IT', 'Internet': 'Internet & Web',
    'Computer & Network Security': 'Cybersécurité', 'Software Development': 'Développement logiciel',
    'Telecommunications': 'Télécommunications', 'COMPUTER_SOFTWARE': 'Logiciels & IT',
    'INFORMATION_TECHNOLOGY_AND_SERVICES': 'Logiciels & IT', 'INFORMATION_SERVICES': 'Services informatiques',
    'COMPUTER_HARDWARE': 'Matériel informatique', 'TELECOMMUNICATIONS': 'Télécommunications',
    'SEMICONDUCTORS': 'Semi-conducteurs', 'DESIGN': 'Design & CAO', 'E_LEARNING': 'E-learning',
    'Financial Services': 'Services financiers', 'Banking': 'Banque', 'Insurance': 'Assurance',
    'Venture Capital & Private Equity': 'Capital-risque & Private Equity',
    'Investment Banking': 'Banque d\'investissement', 'Investment Management': 'Gestion d\'actifs',
    'FINANCIAL_SERVICES': 'Services financiers', 'BANKING': 'Banque', 'INSURANCE': 'Assurance',
    'CAPITAL_MARKETS': 'Marchés financiers', 'ACCOUNTING': 'Comptabilité',
    'Manufacturing': 'Industrie & Manufacturing', 'Industrial Automation': 'Automatisation industrielle',
    'Machinery': 'Machinerie', 'Electrical/Electronic Manufacturing': 'Électronique',
    'Automotive': 'Automobile', 'Aviation & Aerospace': 'Aéronautique & Spatial',
    'INDUSTRIAL_AUTOMATION': 'Automatisation industrielle', 'AUTOMOTIVE': 'Automobile',
    'AVIATION_AEROSPACE': 'Aéronautique & Spatial', 'AIRLINES_AVIATION': 'Aviation',
    'ELECTRICAL_ELECTRONIC_MANUFACTURING': 'Électronique', 'MACHINERY': 'Machinerie',
    'MECHANICAL_OR_INDUSTRIAL_ENGINEERING': 'Ingénierie industrielle',
    'BUILDING_MATERIALS': 'Matériaux de construction', 'CHEMICALS': 'Chimie',
    'PLASTICS': 'Plastiques', 'PAPER_FOREST_PRODUCTS': 'Papier & Produits forestiers',
    'MINING_METALS': 'Mines & Métaux', 'RAILROAD_MANUFACTURE': 'Fabrication ferroviaire',
    'DEFENSE_SPACE': 'Défense & Spatial', 'MILITARY': 'Militaire',
    'Retail': 'Commerce de détail', 'E-commerce': 'E-commerce', 'Consumer Goods': 'Biens de consommation',
    'Consumer Electronics': 'Électronique grand public', 'Luxury Goods & Jewelry': 'Luxe & Joaillerie',
    'Apparel & Fashion': 'Mode & Habillement', 'RETAIL': 'Commerce de détail',
    'CONSUMER_GOODS': 'Biens de consommation', 'CONSUMER_ELECTRONICS': 'Électronique grand public',
    'LUXURY_GOODS_JEWELRY': 'Luxe & Joaillerie', 'APPAREL_FASHION': 'Mode & Habillement',
    'COSMETICS': 'Cosmétiques', 'TEXTILES': 'Textile', 'FURNITURE': 'Ameublement',
    'SPORTING_GOODS': 'Articles de sport', 'BUSINESS_SUPPLIES_AND_EQUIPMENT': 'Fournitures & Équipements',
    'Hospital & Health Care': 'Santé & Soins', 'Medical Devices': 'Dispositifs médicaux',
    'Pharmaceuticals': 'Pharmaceutique', 'Biotechnology': 'Biotechnologie',
    'Medical Practice': 'Pratique médicale', 'HOSPITAL_HEALTH_CARE': 'Santé & Soins',
    'MEDICAL_DEVICES': 'Dispositifs médicaux', 'PHARMACEUTICALS': 'Pharmaceutique',
    'BIOTECHNOLOGY': 'Biotechnologie', 'HEALTH_WELLNESS_AND_FITNESS': 'Santé & Bien-être',
    'VETERINARY': 'Vétérinaire',
    'Management Consulting': 'Conseil en management', 'Marketing and Advertising': 'Marketing & Publicité',
    'Public Relations and Communications': 'Relations publiques', 'Human Resources': 'Ressources humaines',
    'Business Consulting and Services': 'Conseil & Services', 'Professional Services': 'Services professionnels',
    'MANAGEMENT_CONSULTING': 'Conseil en management', 'MARKETING_AND_ADVERTISING': 'Marketing & Publicité',
    'HUMAN_RESOURCES': 'Ressources humaines', 'STAFFING_AND_RECRUITING': 'Recrutement',
    'OUTSOURCING_OFFSHORING': 'Externalisation', 'EVENTS_SERVICES': 'Événementiel',
    'MARKET_RESEARCH': 'Études de marché',
    'Construction': 'BTP & Construction', 'Real Estate': 'Immobilier',
    'Architecture & Planning': 'Architecture', 'Civil Engineering': 'Génie civil',
    'CONSTRUCTION': 'BTP & Construction', 'REAL_ESTATE': 'Immobilier',
    'COMMERCIAL_REAL_ESTATE': 'Immobilier commercial',
    'Education Management': 'Gestion éducative', 'Higher Education': 'Enseignement supérieur',
    'E-Learning': 'E-learning', 'Primary/Secondary Education': 'Enseignement primaire/secondaire',
    'HIGHER_EDUCATION': 'Enseignement supérieur',
    'Media Production': 'Production média', 'Entertainment': 'Divertissement',
    'Publishing': 'Édition', 'Broadcast Media': 'Médias audiovisuels',
    'MEDIA_PRODUCTION': 'Production média', 'ENTERTAINMENT': 'Divertissement',
    'PUBLISHING': 'Édition', 'BROADCAST_MEDIA': 'Médias audiovisuels',
    'ONLINE_MEDIA': 'Médias en ligne', 'COMPUTER_GAMES': 'Jeux vidéo',
    'ARTS_AND_CRAFTS': 'Arts & Artisanat',
    'Transportation/Trucking/Railroad': 'Transport', 'Logistics and Supply Chain': 'Logistique',
    'Airlines/Aviation': 'Aviation', 'Maritime': 'Maritime',
    'TRANSPORTATION_TRUCKING_RAILROAD': 'Transport', 'LOGISTICS_AND_SUPPLY_CHAIN': 'Logistique',
    'MARITIME': 'Maritime',
    'Hospitality': 'Hôtellerie', 'Restaurants': 'Restauration', 'Food & Beverages': 'Agroalimentaire',
    'Food Production': 'Production alimentaire', 'HOSPITALITY': 'Hôtellerie',
    'FOOD_BEVERAGES': 'Agroalimentaire', 'FOOD_PRODUCTION': 'Production alimentaire',
    'WINE_AND_SPIRITS': 'Vins & Spiritueux', 'RESTAURANTS': 'Restauration',
    'LEISURE_TRAVEL_TOURISM': 'Tourisme & Loisirs', 'GAMBLING_CASINOS': 'Casinos & Jeux',
    'Oil & Energy': 'Pétrole & Énergie', 'Renewable Energy': 'Énergies renouvelables',
    'Utilities': 'Services publics', 'Environmental Services': 'Services environnementaux',
    'OIL_ENERGY': 'Pétrole & Énergie', 'RENEWABLES_ENVIRONMENT': 'Énergies renouvelables',
    'UTILITIES': 'Services publics', 'ENVIRONMENTAL_SERVICES': 'Services environnementaux',
    'Government Administration': 'Administration publique',
    'Non-Profit Organization Management': 'Association', 'International Affairs': 'Affaires internationales',
    'GOVERNMENT_ADMINISTRATION': 'Administration publique',
    'NON_PROFIT_ORGANIZATION_MANAGEMENT': 'Association', 'CIVIC_SOCIAL_ORGANIZATION': 'Organisation civique',
    'PHILANTHROPY': 'Philanthropie', 'INTERNATIONAL_TRADE_AND_DEVELOPMENT': 'Commerce international',
    'Law Practice': 'Juridique', 'Legal Services': 'Services juridiques', 'LAW_PRACTICE': 'Juridique',
    'Farming': 'Agriculture', 'Ranching': 'Élevage', 'FARMING': 'Agriculture',
    'Research': 'Recherche', 'Security and Investigations': 'Sécurité & Investigation',
    'Sports': 'Sports', 'Think Tanks': 'Think tanks', 'Staffing and Recruiting': 'Recrutement',
    'RESEARCH': 'Recherche', 'SECURITY_AND_INVESTIGATIONS': 'Sécurité & Investigation',
    'PROSPECT': 'Prospect', 'Client': 'Client'
  };
  const sectorFr = sectorMapping[ws.sector] || ws.sector;

  const content = `
    <div class="info-highlight" style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.05)); border-left: 4px solid #f59e0b; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
      <div style="font-size: 24px; font-weight: 800; color: #f59e0b; margin-bottom: 12px;">
        ${ws.name}
      </div>
      <div style="font-size: 14px; color: var(--text-muted);">
        Filiale de <strong style="color: var(--accent);">${ws.parentName}</strong>
      </div>
    </div>

    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 24px;">
      <div style="background: var(--bg-card); padding: 16px; border-radius: 10px;">
        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">Secteur d'Activité</div>
        <div style="font-size: 18px; font-weight: 700; color: var(--accent);">${sectorFr}</div>
      </div>
      <div style="background: var(--bg-card); padding: 16px; border-radius: 10px;">
        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">CA Groupe Parent</div>
        <div style="font-size: 18px; font-weight: 700; color: var(--accent);">${formatCurrency(ws.parentRevenue)}</div>
      </div>
      <div style="background: var(--bg-card); padding: 16px; border-radius: 10px;">
        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">Potentiel Estimé</div>
        <div style="font-size: 18px; font-weight: 700; color: var(--green);">${formatCurrency(ws.estimatedPotential)}</div>
      </div>
      <div style="background: var(--bg-card); padding: 16px; border-radius: 10px;">
        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">Priorité</div>
        <div style="font-size: 18px; font-weight: 700; color: ${ws.priorityColor};">${ws.priorityLabel}</div>
      </div>
    </div>

    <div style="background: rgba(99, 102, 241, 0.05); padding: 20px; border-radius: 12px; border-left: 4px solid var(--accent); margin-bottom: 20px;">
      <div style="font-size: 16px; font-weight: 700; color: var(--accent); margin-bottom: 12px;">
        Recommandations Account Manager
      </div>
      <div style="color: var(--text); line-height: 1.8; font-size: 14px;">
        ${ws.priority === 'HIGH' ? `
          <strong style="color: #22c55e;">PRIORITÉ HAUTE</strong> - Contact immédiat recommandé:<br><br>
          • Organiser un meeting avec le sponsor existant chez ${ws.parentName}<br>
          • Proposer une démonstration/POC spécifique à ${ws.name}<br>
          • Potentiel estimé: ${formatCurrency(ws.estimatedPotential)} basé sur le CA du groupe<br>
          • Timeline: 2-3 mois pour conclure<br>
          • Leverage: Utiliser la relation existante et les success stories
        ` : ws.priority === 'MEDIUM' ? `
          <strong style="color: #f59e0b;">PRIORITÉ MOYENNE</strong> - Prospection ciblée:<br><br>
          • Identifier les décideurs clés chez ${ws.name}<br>
          • Présenter les bénéfices déjà obtenus par ${ws.parentName}<br>
          • Potentiel: ${formatCurrency(ws.estimatedPotential)}<br>
          • Approche: Multi-threading avec le groupe parent<br>
          • Timeline: 3-6 mois
        ` : `
          <strong style="color: #94a3b8;">PRIORITÉ BASSE</strong> - Veille passive:<br><br>
          • Maintenir le contact via ${ws.parentName}<br>
          • Surveiller les signaux d'achat<br>
          • Nurturing long terme<br>
          • Potentiel: ${formatCurrency(ws.estimatedPotential)}
        `}
      </div>
    </div>

    ${!ws.isUnmapped ? `
    <div style="background: rgba(251, 191, 36, 0.05); padding: 16px; border-radius: 10px; border-left: 3px solid #f59e0b;">
      <div style="font-size: 13px; color: var(--text-muted); font-style: italic;">
        ℹ️ Cette filiale est mappée dans HubSpot mais n'a aucun deal fermé.
        C'est une opportunité de cross-sell directe au sein du groupe.
      </div>
    </div>
    ` : `
    <div style="background: rgba(239, 68, 68, 0.08); padding: 16px; border-radius: 10px; border-left: 3px solid #ef4444;">
      <div style="font-size: 13px; color: #ef4444; font-style: italic;">
        ⚠️ Cette filiale n'a JAMAIS été contactée. C'est une opportunité froide à prospecter depuis zéro.
      </div>
    </div>
    `}
  `;

  openInfoPanel(`White Space: ${ws.name}`, content);
}

window.showWhiteSpaceDetails = showWhiteSpaceDetails;

// ============================================================================
// Recommendations
// ============================================================================
function renderRecommendations() {
  // Catégories variées basées sur différents critères
  const highGrowth = processedData.filter(c => c.trend > 50);
  const declining = processedData.filter(c => c.trend < -20 && c.totalRevenue > 10000);
  const lowEngagement = processedData.filter(c => c.avgHealthScore < 25 && c.totalRevenue > 5000);
  const highValue = processedData.filter(c => c.totalRevenue > 100000);
  const reactivation = processedData.filter(c => c.segment === 'Dormant' || (c.avgHealthScore < 20 && c.totalRevenue > 0));
  const emerging = processedData.filter(c => c.trend > 30 && c.totalRevenue < 50000 && c.totalRevenue > 10000);

  const recommendations = [];

  // 1. Clients en forte croissance
  if (highGrowth.length > 0) {
    recommendations.push({
      title: `${highGrowth.length} Client${highGrowth.length > 1 ? 's' : ''} en Forte Croissance`,
      text: `Capitaliser sur la dynamique positive : ${highGrowth.slice(0, 3).map(c => c.name).join(', ')}. Potentiel de ${formatCurrency(highGrowth.reduce((s, c) => s + c.totalRevenue, 0))} de CA.`,
      action: 'Programme d\'accélération',
      priority: 'high'
    });
  }

  // 2. Clients à haute valeur
  if (highValue.length > 0) {
    recommendations.push({
      title: `${highValue.length} Client${highValue.length > 1 ? 's' : ''} Stratégique${highValue.length > 1 ? 's' : ''}`,
      text: `Focus sur les comptes majeurs : ${highValue.slice(0, 3).map(c => c.name).join(', ')}. Représentent ${((highValue.reduce((s, c) => s + c.totalRevenue, 0) / processedData.reduce((s, c) => s + c.totalRevenue, 0)) * 100).toFixed(0)}% du CA total.`,
      action: 'Revues trimestrielles',
      priority: 'high'
    });
  }

  // 3. Clients en baisse
  if (declining.length > 0) {
    recommendations.push({
      title: `${declining.length} Client${declining.length > 1 ? 's' : ''} en Déclin`,
      text: `ALERTE : ${declining.slice(0, 3).map(c => c.name).join(', ')} montrent une baisse significative. Risque de perte de ${formatCurrency(declining.reduce((s, c) => s + c.totalRevenue, 0))}.`,
      action: 'Plan de rétention urgent',
      priority: 'high'
    });
  }

  // 4. Clients à faible engagement
  if (lowEngagement.length > 0) {
    recommendations.push({
      title: `${lowEngagement.length} Client${lowEngagement.length > 1 ? 's' : ''} à Re-engager`,
      text: `Faible score santé détecté pour ${lowEngagement.slice(0, 3).map(c => c.name).join(', ')}. Renforcer la relation client pour éviter l'attrition.`,
      action: 'Meetings de reconnexion',
      priority: 'medium'
    });
  }

  // 5. Opportunités de réactivation
  if (reactivation.length > 0) {
    recommendations.push({
      title: `${reactivation.length} Opportunité${reactivation.length > 1 ? 's' : ''} de Réactivation`,
      text: `Clients dormants ou inactifs : ${reactivation.slice(0, 3).map(c => c.name).join(', ')}. Potentiel de réactivation de ${formatCurrency(reactivation.reduce((s, c) => s + c.totalRevenue, 0))}.`,
      action: 'Campagne de réengagement',
      priority: 'medium'
    });
  }

  // 6. Clients émergents
  if (emerging.length > 0) {
    recommendations.push({
      title: `${emerging.length} Client${emerging.length > 1 ? 's' : ''} Émergent${emerging.length > 1 ? 's' : ''}`,
      text: `Forte croissance récente pour ${emerging.slice(0, 3).map(c => c.name).join(', ')}. Opportunité de développement et upsell.`,
      action: 'Plan de montée en gamme',
      priority: 'medium'
    });
  }

  // Si aucune recommandation spécifique, message par défaut
  if (recommendations.length === 0) {
    recommendations.push({
      title: 'Portfolio Stable',
      text: 'Aucune action urgente requise. Maintenir le suivi régulier des clients existants.',
      action: 'Suivi de routine',
      priority: 'low'
    });
  }

  const grid = document.getElementById('recommendationsGrid');
  grid.innerHTML = recommendations.map(rec => `
    <div class="action-card ${rec.priority}">
      <h4>${rec.title}</h4>
      <p>${rec.text}</p>
      <span class="action-tag">${rec.action}</span>
    </div>
  `).join('');
}

// ============================================================================
// Additional Analysis
// ============================================================================
function renderAnalysis() {
  const totalRevenue = processedData.reduce((sum, c) => sum + c.totalRevenue, 0);
  const top3Revenue = processedData.slice(0, 3).reduce((sum, c) => sum + c.totalRevenue, 0);
  const concentration = (top3Revenue / totalRevenue * 100).toFixed(1);

  const avgGrowth = processedData.reduce((sum, c) => sum + c.trend, 0) / processedData.length;

  const highGrowth = processedData.filter(c => c.trend > 50);

  const avgTicket = totalRevenue / processedData.reduce((sum, c) => sum + c.dealCount, 0);
  const bigDeals = processedData.filter(c => (c.totalRevenue / c.dealCount) > avgTicket * 2);

  const analyses = [
    {
      title: 'Concentration du CA',
      text: `Les 3 premiers clients représentent ${concentration}% du CA total. ${concentration > 50 ? 'RISQUE ÉLEVÉ de dépendance.' : 'Diversification satisfaisante.'}`,
      action: concentration > 50 ? 'Diversifier le portefeuille' : 'Maintenir l\'équilibre',
      priority: concentration > 50 ? 'high' : 'low'
    },
    {
      title: 'Tendance Globale',
      text: `Croissance moyenne du portefeuille: ${avgGrowth.toFixed(1)}%. ${avgGrowth > 20 ? 'Excellente dynamique.' : avgGrowth > 0 ? 'Croissance modérée.' : 'Portefeuille en déclin.'}`,
      action: avgGrowth > 0 ? 'Capitaliser sur la croissance' : 'Plan de redressement',
      priority: avgGrowth < 0 ? 'high' : 'medium'
    },
    {
      title: 'Clients Haute Croissance',
      text: `${highGrowth.length} clients en forte croissance (>50%). ${highGrowth.length > 0 ? 'Opportunités: ' + highGrowth.slice(0, 3).map(c => c.name).join(', ') + '.' : 'Focus sur la stabilisation.'}`,
      action: 'Programme d\'accélération',
      priority: 'medium'
    },
    {
      title: 'Gros Contrats',
      text: `${bigDeals.length} clients avec ticket moyen supérieur au double de la moyenne (${formatCurrency(avgTicket)}). ${bigDeals.length > 0 ? 'Focus: ' + bigDeals.slice(0, 3).map(c => c.name).join(', ') : 'Opportunité d\'augmenter la taille des deals'}.`,
      action: 'Stratégie grands comptes',
      priority: 'medium'
    }
  ];

  const grid = document.getElementById('analysisGrid');
  grid.innerHTML = analyses.map(analysis => `
    <div class="action-card ${analysis.priority}">
      <h4>${analysis.title}</h4>
      <p>${analysis.text}</p>
      <span class="action-tag">${analysis.action}</span>
    </div>
  `).join('');
}

// ============================================================================
// Filter Initialization
// ============================================================================
function initFilters() {
  const filterButtons = document.querySelectorAll('.filter-btn');

  filterButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      const filterType = this.dataset.filterType;
      const filterValue = this.dataset.filter;

      // Update active states for this filter type
      document.querySelectorAll(`[data-filter-type="${filterType}"]`).forEach(b => {
        b.classList.remove('active');
      });
      this.classList.add('active');

      // Update filter state
      currentFilters[filterType] = filterValue;

      // Re-render table with new filters
      renderSegmentationTable();

      // Gérer affichage/masquage colonnes années
      if (filterType === 'year') {
        const allYearCols = document.querySelectorAll('.year-col');
        const globalTrendCol = document.querySelectorAll('.global-trend-col');

        if (filterValue === 'all') {
          // Mode "toutes" : afficher toutes les années + tendance globale
          allYearCols.forEach(col => col.style.display = '');
          globalTrendCol.forEach(col => col.style.display = '');
        } else {
          // Mode année spécifique : afficher que cette année, masquer tendance
          allYearCols.forEach(col => {
            if (col.classList.contains(`year-${filterValue}`)) {
              col.style.display = '';
            } else {
              col.style.display = 'none';
            }
          });
          globalTrendCol.forEach(col => col.style.display = 'none');
        }
      }
    });
  });

  // Table sorting
  const tableHeaders = document.querySelectorAll('#segmentationTable th[data-sort]');
  tableHeaders.forEach(th => {
    th.addEventListener('click', function() {
      const column = this.dataset.sort;

      if (sortColumn === column) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        sortColumn = column;
        sortDirection = 'desc';
      }

      // Update header indicators
      tableHeaders.forEach(h => {
        h.innerHTML = h.textContent.replace(' ↑', '').replace(' ↓', '');
      });
      this.innerHTML = this.textContent.replace(' ↑', '').replace(' ↓', '') + (sortDirection === 'asc' ? ' ↑' : ' ↓');

      renderSegmentationTable();
    });

    // Add hover effect
    th.style.cursor = 'pointer';
  });
}

// ============================================================================
// Info Panel Functions
// ============================================================================
function openInfoPanel(title, content) {
  document.getElementById('infoPanelTitle').textContent = title;
  document.getElementById('infoPanelContent').innerHTML = content;
  document.getElementById('infoPanel').classList.add('show');
  document.getElementById('infoPanelOverlay').classList.add('show');
}

function closeInfoPanel() {
  document.getElementById('infoPanel').classList.remove('show');
  document.getElementById('infoPanelOverlay').classList.remove('show');
}

// ============================================================================
// Methodology Details
// ============================================================================
function showMethodologyDetails(type) {
  let title = '';
  let content = '';

  switch(type) {
    case 'score':
      title = 'Calcul du Score Client (0-100)';
      content = `
        <div style="color: var(--text); line-height: 1.8;">
          <p style="margin-bottom: 16px;">
            Le <strong>Score Client</strong> est une note sur 100 qui évalue la valeur et le potentiel d'un client.
            Il se calcule selon 4 critères pondérés :
          </p>

          <div style="background: rgba(99, 102, 241, 0.1); padding: 16px; border-radius: 10px; margin: 20px 0; border-left: 4px solid var(--accent);">
            <div style="font-weight: 700; color: var(--accent); margin-bottom: 12px; font-size: 16px;">
              Répartition des Points
            </div>

            <div style="margin-bottom: 12px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <span style="font-weight: 600;">1. Chiffre d'Affaires Total</span>
                <span style="color: var(--accent); font-weight: 700;">40 points max</span>
              </div>
              <div style="font-size: 13px; color: var(--text-muted); margin-left: 12px;">
                • 1 point par tranche de 2 500€ de CA<br>
                • Plafonné à 40 points (atteint à 100 000€)
              </div>
            </div>

            <div style="margin-bottom: 12px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <span style="font-weight: 600;">2. Tendance d'Évolution</span>
                <span style="color: var(--green); font-weight: 700;">30 points max</span>
              </div>
              <div style="font-size: 13px; color: var(--text-muted); margin-left: 12px;">
                • +30 pts : Croissance > +50%<br>
                • +20 pts : Croissance entre +20% et +50%<br>
                • +10 pts : Croissance entre 0% et +20%<br>
                • -10 pts : Décroissance > -20%
              </div>
            </div>

            <div style="margin-bottom: 12px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <span style="font-weight: 600;">3. Récence d'Activité</span>
                <span style="color: var(--blue); font-weight: 700;">20 points max</span>
              </div>
              <div style="font-size: 13px; color: var(--text-muted); margin-left: 12px;">
                • +20 pts : Dernier deal < 6 mois<br>
                • +10 pts : Dernier deal entre 6 et 12 mois<br>
                • 0 pt : Dernier deal > 12 mois
              </div>
            </div>

            <div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <span style="font-weight: 600;">4. Nombre de Deals</span>
                <span style="color: var(--purple); font-weight: 700;">10 points max</span>
              </div>
              <div style="font-size: 13px; color: var(--text-muted); margin-left: 12px;">
                • 2 points par deal<br>
                • Plafonné à 10 points (5+ deals)
              </div>
            </div>
          </div>

          <div style="background: rgba(34, 197, 94, 0.1); padding: 12px; border-radius: 8px; margin-top: 16px;">
            <div style="font-size: 13px; color: var(--text);">
              <strong>Exemple :</strong> Un client avec 80 000€ de CA (+32 pts), en croissance de +35% (+20 pts),
              deal récent il y a 4 mois (+20 pts), et 3 deals (+6 pts) = <strong>78/100</strong>
            </div>
          </div>
        </div>
      `;
      break;

    case 'tendance':
      title = 'Calcul de la Tendance d\'Activité';
      content = `
        <div style="color: var(--text); line-height: 1.8;">
          <p style="margin-bottom: 16px;">
            La <strong>Tendance</strong> mesure l'évolution de l'activité d'un client sur la période 2022-2025.
            Elle est exprimée en <strong>pourcentage (%)</strong>.
          </p>

          <div style="background: rgba(99, 102, 241, 0.1); padding: 16px; border-radius: 10px; margin: 20px 0; border-left: 4px solid var(--accent);">
            <div style="font-weight: 700; color: var(--accent); margin-bottom: 12px; font-size: 16px;">
              Méthode de Calcul
            </div>

            <div style="margin-bottom: 16px;">
              <div style="font-weight: 600; margin-bottom: 8px;">1️⃣ Identification des années actives</div>
              <div style="font-size: 13px; color: var(--text-muted); margin-left: 12px;">
                On identifie les années où le client a généré du CA (> 0€).
              </div>
            </div>

            <div style="margin-bottom: 16px;">
              <div style="font-weight: 600; margin-bottom: 8px;">2️⃣ Comparaison des 2 dernières années actives</div>
              <div style="font-size: 13px; color: var(--text-muted); margin-left: 12px;">
                On calcule la croissance entre les 2 dernières années où le client était actif.<br>
                <code style="background: var(--bg); padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                  Croissance = ((Dernière année - Année précédente) / Année précédente) × 100
                </code>
              </div>
            </div>

            <div style="margin-bottom: 16px;">
              <div style="font-weight: 600; margin-bottom: 8px;">3️⃣ Ajustement temporel</div>
              <div style="font-size: 13px; color: var(--text-muted); margin-left: 12px;">
                Si les années ne sont pas consécutives, la croissance est divisée par le nombre d'années d'écart.<br>
                <em>Exemple : +100% sur 2 ans = +50% de tendance annuelle</em>
              </div>
            </div>

            <div>
              <div style="font-weight: 600; margin-bottom: 8px;">4️⃣ Bonus de récence</div>
              <div style="font-size: 13px; color: var(--text-muted); margin-left: 12px;">
                • <strong>×1.2</strong> si dernière activité en 2024-2025 (client actif récemment)<br>
                • <strong>×0.8</strong> si dernière activité en 2022-2023 (client moins actif)
              </div>
            </div>
          </div>

          <div style="margin-top: 20px;">
            <div style="font-weight: 700; color: var(--accent); margin-bottom: 12px;">Interprétation</div>

            <div style="display: flex; align-items: center; margin-bottom: 8px;">
              <span style="color: var(--green); font-size: 20px; margin-right: 8px;">↗</span>
              <div>
                <strong style="color: var(--green);">Tendance Positive (> +10%)</strong><br>
                <span style="font-size: 13px; color: var(--text-muted);">Client en croissance, opportunités de développement</span>
              </div>
            </div>

            <div style="display: flex; align-items: center; margin-bottom: 8px;">
              <span style="color: var(--text-muted); font-size: 20px; margin-right: 8px;">→</span>
              <div>
                <strong>Tendance Stable (-10% à +10%)</strong><br>
                <span style="font-size: 13px; color: var(--text-muted);">Activité constante, relation à maintenir</span>
              </div>
            </div>

            <div style="display: flex; align-items: center;">
              <span style="color: var(--red); font-size: 20px; margin-right: 8px;">↘</span>
              <div>
                <strong style="color: var(--red);">Tendance Négative (< -10%)</strong><br>
                <span style="font-size: 13px; color: var(--text-muted);">Client en déclin, action corrective nécessaire</span>
              </div>
            </div>
          </div>

          <div style="background: rgba(34, 197, 94, 0.1); padding: 12px; border-radius: 8px; margin-top: 16px;">
            <div style="font-size: 13px; color: var(--text);">
              <strong>Exemple :</strong> Client avec 50 000€ en 2022, 0€ en 2023, 80 000€ en 2024<br>
              → Croissance brute = +60% sur 2 ans = +30%/an × 1.2 (récent) = <strong>+36%</strong>
            </div>
          </div>
        </div>
      `;
      break;

    case 'segments':
      title = '🏷️ Segments Clients - Définitions';
      content = `
        <div style="color: var(--text); line-height: 1.8;">
          <p style="margin-bottom: 20px;">
            Les clients sont automatiquement classés en <strong>5 segments</strong> selon leur CA moyen annuel et leur tendance d'évolution.
          </p>

          <div style="margin-bottom: 20px; padding: 16px; background: rgba(168, 85, 247, 0.1); border-radius: 10px; border-left: 4px solid var(--purple);">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
              <span class="badge stratégique" style="font-size: 14px;">Stratégique</span>
              <span style="color: var(--purple); font-weight: 700;">Priorité Maximum</span>
            </div>
            <div style="font-size: 14px; margin-bottom: 8px;"><strong>Critères :</strong></div>
            <div style="font-size: 13px; color: var(--text-muted); margin-left: 12px;">
              • CA moyen annuel > 100 000€<br>
              • Tendance positive (croissance > 0%)<br>
            </div>
            <div style="font-size: 14px; margin-top: 12px;"><strong>Actions recommandées :</strong></div>
            <div style="font-size: 13px; color: var(--text); margin-left: 12px;">
              • Revue trimestrielle obligatoire<br>
              • Opportunités de montée en gamme<br>
              • Programme VIP / Relation privilégiée
            </div>
          </div>

          <div style="margin-bottom: 20px; padding: 16px; background: rgba(34, 197, 94, 0.1); border-radius: 10px; border-left: 4px solid var(--green);">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
              <span class="badge clé" style="font-size: 14px;">Clé</span>
              <span style="color: var(--green); font-weight: 700;">Forte Valeur</span>
            </div>
            <div style="font-size: 14px; margin-bottom: 8px;"><strong>Critères :</strong></div>
            <div style="font-size: 13px; color: var(--text-muted); margin-left: 12px;">
              • CA moyen annuel > 50 000€<br>
              • Tendance stable ou légèrement négative (≥ -10%)<br>
            </div>
            <div style="font-size: 14px; margin-top: 12px;"><strong>Actions recommandées :</strong></div>
            <div style="font-size: 13px; color: var(--text); margin-left: 12px;">
              • Suivi régulier (mensuel/bimensuel)<br>
              • Opportunités de vente croisée<br>
              • Fidélisation et développement
            </div>
          </div>

          <div style="margin-bottom: 20px; padding: 16px; background: rgba(59, 130, 246, 0.1); border-radius: 10px; border-left: 4px solid var(--blue);">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
              <span class="badge régulier" style="font-size: 14px;">Régulier</span>
              <span style="color: var(--blue); font-weight: 700;">Socle Stable</span>
            </div>
            <div style="font-size: 14px; margin-bottom: 8px;"><strong>Critères :</strong></div>
            <div style="font-size: 13px; color: var(--text-muted); margin-left: 12px;">
              • CA moyen annuel > 10 000€<br>
              • Ne rentre dans aucune autre catégorie<br>
            </div>
            <div style="font-size: 14px; margin-top: 12px;"><strong>Actions recommandées :</strong></div>
            <div style="font-size: 13px; color: var(--text); margin-left: 12px;">
              • Maintenir la relation<br>
              • Contacts trimestriels<br>
              • Identifier opportunités d'upsell
            </div>
          </div>

          <div style="margin-bottom: 20px; padding: 16px; background: rgba(245, 158, 11, 0.1); border-radius: 10px; border-left: 4px solid var(--orange);">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
              <span class="badge à-risque" style="font-size: 14px;">À Risque</span>
              <span style="color: var(--orange); font-weight: 700;">⚠️ Action Urgente</span>
            </div>
            <div style="font-size: 14px; margin-bottom: 8px;"><strong>Critères :</strong></div>
            <div style="font-size: 13px; color: var(--text-muted); margin-left: 12px;">
              • Tendance fortement négative (< -20%)<br>
              • Peu importe le CA<br>
            </div>
            <div style="font-size: 14px; margin-top: 12px;"><strong>Actions recommandées :</strong></div>
            <div style="font-size: 13px; color: var(--text); margin-left: 12px;">
              • <strong>Plan de rétention immédiat</strong><br>
              • Identifier les causes de la baisse<br>
              • Rendez-vous prioritaire avec décideur
            </div>
          </div>

          <div style="padding: 16px; background: rgba(239, 68, 68, 0.1); border-radius: 10px; border-left: 4px solid var(--red);">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
              <span class="badge dormant" style="font-size: 14px;">Dormant</span>
              <span style="color: var(--red); font-weight: 700;">Inactif</span>
            </div>
            <div style="font-size: 14px; margin-bottom: 8px;"><strong>Critères :</strong></div>
            <div style="font-size: 13px; color: var(--text-muted); margin-left: 12px;">
              • Aucune activité en 2023 ET 2024<br>
              • Client historique inactif<br>
            </div>
            <div style="font-size: 14px; margin-top: 12px;"><strong>Actions recommandées :</strong></div>
            <div style="font-size: 13px; color: var(--text); margin-left: 12px;">
              • Campagne de réactivation ciblée<br>
              • Enquête de satisfaction / feedback<br>
              • Offre de reconquête
            </div>
          </div>
        </div>
      `;
      break;

    case 'priorites':
      title = 'Niveaux de Priorité';
      content = `
        <div style="color: var(--text); line-height: 1.8;">
          <p style="margin-bottom: 20px;">
            Les <strong>niveaux de priorité</strong> sont déterminés automatiquement en fonction du <strong>Score Client</strong>.
            Ils permettent de prioriser vos actions et votre temps.
          </p>

          <div style="margin-bottom: 20px; padding: 20px; background: rgba(239, 68, 68, 0.1); border-radius: 10px; border-left: 4px solid var(--red);">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <span style="font-size: 24px;">🔴</span>
              <div>
                <div style="font-weight: 700; font-size: 16px; color: var(--red);">HAUTE PRIORITÉ</div>
                <div style="font-size: 13px; color: var(--text-muted);">Score > 70/100</div>
              </div>
            </div>
            <div style="font-size: 14px; margin-top: 12px;">
              <strong>Qui :</strong> Clients stratégiques à forte valeur et fort potentiel<br>
              <strong>Action :</strong> Dédier 60-70% de votre temps à ces clients<br>
              <strong>Fréquence :</strong> Contact hebdomadaire ou bimensuel
            </div>
          </div>

          <div style="margin-bottom: 20px; padding: 20px; background: rgba(245, 158, 11, 0.1); border-radius: 10px; border-left: 4px solid var(--orange);">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <span style="font-size: 24px;">🟠</span>
              <div>
                <div style="font-weight: 700; font-size: 16px; color: var(--orange);">PRIORITÉ MOYENNE</div>
                <div style="font-size: 13px; color: var(--text-muted);">Score entre 40 et 70/100</div>
              </div>
            </div>
            <div style="font-size: 14px; margin-top: 12px;">
              <strong>Qui :</strong> Clients avec potentiel de développement<br>
              <strong>Action :</strong> 20-30% de votre temps, opportunités d'upsell<br>
              <strong>Fréquence :</strong> Contact mensuel ou trimestriel
            </div>
          </div>

          <div style="padding: 20px; background: rgba(59, 130, 246, 0.1); border-radius: 10px; border-left: 4px solid var(--blue);">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <span style="font-size: 24px;">🔵</span>
              <div>
                <div style="font-weight: 700; font-size: 16px; color: var(--blue);">PRIORITÉ BASSE</div>
                <div style="font-size: 13px; color: var(--text-muted);">Score < 40/100</div>
              </div>
            </div>
            <div style="font-size: 14px; margin-top: 12px;">
              <strong>Qui :</strong> Petits comptes ou clients en perte de vitesse<br>
              <strong>Action :</strong> 10% de votre temps, maintien de la relation<br>
              <strong>Fréquence :</strong> Contact trimestriel ou semestriel
            </div>
          </div>

          <div style="background: rgba(99, 102, 241, 0.1); padding: 16px; border-radius: 8px; margin-top: 20px;">
            <div style="font-size: 13px; color: var(--text);">
              <strong>💡 Astuce :</strong> Utilisez le filtre par année pour affiner votre priorité selon l'activité récente.
              Un client Haute Priorité globalement mais inactif en 2024 mérite une attention particulière (réactivation).
            </div>
          </div>
        </div>
      `;
      break;

    case 'recommandations':
      title = '💡 Actions Recommandées';
      content = `
        <div style="color: var(--text); line-height: 1.8;">
          <p style="margin-bottom: 20px;">
            Pour chaque client, le dashboard génère automatiquement une <strong>recommandation d'action</strong>
            basée sur son segment. Voici le détail de chaque recommandation :
          </p>

          <div style="margin-bottom: 16px; padding: 14px; background: var(--bg-card); border-radius: 8px; border-left: 3px solid var(--purple);">
            <div style="font-weight: 700; margin-bottom: 6px; color: var(--purple);">
              📅 Revue trimestrielle + Montée en gamme
            </div>
            <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">
              <strong>Pour :</strong> Clients Stratégiques
            </div>
            <div style="font-size: 14px;">
              • Organiser un point stratégique tous les 3 mois<br>
              • Présenter des solutions premium ou services additionnels<br>
              • Anticiper les besoins futurs et projets à venir<br>
              • Renforcer la relation avec les décideurs clés
            </div>
          </div>

          <div style="margin-bottom: 16px; padding: 14px; background: var(--bg-card); border-radius: 8px; border-left: 3px solid var(--green);">
            <div style="font-weight: 700; margin-bottom: 6px; color: var(--green);">
              🤝 Suivi régulier + Vente croisée
            </div>
            <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">
              <strong>Pour :</strong> Clients Clés
            </div>
            <div style="font-size: 14px;">
              • Maintenir un contact mensuel ou bimensuel<br>
              • Identifier les opportunités de cross-sell<br>
              • Proposer des produits/services complémentaires<br>
              • S'assurer de la satisfaction continue
            </div>
          </div>

          <div style="margin-bottom: 16px; padding: 14px; background: var(--bg-card); border-radius: 8px; border-left: 3px solid var(--orange);">
            <div style="font-weight: 700; margin-bottom: 6px; color: var(--orange);">
              🚨 URGENT : Plan de rétention
            </div>
            <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">
              <strong>Pour :</strong> Clients À Risque
            </div>
            <div style="font-size: 14px;">
              • <strong>Contact immédiat</strong> avec le décideur<br>
              • Enquête de satisfaction pour identifier les problèmes<br>
              • Proposer des solutions correctives rapides<br>
              • Offre de fidélisation si nécessaire<br>
              • Escalade interne si menace de churn
            </div>
          </div>

          <div style="margin-bottom: 16px; padding: 14px; background: var(--bg-card); border-radius: 8px; border-left: 3px solid var(--red);">
            <div style="font-weight: 700; margin-bottom: 6px; color: var(--red);">
              🔄 Campagne de réactivation
            </div>
            <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">
              <strong>Pour :</strong> Clients Dormants
            </div>
            <div style="font-size: 14px;">
              • Email ou appel de reconquête personnalisé<br>
              • Enquête : pourquoi ont-ils arrêté ?<br>
              • Offre spéciale de retour (promotion, essai gratuit)<br>
              • Présenter les nouveautés depuis leur départ
            </div>
          </div>

          <div style="padding: 14px; background: var(--bg-card); border-radius: 8px; border-left: 3px solid var(--blue);">
            <div style="font-weight: 700; margin-bottom: 6px; color: var(--blue);">
              ✅ Maintenir la relation
            </div>
            <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">
              <strong>Pour :</strong> Clients Réguliers
            </div>
            <div style="font-size: 14px;">
              • Contact trimestriel pour garder le lien<br>
              • Newsletter, invitations événements<br>
              • Rester disponible pour futurs besoins<br>
              • Identifier opportunités d'évolution vers segment supérieur
            </div>
          </div>

          <div style="background: rgba(99, 102, 241, 0.1); padding: 16px; border-radius: 8px; margin-top: 20px;">
            <div style="font-size: 13px; color: var(--text);">
              <strong>⚙️ Automatisation :</strong> Ces recommandations peuvent servir de base pour créer des workflows
              automatisés dans votre CRM (rappels, emails, tâches).
            </div>
          </div>
        </div>
      `;
      break;

    case 'kpis':
      title = 'KPIs Principaux - Définitions';
      content = `
        <div style="color: var(--text); line-height: 1.8;">
          <p style="margin-bottom: 20px;">
            Les <strong>6 KPIs principaux</strong> affichés en haut du dashboard vous donnent une vue d'ensemble instantanée
            de votre portefeuille clients. Voici leur définition :
          </p>

          <div style="margin-bottom: 16px; padding: 14px; background: var(--bg-card); border-radius: 8px;">
            <div style="font-weight: 700; margin-bottom: 6px; font-size: 15px;">
              💰 CA Total
            </div>
            <div style="font-size: 14px; color: var(--text-muted);">
              <strong>Définition :</strong> Somme de tous les deals "Fermé gagné" sur la période 2022-2025<br>
              <strong>Usage :</strong> Vision globale de la performance commerciale<br>
              <strong>Cliquez dessus</strong> pour voir la répartition par année
            </div>
          </div>

          <div style="margin-bottom: 16px; padding: 14px; background: var(--bg-card); border-radius: 8px;">
            <div style="font-weight: 700; margin-bottom: 6px; font-size: 15px;">
              CA 2024
            </div>
            <div style="font-size: 14px; color: var(--text-muted);">
              <strong>Définition :</strong> Total des deals fermés en 2024 avec % de croissance vs 2023<br>
              <strong>Usage :</strong> Mesurer la performance de l'année en cours<br>
              <strong>Cliquez dessus</strong> pour voir le top 5 clients 2024
            </div>
          </div>

          <div style="margin-bottom: 16px; padding: 14px; background: var(--bg-card); border-radius: 8px;">
            <div style="font-weight: 700; margin-bottom: 6px; font-size: 15px;">
              👥 Nombre de Clients
            </div>
            <div style="font-size: 14px; color: var(--text-muted);">
              <strong>Définition :</strong> Nombre d'entreprises uniques ayant au moins 1 deal fermé gagné<br>
              <strong>Usage :</strong> Taille et diversification du portefeuille<br>
              <strong>Cliquez dessus</strong> pour voir la répartition par segment
            </div>
          </div>

          <div style="margin-bottom: 16px; padding: 14px; background: var(--bg-card); border-radius: 8px;">
            <div style="font-weight: 700; margin-bottom: 6px; font-size: 15px;">
              Ticket Moyen
            </div>
            <div style="font-size: 14px; color: var(--text-muted);">
              <strong>Définition :</strong> CA Total ÷ Nombre total de deals<br>
              <strong>Formule :</strong> Montant moyen d'une transaction<br>
              <strong>Usage :</strong> Évaluer la taille moyenne de vos contrats<br>
              <strong>Cliquez dessus</strong> pour voir l'évolution par année
            </div>
          </div>

          <div style="margin-bottom: 16px; padding: 14px; background: var(--bg-card); border-radius: 8px;">
            <div style="font-weight: 700; margin-bottom: 6px; font-size: 15px; color: var(--purple);">
              ⭐ Clients Stratégiques
            </div>
            <div style="font-size: 14px; color: var(--text-muted);">
              <strong>Définition :</strong> Nombre de clients avec segment "Stratégique"<br>
              <strong>Critère :</strong> CA annuel moyen > 100 000€ + croissance positive<br>
              <strong>Usage :</strong> Identifier vos champions à chouchouter<br>
              <strong>Cliquez dessus</strong> pour voir la liste complète
            </div>
          </div>

          <div style="padding: 14px; background: var(--bg-card); border-radius: 8px;">
            <div style="font-weight: 700; margin-bottom: 6px; font-size: 15px; color: var(--orange);">
              ⚠️ Clients à Risque
            </div>
            <div style="font-size: 14px; color: var(--text-muted);">
              <strong>Définition :</strong> Nombre de clients avec segment "À Risque"<br>
              <strong>Critère :</strong> Tendance < -20% (forte baisse d'activité)<br>
              <strong>Usage :</strong> Alertes pour actions urgentes de rétention<br>
              <strong>Cliquez dessus</strong> pour voir qui contacter en priorité
            </div>
          </div>

          <div style="background: rgba(34, 197, 94, 0.1); padding: 16px; border-radius: 8px; margin-top: 20px;">
            <div style="font-size: 13px; color: var(--text);">
              <strong>💡 Astuce :</strong> Tous les KPIs sont cliquables ! Cliquez dessus pour obtenir des détails
              et des analyses approfondies de chaque métrique.
            </div>
          </div>
        </div>
      `;
      break;
  }

  openInfoPanel(title, content);
}

// ============================================================================
// Helpers
// ============================================================================
function formatCurrency(value, short = false) {
  if (short && value >= 1000000) {
    return (value / 1000000).toFixed(1) + 'M€';
  }
  if (short && value >= 1000) {
    return (value / 1000).toFixed(0) + 'k€';
  }
  return new Intl.NumberFormat('fr-FR', {
    style: 'currency',
    currency: 'EUR',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0
  }).format(value);
}

function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
  const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
  return {
    x: centerX + (radius * Math.cos(angleInRadians)),
    y: centerY + (radius * Math.sin(angleInRadians))
  };
}

function describeArc(x, y, radius, innerRadius, startAngle, endAngle) {
  const start = polarToCartesian(x, y, radius, endAngle);
  const end = polarToCartesian(x, y, radius, startAngle);
  const innerStart = polarToCartesian(x, y, innerRadius, endAngle);
  const innerEnd = polarToCartesian(x, y, innerRadius, startAngle);

  const largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";

  const d = [
    "M", start.x, start.y,
    "A", radius, radius, 0, largeArcFlag, 0, end.x, end.y,
    "L", innerEnd.x, innerEnd.y,
    "A", innerRadius, innerRadius, 0, largeArcFlag, 1, innerStart.x, innerStart.y,
    "Z"
  ].join(" ");

  return d;
}
</script>
</body>
</html>
