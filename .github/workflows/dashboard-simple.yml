name: üéØ Dashboard Simple (Dev + QA)

# Workflow ultra-simple : Dev impl√©mente, QA teste
# Tourne toutes les 15 min (fr√©quence max sans conflit)

on:
  schedule:
    - cron: '*/15 * * * *'  # Toutes les 15 minutes
  workflow_dispatch:  # Manuel
  push:
    branches: [main]

permissions:
  contents: write
  actions: read

concurrency:
  group: dashboard-simple
  cancel-in-progress: true  # Annule les runs en cours si nouveau lanc√©

jobs:
  dev-and-qa:
    name: üîß Dev ‚Üí QA
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Agent Dev (Impl√©mente)
        run: |
          echo "üîß AGENT DEV - Impl√©mentation des t√¢ches"
          chmod +x .github/scripts/autonomous-agents/agent-dev.js
          node .github/scripts/autonomous-agents/agent-dev.js

      - name: Agent QA (Teste)
        run: |
          echo "‚úÖ AGENT QA - Tests du dashboard"
          chmod +x .github/scripts/autonomous-agents/agent-qa.js
          node .github/scripts/autonomous-agents/agent-qa.js

      - name: Commit changements
        run: |
          git config user.name "Dashboard Bot"
          git config user.email "noreply@dashboard.bot"

          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "$(cat <<'EOF'
          fix: Agent Dev - Impl√©mentation automatique [skip ci]

          T√¢ches trait√©es par Agent Dev
          Score QA g√©n√©r√© par Agent QA

          ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

          Co-Authored-By: Claude <noreply@anthropic.com>
          EOF
          )"

            # Pull avec rebase pour √©viter conflits
            git pull --rebase origin main || {
              echo "Conflit d√©tect√©, r√©solution..."
              git rebase --abort
              git pull --no-rebase origin main
              git add -A
              git commit --amend --no-edit
            }

            git push origin main
            echo "Changements push√©s"
          else
            echo "Pas de changements"
          fi

      - name: Upload rapports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dashboard-reports
          path: |
            RAPPORT-AGENT-DEV.md
            RAPPORT-AGENT-QA.md
            .github/agents-communication/

  summary:
    name: üìä R√©sum√©
    runs-on: ubuntu-latest
    needs: dev-and-qa
    if: always()

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download rapports
        uses: actions/download-artifact@v4
        with:
          name: dashboard-reports

      - name: Generate Summary
        run: |
          echo "# üìä DASHBOARD SIMPLE - R√©sum√©"
          echo ""
          echo "**Date**: $(date +"%Y-%m-%d %H:%M:%S")"
          echo "**Run**: #${{ github.run_number }}"
          echo ""

          if [ -f RAPPORT-AGENT-QA.md ]; then
            SCORE=$(grep "Score" RAPPORT-AGENT-QA.md | grep -o '[0-9]\+' | head -1)
            echo "**Score QA**: $SCORE/100"

            if [ "$SCORE" -lt 70 ]; then
              echo "‚ö†Ô∏è  **ALERTE**: Score bas, intervention peut-√™tre n√©cessaire"
            fi
          fi

          echo ""
          echo "---"
          echo "üéØ Dashboard HubSpot - Mode Simple"
