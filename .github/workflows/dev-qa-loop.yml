name: ğŸ”„ Boucle Dev â†’ QA â†’ Debug

# Boucle vertueuse pour amÃ©liorer continuellement le dashboard
# Toutes les heures: Dev fixe bugs â†’ QA teste â†’ Debugger corrige â†’ Repeat

on:
  schedule:
    # Toutes les heures
    - cron: '0 * * * *'
  workflow_dispatch:  # Manuel
  push:
    branches: [main]
    paths:
      - 'public/index.html'
      - 'CORRECTIONS-IMMEDIATES.md'
      - 'CAHIER-DES-CHARGES.md'

permissions:
  contents: write
  issues: write
  actions: read

jobs:
  # Ã‰TAPE 1: Agent Dev fixe les bugs
  dev:
    name: ğŸ”§ Agent Dev
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run Agent Dev
        run: |
          echo "ğŸ”§ AGENT DEV - Fixing bugs..."
          chmod +x .github/scripts/autonomous-agents/agent-dev.js
          node .github/scripts/autonomous-agents/agent-dev.js

      - name: Upload rapport Dev
        uses: actions/upload-artifact@v4
        with:
          name: rapport-dev
          path: RAPPORT-AGENT-DEV.md

      - name: Commit fixes if any
        run: |
          git config user.name "Agent Dev Bot"
          git config user.email "noreply@dev.bot"

          if [ -n "$(git status --porcelain)" ]; then
            git add public/index.html RAPPORT-AGENT-DEV.md
            git commit -m "fix: Agent Dev - Bugs fixed automatically [skip ci]

            ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

            Co-Authored-By: Claude <noreply@anthropic.com>"
            git push origin main
            echo "âœ… Fixes committed"
          else
            echo "â„¹ï¸  No bugs to fix"
          fi

  # Ã‰TAPE 2: Agent QA teste le dashboard
  qa:
    name: âœ… Agent QA
    runs-on: ubuntu-latest
    needs: dev

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run Agent QA
        run: |
          echo "âœ… AGENT QA - Testing dashboard..."
          chmod +x .github/scripts/autonomous-agents/agent-qa.js
          node .github/scripts/autonomous-agents/agent-qa.js

      - name: Upload rapport QA
        uses: actions/upload-artifact@v4
        with:
          name: rapport-qa
          path: RAPPORT-AGENT-QA.md

      - name: Check QA score
        id: qa_score
        run: |
          SCORE=$(grep "Score" RAPPORT-AGENT-QA.md | grep -o '[0-9]\+' | head -1)
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "ğŸ“Š QA Score: $SCORE/100"

          if [ "$SCORE" -ge 90 ]; then
            echo "âœ… EXCELLENT - Dashboard ready"
          elif [ "$SCORE" -ge 70 ]; then
            echo "ğŸŸ¡ ACCEPTABLE - Minor issues"
          else
            echo "ğŸ”´ PROBLÃˆMES - Need debugging"
          fi

      - name: Commit rapport QA
        run: |
          git config user.name "Agent QA Bot"
          git config user.email "noreply@qa.bot"

          if [ -n "$(git status --porcelain)" ]; then
            git add RAPPORT-AGENT-QA.md
            git commit -m "docs: Agent QA - Test report (Score: ${{ steps.qa_score.outputs.score }}/100) [skip ci]

            ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

            Co-Authored-By: Claude <noreply@anthropic.com>"
            git push origin main
          fi

  # Ã‰TAPE 3: Agent Debugger corrige les tests qui Ã©chouent
  debugger:
    name: ğŸ› Agent Debugger
    runs-on: ubuntu-latest
    needs: qa

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Download QA rapport
        uses: actions/download-artifact@v4
        with:
          name: rapport-qa

      - name: Run Agent Debugger
        run: |
          echo "ğŸ› AGENT DEBUGGER - Fixing failed tests..."
          chmod +x .github/scripts/autonomous-agents/agent-debugger.js
          node .github/scripts/autonomous-agents/agent-debugger.js

      - name: Commit debug fixes
        run: |
          git config user.name "Agent Debugger Bot"
          git config user.email "noreply@debugger.bot"

          if [ -n "$(git status --porcelain)" ]; then
            git add public/index.html RAPPORT-AGENT-DEBUGGER.md
            git commit -m "fix: Agent Debugger - Fixed failing tests [skip ci]

            ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

            Co-Authored-By: Claude <noreply@anthropic.com>"
            git push origin main
            echo "âœ… Debug fixes committed"
          else
            echo "â„¹ï¸  No fixes needed"
          fi

  # RÃ‰SUMÃ‰
  summary:
    name: ğŸ“Š RÃ©sumÃ©
    runs-on: ubuntu-latest
    needs: [dev, qa, debugger]
    if: always()

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all reports
        uses: actions/download-artifact@v4

      - name: Generate summary
        run: |
          echo "ğŸ“Š BOUCLE DEV â†’ QA â†’ DEBUG - RÃ‰SUMÃ‰"
          echo "======================================"
          echo ""
          echo "**Date**: $(date +"%Y-%m-%d %H:%M:%S")"
          echo ""
          echo "## Agents"
          echo ""
          echo "| Agent | Status |"
          echo "|-------|--------|"
          echo "| ğŸ”§ Dev | ${{ needs.dev.result }} |"
          echo "| âœ… QA | ${{ needs.qa.result }} |"
          echo "| ğŸ› Debugger | ${{ needs.debugger.result }} |"
          echo ""
          echo "## Prochaine ExÃ©cution"
          echo ""
          echo "â° Dans 1 heure (automatique)"
