name: Agent Chef AI-Powered

on:
  schedule:
    # Toutes les 3 heures - D√©cisions strat√©giques avec IA
    - cron: '0 */3 * * *'
  workflow_dispatch:  # Permet ex√©cution manuelle

jobs:
  chef-ai-decisions:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Create communication directory
        run: mkdir -p .github/agents-communication

      - name: Run Agent Chef AI
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ü§ñ Agent Chef de Projet - AI-Powered"
          echo "====================================="
          echo ""

          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "‚ö†Ô∏è  ANTHROPIC_API_KEY non configur√© - Mode fallback"
            echo "‚ÑπÔ∏è  Voir CONFIGURATION-IA.md pour activer l'IA r√©elle"
            echo ""
          else
            echo "‚úÖ Claude AI activ√© - D√©cisions intelligentes"
            echo ""
          fi

          node .github/scripts/autonomous-agents/agent-chef-ai.js

      - name: Commit decisions and task updates
        run: |
          git config --local user.email "agent-chef-ai@hubspot-dashboard.com"
          git config --local user.name "Agent Chef AI"

          git add .github/agents-communication/ RAPPORT-AGENT-CHEF-AI.md || true

          if git diff --staged --quiet; then
            echo "Aucune d√©cision n√©cessaire ce cycle"
          else
            git commit -m "ü§ñ AI Decisions: Agent Chef strategic planning

Decisions made by Agent Chef using Claude AI
- Evaluated pending recommendations
- Prioritized based on business impact
- Created tasks for approved items
- Applied intelligent context-aware decisions

Mode: $([ -z "$ANTHROPIC_API_KEY" ] && echo "Fallback (configure ANTHROPIC_API_KEY)" || echo "AI-Powered ‚úÖ")

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>"
            git push
            echo "‚úÖ D√©cisions committ√©es"
          fi
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Check for escalations
        run: |
          if [ -f ".github/agents-communication/user-escalations.json" ]; then
            echo "üìû V√©rification des escalations..."

            PENDING_COUNT=$(cat .github/agents-communication/user-escalations.json | grep -o '"status": "pending"' | wc -l)

            if [ "$PENDING_COUNT" -gt 0 ]; then
              echo ""
              echo "üî¥ ATTENTION: $PENDING_COUNT escalation(s) en attente"
              echo "Les agents ont besoin de votre aide!"
              echo ""
              echo "Voir: .github/agents-communication/user-escalations.json"
              echo ""
            fi
          fi

      - name: Generate workflow summary
        if: always()
        run: |
          echo "## ü§ñ Agent Chef AI - Rapport" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "**Mode**: ‚ö†Ô∏è Fallback (r√®gles simples)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚ÑπÔ∏è Configurer \`ANTHROPIC_API_KEY\` pour activer l'IA r√©elle" >> $GITHUB_STEP_SUMMARY
            echo "Voir: [CONFIGURATION-IA.md](../CONFIGURATION-IA.md)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Mode**: ‚úÖ AI-Powered (Claude)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "D√©cisions prises avec intelligence artificielle" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "RAPPORT-AGENT-CHEF-AI.md" ]; then
            echo "### üìä Rapport complet" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Voir: [RAPPORT-AGENT-CHEF-AI.md](../RAPPORT-AGENT-CHEF-AI.md)" >> $GITHUB_STEP_SUMMARY
          fi

          # Afficher escalations si pr√©sentes
          if [ -f ".github/agents-communication/user-escalations.json" ]; then
            PENDING_COUNT=$(cat .github/agents-communication/user-escalations.json | grep -o '"status": "pending"' | wc -l || echo "0")

            if [ "$PENDING_COUNT" -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### üî¥ Escalations" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "‚ö†Ô∏è **$PENDING_COUNT escalation(s)** en attente de votre action" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Les agents ont besoin de votre aide (permissions, API keys, d√©cisions)." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "D√©tails: \`.github/agents-communication/user-escalations.json\`" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Cycle termin√©" >> $GITHUB_STEP_SUMMARY
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
