name: üö¶ Agent Aiguilleur (Traffic Controller)

# Workflow de monitoring qui surveille les autres workflows
# et pr√©vient les conflits / boucles infinies
#
# Responsabilit√©s:
# - Monitorer l'√©tat des workflows
# - D√©tecter les conflits
# - Pr√©venir les boucles infinies
# - G√©n√©rer des alertes
# - Maintenir un rapport de sant√©

on:
  schedule:
    # Toutes les 15 minutes (monitoring TR√àS fr√©quent - c'est le traffic controller!)
    - cron: '*/15 * * * *'
  workflow_dispatch:  # Manuel
  # Note: Ne se d√©clenche PAS sur push pour √©viter de surcharger

permissions:
  contents: write  # Permet de commit et push les rapports
  issues: write    # Pour cr√©er des issues si n√©cessaire
  actions: read    # Pour lire l'√©tat des workflows

jobs:
  # JOB 1: MONITORING DES WORKFLOWS
  monitor:
    name: üö¶ Monitoring Workflows
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install GitHub CLI
        run: |
          # gh CLI est pr√©-install√© sur GitHub Actions
          gh --version

      - name: Configure GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "‚úÖ GitHub CLI configur√©"

      - name: Ex√©cuter Agent Aiguilleur AI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "üö¶ AGENT AIGUILLEUR AI-POWERED - D√©marrage"
          echo "================================================"
          echo ""

          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "‚ö†Ô∏è  ANTHROPIC_API_KEY non configur√© - Mode fallback"
            echo "‚ÑπÔ∏è  Voir CONFIGURATION-IA.md pour activer l'IA"
            echo ""
          else
            echo "‚úÖ Claude AI activ√© - Analyse intelligente"
            echo ""
          fi

          # Donner les permissions d'ex√©cution
          chmod +x .github/scripts/autonomous-agents/agent-aiguilleur-ai.js

          # Ex√©cuter l'agent AI
          node .github/scripts/autonomous-agents/agent-aiguilleur-ai.js

          echo ""
          echo "‚úÖ Agent Aiguilleur AI termin√©"

      - name: Upload rapport
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: traffic-controller-report
          path: RAPPORT-AGENT-AIGUILLEUR-AI.md

      - name: Commit rapport si chang√©
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          git config user.name "Traffic Controller AI Bot"
          git config user.email "noreply@traffic-controller.bot"

          if [ -n "$(git status --porcelain)" ]; then
            git add RAPPORT-AGENT-AIGUILLEUR-AI.md .github/agents-communication/
            git commit -m "docs: Rapport Agent Aiguilleur AI $([ -z "$ANTHROPIC_API_KEY" ] && echo "(fallback)" || echo "+ recommandations") [skip ci]

            ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

            Co-Authored-By: Claude <noreply@anthropic.com>"

            git push origin main || echo "‚ö†Ô∏è  Push √©chou√© - pas critique"

            echo "‚úÖ Rapport committ√©"
          else
            echo "‚ÑπÔ∏è  Pas de changement dans le rapport"
          fi

  # JOB 2: ALERTES SI PROBL√àMES CRITIQUES
  alert:
    name: üö® Alertes Critiques
    runs-on: ubuntu-latest
    needs: monitor
    if: always()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download rapport
        uses: actions/download-artifact@v4
        with:
          name: traffic-controller-report

      - name: V√©rifier score de sant√©
        run: |
          echo "üîç V√©rification score de sant√© des workflows"
          echo "================================================"

          if [ -f RAPPORT-AGENT-AIGUILLEUR.md ]; then
            # Extraire le score du rapport
            SCORE=$(grep "Score Global" RAPPORT-AGENT-AIGUILLEUR.md | grep -o '[0-9]\+' | head -1 || echo "100")

            echo "üìä Score de sant√©: $SCORE/100"

            if [ "$SCORE" -lt 50 ]; then
              echo ""
              echo "üî¥ ALERTE CRITIQUE: Score < 50"
              echo "   Action requise: V√©rifier imm√©diatement les workflows"
              echo "   Voir rapport d√©taill√©: RAPPORT-AGENT-AIGUILLEUR.md"
              echo ""
              echo "::error::Workflows en √©tat critique (score: $SCORE/100)"

            elif [ "$SCORE" -lt 70 ]; then
              echo ""
              echo "üü† AVERTISSEMENT: Score < 70"
              echo "   Action recommand√©e: Surveiller la situation"
              echo ""
              echo "::warning::Workflows en √©tat d√©grad√© (score: $SCORE/100)"

            else
              echo ""
              echo "‚úÖ √âtat normal - workflows en bonne sant√©"
            fi
          else
            echo "‚ö†Ô∏è  Rapport non trouv√©"
          fi

  # JOB 3: R√âSUM√â
  summary:
    name: üìä R√©sum√©
    runs-on: ubuntu-latest
    needs: [monitor, alert]
    if: always()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Afficher r√©sum√©
        run: |
          echo "üìä R√âSUM√â - AGENT AIGUILLEUR"
          echo "================================================"
          echo ""
          echo "**Date**: $(date +"%Y-%m-%d %H:%M:%S")"
          echo "**Run**: #${{ github.run_number }}"
          echo ""
          echo "## Jobs"
          echo ""
          echo "| Job | Status |"
          echo "|-----|--------|"
          echo "| Monitor | ${{ needs.monitor.result }} |"
          echo "| Alert | ${{ needs.alert.result }} |"
          echo ""
          echo "## Prochaine Ex√©cution"
          echo ""
          echo "‚è∞ Dans 1 heure (automatique)"
          echo ""
          echo "---"
          echo "üö¶ Agent Aiguilleur - Traffic Controller pour workflows GitHub Actions"
